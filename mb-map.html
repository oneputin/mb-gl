<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<!--<link rel="import" href="../iron-icons/iron-icons.html">-->

<!--<link rel="import" href="mb-api.html">-->

<!--
`mb-map`
wraps a map created with mapbox-gl-api.  
the map-object can be ctrld from outside

@demo demo/index1.html 
-->

<dom-module id="mb-map">
    <template>
        <style>
            :host {
                display: block;
            }

            #map {
                position: absolute;
                width: 100%;
                height: 100%;
            }
            .container {
                position: relative;
                width: 100%;
                height: 100%;
            }  

        </style>

        <div class="container">
            <div id='map'></div>
            <content></content>
        </div>

    </template>

    <script>
        var map, mapscope;
        var setup = {

            mapapikey: 'pk.eyJ1Ijoib25lcHV0aW4iLCJhIjoiY2ltbHBidWxhMDAwa3ZubHdpNHMwdmNwMiJ9.XnPbDF8YdaDgfMFAVi9Vyw',

            map: {
                // container: 'map',     // useless as map is in shadowdom  
                // center: [10.5, 50.5], // must be synced by client with service
                style: 'mapbox://styles/mapbox/streets-v9',                
                insertlayer: 'water'
            },

            cbox: "12, 52",
            zoom: 7

        };

        Polymer({
            is: 'mb-map',

            properties: {
                /**
                 *  map-object available for query and manipulation outside 
                 */
                map: {
                    type: Object,
                    notify: true
                },
                /**
                 *  access-key to mapbox-gl api
                 */
                mapapikey: {
                    type: String
                },
                /**
                 *  parameterset to specify mapbox-gl basemap
                 *  composed from internal defaults an external data 
                 */
                mapctrl: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },

                mapstyle: {
                    type: String,
                    notify: true 
                },

                mbid: {
                    type: String,
                    notify: true,
                },

                /**
                 *  center of visible mapview as csv(Lon,Lat)
                 */
                cbox: {
                    type: String,
                    value: "13.5, 52.5",
                    notify: true,
                    observer: '_mbMapCenter'
                },
                /**
                 *  boundingbox of visible mapview : LL,UR as Lon,Lat-csv
                 */
                bbox: {
                    type: String,
                    notify: true
                },

                zoom: {
                    type: Number,
                    value: 8,
                    observer: '_mbMapZoom'
                },

            },

            observers: [
                '_changeMapStyle(mapstyle, map)'
            ],

            attached: function() {
                mapscope = this;

                if (!this.mapapikey) this.mapapikey = setup.mapapikey;
                //                 
                this._setupMap(); 
            },

            // setup mapClient (generic)
            _setupMap : function() {    
                // ************************************
                // Compile map-parameters from (default)setup, external parameters 
                // and the local container-object !!
                var context = { container: this.$.map }; // get container as dom-element   

                if (this.zoom) context["zoom"] = this.zoom;
                if (this.cbox) context["center"] = this.cbox.split(",");

                var mapctrl = Object.assign({}, setup.map, this.mapctrl, context);
                // ************************************

                if (!this.cbox) this.cbox = setup.cbox;

                if (this.cbox) mapctrl.center = this.cbox.split(",");

                // 
                this.mapctrl = mapctrl;  // console.log("map attached", this.mapapikey, this.mapctrl);

                this._mbMapInstall(mapctrl);
            },

            /**
             * @function {function name}
             * @param  {type} mapstyle {description}
             * @param  {type} map      {description}
             * @return {type} {description}
             */
            _changeMapStyle: function(mapstyle, map){
                if (map && mapstyle) {  // console.log("CHANGE to mapstyle", mapstyle, map);
                    map.on('data', this._mbMapStyleOnChange); // set map-event-action  
                    map.setStyle(mapstyle); // trigger map-event "setStyle""
                }    
            },                

            /**
             * @function {function name}
             * @param  {type} mapctrl {description}
             * @return {type} {description}
             */
            _mbMapInstall: function(mapctrl) {
                // 
                var that = this;

                // Property of global object
                mapboxgl.accessToken = this.mapapikey;

                map = new mapboxgl.Map(mapctrl);  // console.log("create map using", this.mapctrl, mapboxgl, map);

                map.on('load', function() { // console.log("map loaded", map);
                    
                    // inform app about new center after any move
                    map.on('moveend', function() {
                        var cb = map.getCenter(),
                            bb = map.getBounds(),
                            z = map.getZoom();

                        that.cbox = cb.lng + "," + cb.lat;
                        that.bbox = bb._sw.lng + "," + bb._sw.lat + "," + bb._ne.lng + "," + bb._ne.lat;
                        that.zoom = z;
                        // console.log("moveend", that.zoom,that.cbox,that.bbox);
                    });

                    //map.on('movestart', function() {
                        // prepare calculation of move-distance
                        // this.start = map.getCenter();
                    //});

                    //map.on('zoomend', function() { 
                    //if zoom is NOT communicated to app via map-object : 
                    //});

                    // console.log("mapbox map is loaded");                
                    // LOAD of json-themes will be triggered by _changeMapStyle 
                    // if this.map is set
                    that.map = map;
                });
            },


            _mbMapZoom: function(zoom) { // console.log("_mbMapZoom", zoom, map);
                if (map) { map.setZoom(zoom);}
            },

            _mbMapCenter: function(cbox) { // console.log("_mbMapCenter", cbox, map);
                if (map) {
                    cbox = cbox.split(",");
                    cbox = new mapboxgl.LngLat(cbox[0], cbox[1]);
                    map.setCenter(cbox);
                }
            },

            // mapbox-event-action
            _mbMapStyleOnChange: function(e){ 
                if (e.dataType == "style") { // console.log("_mbMapStyleOnChange", e);
                    var mapstyleurl = mapscope.mapstyle; // console.log("_mbMapStyleOnChange", mapstyleurl);
                    if (!mapstyleurl) {
                        return;
                    }  
                    // Compare style of mb-map-api with style-ctrl-parameters (id and url) of map-element
                    // - inform app about id of actual api-mapstyle
                    // - refresh mb-mapstyle if map-element got a new style-parameter meanwhile 
                    //   (especially as SYNC during start-phase with style-menu )     
                    var stylesheet = e.style.stylesheet,
                        newstyleid = stylesheet.id,
                        oldstyleid = mapscope.mbid;
                    // console.log("_mbMapStyleOnChange", newstyleid, oldstyleid, e); // return;   

                    if (newstyleid != oldstyleid)  {
                        if (mapstyleurl.indexOf(newstyleid) < 0 ) {
                            map.setStyle(mapstyleurl);
                            console.log("MAPSTYLE-CHANGE: [" + oldstyleid+"]", "to ["+ newstyleid +"]")
                            // console.log("BUT LAST requested style is:", mapstyleurl );
                        } else {
                            map.off("data", mapscope._mbMapStyleOnChange); // console.log("_mbMapStyleOnChange OFF");
                            mapscope.mbid = newstyleid;  
                            console.log("TRIGGER (Re)Integration of json-themes(contentbox, track, waypoint) into new style"); 
                        }
                    }     
                }
            }

        });
    </script>
</dom-module>