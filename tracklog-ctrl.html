<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="mb-map-behavior.html">
<link rel="import" href="tracks-behavior.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="dynamic-menu.html">

<!--
`tracklog-ctrl`
presentation of track-properties (= selected feature) 

## Properties of *raw* data 
### elevation-log
- dropdown-menu of z-coords
- z(t)-line-chart (t as unix-h) 

### speed-log
- v(t)-line-chart

## Properties of *derived* data

@demo demo/routingtracks.html 
-->

<dom-module id="tracklog-ctrl">

    <template>

        <style>
            :host {
                display: block;
                position: absolute;
                width: 400px;
                /*height: 600px;*/
            }
            .vertical {
                @apply(--layout-vertical);
            }
            .horizontal {
                @apply(--layout-horizontal);
            }
            .flexchild {
                @apply(--layout-flex);
            }

            dynamic-menu {
               background-color: var(--paper-grey-300);
            }
        </style>

        <div class="vertical">
            <!-- get a datasetMeta -->
            <div class="flexchild">
                <!--<template is="dom-if" if="{{logdata}}">-->
                <template is="dom-if" if="{{_showmenu}}">
                    <dynamic-menu 
                        id="zmenu"
                        class="metadata"
                        menulabel="TrackPoint"
                        menuitems="[[zitems]]"
                        selectitem="{{zitem}}">
                    </dynamic-menu>
                </template>     
            </div>
        </div>
    </template>

    <script>
        
        Polymer({
            is: 'tracklog-ctrl',

            properties: {

                metadata: {
                    type: Object
                },

                // 
                logobject: {
                    type: Object // , notify: true
                },

                // 
                logindex: {
                    type: Number,
                    observer: 'setMenuSelection',
                    notify: true
                },

                logdata : {
                    type: Array,
                    notify: true
                },

                zitems : {
                    type: Array
                },

                zitem: {
                    type: Object,
                    observer: 'getmenuselection' 
                },

                disable: {
                    type: Boolean,
                    value: true
                },

                checked: {
                    type: Boolean,
                    value: true,
                    observer: "toggleElement"
                }
            },

            behaviors: [
                Mbb.TracksBehavior,
                Mbb.MapBehavior
            ],                

            observers: [
                'checkinLogdata(logobject, disable)',
            ],

            toggleElement: function(checked) {
                if (checked) {
                    this.style.display = "block";
                } else {
                    this.style.display = "none";
                }
            },    

            setMenuSelection: function(logindex){
                if (!this.zitems) return; 
                this.zitem = this.zitems[logindex];
            },

            // 
            getmenuselection: function(menuitem){// console.log("getmenuselection", menuitem.id, menuitem);
                if (!menuitem) return;  
                this.logindex = menuitem.id;
            },

            /**
             * Extract logdata (=properties) of multipoint (map-)features
             * @param      {object}  f       { mapbox-jeature }
             */
            checkinLogdata: function(logobject, disable) { 

                if (disable || (logobject==null)) this._showmenu = false;
                if (!logobject || !logobject.feature || !this.checked) {
                    this._showmenu = false;
                    return;
                }    
                if (disable) this._showmenu = false;
                else this._showmenu = true;

                //    this.logdata = null;
                //    return;
                //} 
                
                // A. generic logdata-checkin from (map-)feature-properties
                var logdata = logobject.feature.properties;   
                if (!logdata.coordElevs || !logdata.coordElevs.length) {
                    this.logdata = [];
                    return; 
                } // console.log("LogData CheckedIN:", logdata);
                
                this.logdata = logdata; 

                // B. Refresh Generic Track ctrls(Track-identification, pnt-menu) 
                // var cnt =  logdata.coordElevs.length;
                // var log = "<a href=''>["+f.id +"]</a> (n="+cnt+")<br> in logbook <a href=''>{ "+ logobject.layer+" }</a>"; 
                // this.$.meta.innerHTML = log;
               
                this.refreshCtrlElem(logdata); 
            },

            // Refresh parameters of chart-element <google-chart>
            refreshCtrlElem: function(pp){
                var scope = this,
                    times = pp["coordTimes"],
                    elevs = pp["coordElevs"];
                
                if (!times || !elevs || !times.length || !elevs.length) {
                    console.log("No elev-data found in ", pp); 
                    this.zitems = [];
                    return;
                }   // console.log("Refresh CtrlElem", times, elevs); 

                // A. Create MenuItems  
                var zitems = [], zitem;
                var sp = String.fromCharCode(160), // &nbsp;
                    delim = sp + sp,
                    zeit, utc; //  +sp ;

                times.forEach(function(t, j){
                    utc = scope.utcTime(scope.trackTime(t), "h");
                    zeit = scope.logTime(utc,"h","t"); // +":"+scope.logTime(utc,"h","m");
                    zitem = {
                        "id" : j,
                        "title" : zeit + delim + elevs[j] + "[m]",
                        "utctime" : utc,
                        "elevation": elevs[j]
                    }
                    zitems.push(zitem);
                })
                this.zitems = zitems; 
            }   
        });
    </script>
</dom-module>