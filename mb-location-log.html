<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="mb-api.html">
<link rel="import" href="mb-map-behavior.html">

<!--
`mb-location-log`
wraps a distance utility 

@demo demo/routingtracks.html 
-->

<dom-module id="mb-location-log">
    <template>
        <style>
            :host {
                display: block;
                position: absolute;
                z-index: 9;
                bottom: 0%;
                height: 1.5em;
               
                /*left: 0%;*/
                left: 50%;
                margin-right: -50%;
                transform: translate(-50%, 0);

                font: 0.8em Courier, Lucida;
                background-color: rgba(255,64,129,0.8); /*#ff4081*/
                color: white;                    
                /*opacity: 0.7;*/ /*related to all content bg,fg*/
            }

            #innerarea {
                padding: 0.2em;
            }
        </style>

        <div id="innerarea">[[info]]</div>

    </template>

    <script>
        var logscope; // required to enable variable log-events (mapmove or mouse)

        Polymer({

            is: 'mb-location-log',

            properties: {
                /**
                 *  map-object of related mb-gl-map
                 */
                mbid: {
                    type: Object,
                    observer: 'setupTool'
                },

                /**
                 * LonLat in csv-format
                 */
                lnglat: {
                    type: String,
                    notify: true,
                    observer: '_centerPointRefresh'
                },

                mousemode: {
                    type: Boolean,
                    value : false
                },
                /**
                 * creating with formatter from mb-tools
                 */
                info: {
                    type: String,
                    computed: 'formatlonlat(lnglat)'
                },

                checked: {
                    type: Boolean,
                    value: true,
                    observer: "toggleVisibility"
                },

                _centerPntLayers : {
                    type: Array
                },

                _centervisible : {
                    type: Boolean,
                    value: false
                }
            },

            behaviors: [
                Mbb.MapBehavior,
            ],

            observers: [
                'toggleMode(mousemode, checked)'
            ],

            listeners: {
                'tap': '_centerPointVisibility'
            },

            attached: function() {
                if (typeof this.checked == 'undefined') this.toggleVisibility(true);
                logscope = this;  //console.log("logscope", logscope);
            },
            // externally controled visibility of 
            toggleVisibility: function(checked) {
                if (!map) return;
                if (checked) {
                    this.style.display = "block";                    
                } else {   // console.log("toggleVisibility NONE");  
                    this.style.display = "none";
                }
            },
            
            // 
            toggleMode : function(mousemode, checked) {
                if (!map) return; 
                // 1. always set (previous) events OFF (if existing) 
                map.off('move', this.onMoveEvent);
                map.off('mousemove', this.onMoveEvent);

                // 2. set ON specific event only if log-element is checked TRUE
                if (checked) {
                    if (mousemode) {
                        map.on('mousemove', this.onMoveEvent);
                    } else {
                        map.on('move', this.onMoveEvent);
                    }
                } 
            },

            // derive location-info from mouse or map-center
            onMoveEvent: function(e) {
                if (logscope.mousemode) {
                    logscope.lnglat = e.lngLat;
                } else {
                    logscope.lnglat = map.getCenter();
                } 
            },

            // 
            setupTool: function(mbid) {
                if (map && mbid) {  // console.log("SETUP locationLogMode" , map, mbid);
                    this.toggleMode(this.mousemode, this.checked); 
                    
                    this.lnglat = map.getCenter(); // INITIAL location

                    this._centerPointSetup(this.lnglat);
                }
            },

            // Refresh coords of dragPnt (= refresh Source)
            _centerPointRefresh: function(lngLat) {
                if (!lngLat) return; // console.log("logPointGet START", lngLat, this.logdata);
                var logPointSrc = map.getSource("centerpoint");
                if (!logPointSrc) return; 

                var coords = [lngLat.lng, lngLat.lat];
                logPointSrc.setData(this._centerPointFeature(coords));
            },

            // Update LogPoint-srcData 
            _centerPointFeature : function(coords) {
                var logPoint = {
                    "type": "FeatureCollection",
                    "features": [{
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": coords
                        }
                    }]
                };
                return logPoint;    
            },

            // 
            _centerPointVisibility: function() {
                if (!map) return;

                var vis = "visible";
                this._centervisible = !this._centervisible;
                if (!this._centervisible) vis = "none";

                // console.log("Toggle visibility of centerpoint to", vis, this._centerPntLayers); // return;  
                
                this._centerPntLayers.forEach(function(layer){ 
                    if (map.getLayer(layer.id)) {
                        map.setLayoutProperty(layer.id, 'visibility', vis);
                    } 
                });    
            },
           

            // 
            _centerPointSetup: function(lnglat) {
                var coords = [lnglat.lng,lnglat.lat],
                    feat = this._centerPointFeature(coords);

                function rgb(red, green, blue) {
                    var decColor =0x1000000+ blue + 0x100 * green + 0x10000 *red ;
                    return '#'+decColor.toString(16).substr(1);
                }
                var glowcolor = rgb(255,64,129); 

                map.addSource("centerpoint", { 
                    type: 'geojson', 
                    data: feat 
                });
                // 
                var centerPntLayers = [
                    {
                        "id": "centerpoint-glow",
                        "type": "circle",
                        "source": "centerpoint",
                        "paint": {
                            "circle-radius": 18,
                            "circle-color": glowcolor, 
                            "circle-opacity": 0.4
                        }
                    }, 
                    {
                        "id": "centerpoint",
                        "type": "symbol",
                        "source": "centerpoint",
                        "layout": {
                            "icon-image": "hospital-15",
                            "icon-rotate": 0
                        }
                    }
                ];

                centerPntLayers.forEach(function(layer){
                    map.addLayer(layer);
                    map.setLayoutProperty(layer.id, 'visibility', "none");
                }); 

                this._centerPntLayers = centerPntLayers;

            },    

        });
    </script>
</dom-module>