<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../paper-button/paper-button.html">

<!--<link rel="import" href="../iron-icons/iron-icons.html">-->
<link rel="import" href="icons-svg.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">


<link rel="import" href="../paper-card/paper-card.html">

<link rel="import" href="../paper-input/paper-input.html">


<link rel="import" href="../image-meta/exif-behavior.html">

<link rel="import" href="mb-map-behavior.html">


<!--
`image-card`

OUT: RICH-content Info-card related to one selected feature,  
-  absolutely positioned as (mapbox-)map-overlay   

Mode-A: Can be vertically dragged & horizontally resized.  
Mode-B: Free drag   

To 'close' 
    - with click anywhere on the card
    - with click on specific "cancel"-button
@demo demo/routingtracks.html 
-->

<dom-module id="image-card">

    <template>

    <style is="custom-style">
        :host {
            position: absolute;
            display: none; /*inline-block; /*none; */
            opacity: 1; 
            /*to place vertically centered */
            /*top: 50%;
            margin-bottom: -50%;
            transform: translate(0, -50%);*/

            /*  */
            --paper-card-header-text: {
                padding: 8px;
                font-size: 12px;
                font-weight: 400;
            }
        }

        /* ctrl vis from outside */
        /*:host.hidden { 
            display: none; 
        }*/

        #container {
             @apply(--layout-horizontal); 
        }

        #handle {
            background-color: white;
            border-color: gray;
            border-style: solid;
            border-width: 1px 1px 1px 1px;
            font-weight: bold;
            min-width: 2em;
            margin-left: 0;
            height: 40px;
            padding: 5px;
        }

        paper-card.info { 
            @apply(--layout-horizontal); 
            align-items: flex-start;
            --paper-card-header-color: #f00;
            transition: 2s;
        }

        paper-card.info.out { 
            transition: 2s;
            width: 0;
        }    


        paper-card.edit { 
            @apply(--layout-vertical-reverse); 
            align-items: flex-start;
            --paper-card-header-color: #f00;
        }

        .card-actions {
            @apply(--layout-horizontal); 
        }

        .flex {
            @apply(--layout-flex); 
        }

        #content0 {
            font-size: 12px;
            font-weight: 400;
            border-bottom: 1px solid #e8e8e8;
            padding: 2px 2px;
        }

        .info-content {
            @apply(--layout-flex);
            width: 100%;
            float: left;
        }

        .card-image {
            width: 100px;
            height: 170px;
            background-color: red;
            background-size: cover;
        }

        .info-html { 
            color: var(--paper-grey-600); 
            opacity: 1;
        }
        
        .info-link { 
            color: var(--google-blue-500); 
        }

        paper-icon-button {
            background-color: var(--paper-light-blue-500);
        }

    </style>
    <!--  -->

    <div id="container">
        
        <paper-card 
            id="card"
            heading="[[editimg.name]]" 
            image = "[[editimg.src]]" 
            class = "edit">

            <div class="info-content">

                <div class="card-content">
                    <!-- Build content from blocks -->
                    <div id="content0">Location : [[location]]</div>
                    <div id="content1" class="info-html">
                    </div>
                </div>

                <div class="card-actions">
                    <paper-button id="locate" on-tap="_applylocation">Locate</paper-button>
                    <!--<paper-button id="rotate" on-tap="_applyrotation">Orientation</paper-button>-->
                    <paper-button class="info-link" on-tap="_storetofb">STORE</paper-button>
                    <div class="flex"></div>
                    <paper-icon-button icon="close" on-click="_toggleImg"></paper-icon-button>
                </div>

            </div>
        </paper-card>

        <paper-button on-tap="_toggleCard" id="handle"></paper-button>

    </div>

    <content>
    </content>    

</template>

    <script>
        Polymer({
            is: 'image-card',

            properties: {

                metadataset: {
                    type: Object
                },

                loadedimg: {
                    type: Object,
                    notify : true
                }, 

                editimg: {
                    type: Object
                }, 
                
                // 
                location : {
                    type: String,
                    observer: '_formatLocation'
                },
                // 
                formcontent : {
                    type: String,
                    value: "nn"
                },

                geojson : {
                    type: String,
                    notify: true                    
                }
            },

            behaviors: [
                Mbb.MapBehavior,
                Mbb.ExifBehavior
            ],

            observers: [
                '_refreshCard(loadedimg.*)'
            ],

            attached: function() {// console.log("DOM attached");
                // this.dataUsageChanged();
                this._toggleCard("close");
            },

            // A. Basic 

            _formatLocation : function(location) {
                if (!location) return;  
                var prec = this.prec ? this.prec : 5;
                if (typeof location == "string") location = JSON.parse(location);
                var ll=[];  
                location.forEach(function(x){
                    ll.push(parseFloat(x.toFixed(prec)));
                }) ;
                this.location = JSON.stringify(ll);
            },

            // 
            formContentCreate: function (editimg) {
                console.log("editimg keys", Object.keys(editimg));
                // console.log(Object.keys(editimg.location));
                // console.log(Object.keys(editimg.location.geometry));
                // console.log(Object.keys(editimg.location.properties));
                
                var locStatus = editimg.location ? "geo" : "non"; 

                this._toggleCard("open");

                // var exifRaw = this.exifGetRaw(editimg.value); 
                var exif = this.exifGetNamed(editimg.value); // console.log("EXIF", exif);
                var exifData = this.exifGetData(exif); 

                var content = editimg.name; // location.properties.name; 

                if (0) {                   

                    content = "<h3>Imagename</h3><p>"+content+"</p>"; // console.log("content2", content);
                }    

                if (1) {                    
                    var head = document.createElement("h4");
                    var newContent = document.createTextNode("More info about "+locStatus+"-located image"); 
                    head.appendChild(newContent);

                    var p1 = document.createElement("p");
                    newContent = document.createTextNode(content); 
                    p1.appendChild(newContent);

                    var p2 = document.createElement("p");
                    newContent = document.createTextNode("Camera: " + exif["Make"]); 
                    p2.appendChild(newContent);

                    var inp = document.createElement("paper-input");
                    inp.setAttribute("label", "User comment");
                    inp.setAttribute("value", exif["UserComment"]);
                    
                    content = document.createElement("div");
                    content.appendChild(head);
                    content.appendChild(p1);
                    content.appendChild(p2);
                    content.appendChild(inp);
                    
                }

                return content; 
            },


            // U
            _refreshCard : function(imgdata) { // console.log("_Apply another doc to FORM", imgdata);
                // little self-steuerung 
                // a Automatik-TÃ¼r
                if (!imgdata) this.style.display = "none";
                else          this.style.display = "inline-block";
                // b NO Action 
                var editimg = imgdata.base; // Polymer-observer specific
                if (!editimg.value) return; 

                // 
                var loc = "", formcontent = "";

                if (editimg.location) {

                    // disable the LOCATE button for this image
                    this.$.locate.disabled = true; 

                    loc = editimg.location.geometry.coordinates; 
                    // loc = JSON.stringify(loc); 
                    // console.log("Image IS located at", loc) ; 

                } else {

                    // activate the LOCATE button
                    this.$.locate.disabled = false; 
                
                    loc = ""; // this.location; 
                }

                formcontent = this.formContentCreate(editimg);
                
                // trigger form update
                // 1. img viewed in                 
                editimg.src = editimg.value; 
                this.editimg = editimg; 
                this.location = loc;

                // 2. Update (informal) form fields 

                // A. OK for non-HTML text
                // this.formcontent = formcontent;

                // B. OK for explicite HTMNL-string  
                // this.$.content1.innerHTML = formcontent;

                // C. OK for any complex content
                this.$.content1.innerHTML = '';
                this.$.content1.append(formcontent); 
                
                // Reset the Input to be ready for "next" 
                this.loadedimg = {}; 
            },

            // Add location-property to actually active editimg-object
            _applylocation : function() {
                if (!this.location) {
                    alert("location not set !"); 
                    return;
                } console.log("locating editimg ", this.editimg.name); 

                function createGeojson(longlat, imgname, img) { //console.log("createGeojson at", longlat, imgname, img);

                    longlat = JSON.parse(longlat);

                    var geojson = {
                        "type" : "Feature",
                        "geometry" : {
                            "type" : "Point",
                            "coordinates": longlat
                        },
                        "properties" : {
                            "name": imgname,
                            "img": img
                        }
                    };
                    return geojson;
                };

                var imgname = this.editimg.name,
                    img = this.editimg.value;  //console.log("locating editimg " + imgname, "img=", img);

                var geojson = createGeojson(this.location, imgname, img);  // console.log("apply gjson to "+ imgname, geojson); 

                this.set('loadedimg.geojson', geojson);

            },

            // Simple 90Â° rotations (one direction) 
            _applyrotation : function() {
                var imgname = this.editimg.name;
                console.log("_applyrotation", imgname); 
            },    

            // 
            _storetofb : function() {
                console.log("STORING",this.editimg) ; 
            },

            _toggleImg : function(e) { 
                if (!this.editimg) return;  
                if (this.editimg.src)   this.set("editimg.src","");
                else                    this.set("editimg.src", this.editimg.value);
                // this.classList.add("hidden") 
            },

            // toggle visibility of paper-card 
            _toggleCard : function(open) {  // console.log("type=", typeof(open));

                var handle = this.$.handle,
                    handlechar = handle.innerText,
                    card = this.$.card,
                    cardwidth = card.style.width
                    display = card.style.display; // console.log("handle", handlechar); console.log("card-width", card.style.width, card.style.display); 

                if (typeof(open) === "object") {
                    if (display === "none") open = "open";
                    else open = "close" ; 
                }    

                // TESTED to use CSS-animation to slowly close : NOPE     
                // if (handlechar === '>') { 
                //     card.style.width = "100%";
                //     handle.innerHTML = "<";
                // } else {
                //     card.style.width = 0;
                //     handle.innerHTML = ">";
                // }    

                if (open == 'open') { 
                    card.style.display = "block";
                    handle.innerText = "<";
                } else {    
                    card.style.display = "none";
                    handle.innerText = ">";
                }    
                // console.log("toggled paper-card visibility !") 
            },


            // B. COMPILE Feature-data for OUTPUT
            /**
             * Create some formatted html-text(dom?) 
             * to identify basic properties of an animated object (animation status)
             *
             * @param      {<type>}  trackObj  The animated trackObj (as mb-feature)
             * @return     {string}  A formatted information about trackObj-status.
             */
            calcBasicInfo: function(trackObj) {
                if (!trackObj || !trackObj.properties) return;

                var trackInfo = "<b>" + trackObj.properties.id + "</b>" + "<br>";
                if (trackObj.properties.time) trackInfo += trackObj.properties.time + "<hr>";

                if (trackObj.properties.speed) trackInfo += "SOG: " + trackObj.properties.speed + " nds <br>";
                if (trackObj.properties.bearing) trackInfo += "Head: " + trackObj.properties.bearing + "Â°<hr>";

                return trackInfo;
            },

            /**
             * Build (app-specific) trackData extending the basic infoSet 
             * to enable enhanced presentation of trackObj
             *
             * @param      {<type>}  trackObj  The track object
             * @param      {<type>}  openFlag  The open flag
             * @return     {<type>}  The more track data.
             */
            calcExtendedInfo: function(trackObj, openFlag) {
                if (!trackObj || !trackObj.properties) return;

                var basicInfo = this.calcBasicInfo(trackObj);

                var extendedData = {
                    "title": trackObj.properties.title,
                    "html": basicInfo,
                    "properties": trackObj.properties
                };

                if (openFlag) {
                    extendedData.open = 1;
                }

                if (trackObj.properties.master) {
                    extendedData.headline = trackObj.properties.master.skipper;
                }
                // console.log("calcTrackData", trackObj, trackData)
                return extendedData;
            },

            // C.  FORMAT INFO-Card 

            refreshCardContent: function(data) {
                var nbsp = "&nbsp;"; //"~"; 
                if (!data) return;

                // if (data.properties && data.properties.master) {
                // var pp = JSON.parse(data.properties.master);
                if (this.masterdata && data.properties.id) {
                    // 
                    pp = this.masterdata[data.properties.id];
                    if (pp) {
                        // console.log("masterdata:", pp);
                        // DIV0
                        var imgurl = pp.img,
                            skipper = pp.skipper,
                            boat = pp.ship,
                            header = "";

                        if (imgurl) this.cardimgurl = "wp-data/" + imgurl;
                        // console.log("some data ", imgurl, this.cardimgurl, skipper, boat);

                        if (skipper && boat) {

                            // to show items with no line-breaks (fi. in flex-formatted cards)
                            // replace many spaces 
                            skipper = skipper.split(' ').join(nbsp);
                            boat = boat.split(' ').join(nbsp);
                            // statt: 
                            // skipper = skipper.replace(" ", nbsp);
                            // boat = boat.replace(" ", nbsp);

                            header = "<b>" + boat + "</b>" + "<br>" + skipper;

                            this.$.content0.innerHTML = header;
                        }
                    }
                }

                // DIV1
                if (data.html) this.$.content1.innerHTML = data.html;
            }

        });
    </script>

</dom-module>