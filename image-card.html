<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<!--<link rel="import" href="../paper-button/paper-button.html">-->

<!--<link rel="import" href="../iron-icons/iron-icons.html">-->
<link rel="import" href="icons-svg.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">


<link rel="import" href="../paper-card/paper-card.html">

<link rel="import" href="../paper-input/paper-input.html">


<link rel="import" href="../image-meta/exif-behavior.html">
<link rel="import" href="../image-canvas/image-orientation.html">

<link rel="import" href="mb-map-behavior.html">


<!--
`image-card`

OUT: RICH-content Info-card related to one selected feature,  
-  absolutely positioned as (mapbox-)map-overlay   

Mode-A: Can be vertically dragged & horizontally resized.  
Mode-B: Free drag   

To 'close' 
    - with click anywhere on the card
    - with click on specific "cancel"-button
@demo demo/routingtracks.html 
-->

<dom-module id="image-card">

    <template>

    <style is="custom-style">
        :host {
            position: absolute;
            display: none; /*inline-block; */
            opacity: 1; 
            /*to place vertically centered */
            /*top: 50%;
            margin-bottom: -50%;
            transform: translate(0, -50%);*/

            /*  */
            --paper-card-header-text: {
                padding: 8px;
                font-size: 12px;
                font-weight: 400;
            }
        }

        /* ctrl vis from outside */
        /*:host.hidden { 
            display: none; 
        }*/

        #container {
             @apply(--layout-horizontal); 
        }

        #handle {
            background-color: white;
            border-color: gray;
            border-style: solid;
            border-width: 1px 1px 1px 1px;
            font-weight: bold;
            min-width: 2em;
            margin-left: 0;
            height: 40px;
            padding: 5px;
        }

        paper-card.info { 
            @apply(--layout-horizontal); 
            align-items: flex-start;
            --paper-card-header-color: #f00;
            transition: 2s;
        }

        paper-card.info.out { 
            transition: 2s;
            width: 0;
        }    


        paper-card.edit { 
            @apply(--layout-vertical-reverse); 
            align-items: flex-start;
            --paper-card-header-color: #f00;
        }

        .card-actions {
            @apply(--layout-horizontal); 
        }

        .flex {
            @apply(--layout-flex); 
        }

        #content0 {
            font-size: 12px;
            font-weight: 400;
            border-bottom: 1px solid #e8e8e8;
            padding: 2px 2px;
        }

        .info-content {
            @apply(--layout-flex);
            width: 100%;
            float: left;
        }

        .card-image {
            width: 100px;
            height: 170px;
            background-color: red;
            background-size: cover;
        }

        .info-html { 
            color: var(--paper-grey-600); 
            opacity: 1;
        }
        
        .info-link { 
            color: var(--google-blue-500); 
        }

    </style>
    <!--  -->

    <div id="container">
        
        <image-orientation 
            id     = "preview" 
            src    = "[[docobj.value]]" 
            out    = "{{imgdata}}" 
            quality= "[[quality]]">
        </image-orientation>

        <exif-locations
            locationmode = "coords"
            imagedata = "[[docobj.value]]"
            locations  = "{{locations}}">
        </exif-locations>

        <paper-card 
            id = "card"
            heading="[[_titleText]]" 
            image = "[[_titleImg]]" 
            class = "edit">

            <div class="info-content">

                <!-- Build content from blocks -->
                <div class="card-content">
                    <div id="content0">Location : [[doclocation]]</div>
                    <div id="content1" class="info-html">
                    </div>
                </div>

                <div class="card-actions">
                    <paper-button id="locate" on-tap="_applyLocationToImg">Locate</paper-button>
                    <paper-button class="info-link" on-tap="_storetofb">STORE</paper-button>
                    <div class="flex"></div>
                    <paper-icon-button id="vistoggle" icon="app:visibility-off" on-click="_toggleImgVisibility"></paper-icon-button>
                </div>

            </div>
        </paper-card>

        <paper-icon-button icon="app:last-page" on-tap="_toggleCard" id="handle"></paper-button>

    </div>

    <content>
    </content>    

</template>

    <script>
        Polymer({
            is: 'image-card',

            properties: {
                // 
                _titleText : {
                    type: String
                },
                _titleImg : {
                    type: String
                },

                quality : 100, 

                // Primary exchange Object (organizing data&metadata of document(img))
                docobj: {
                    type: Object,
                    notify : true
                }, 

                docobjs: {
                    type: Array,
                    computed: 'toArray(docobj)'
                },

                // imgdata after "orientation-verification"
                imgdata : {
                    type: String,
                    observer: '_setupImgCard'
                },
                // 
                imgDoc: {
                    type: Object
                }, 

                // Alternative src of card-content 
                // menu from list of {value:value,text:text} items)                
                itemdata : {
                    type: Array
                },
                // if selected from menu-items 
                docobjid: {
                    type: String,
                    notify : true
                }, 

                // status-property
                locations : {
                    type: Array,
                    observer: '_formatLocation'
                },

                // import-property
                maplocation : {
                    type: String
                },
                // status-property
                doclocation : {
                    type: String
                    // observer: '_formatLocation'
                },

                cardstatus : {
                    type: String,
                    value: "",
                    observer: '_toggleCard'
                }
                
            },

            behaviors: [
                Mbb.MapBehavior,
                Mbb.ExifBehavior
            ],

            observers: [
                // '_setupMenuCard(itemdata)'
            ],

            listeners: {
                // 'cluster.tap': 'clusterSelect'
            },

            attached: function() {// console.log("DOM attached");
                // this.dataUsageChanged();
                this._toggleCard("close");
            },

            toArray: function(docobj) {
                return [docobj];
            },

            clusterSelect : function(e){
                console.log("selected item", e);
            },

            // A. Basic 

            // Reduce the presented location-precision
            _formatLocation : function(location) { 
                if (!location || !location.length) {
                    this.doclocation = "";
                    return;
                }

                location = location[0];  
                if (typeof location == "string") location = JSON.parse(location);

                // Run prec-reduction 
                var prec = this.prec ? this.prec : 5;
                var ll = [];  
                location.forEach(function(x){
                    ll.push(parseFloat(x.toFixed(prec)));
                }) ;

                this.doclocation = JSON.stringify(ll);  // console.log("_formatLocation from,to", location, this.doclocation);
            },

            // (Optional) Refresh card from menudata(?) 
            _setupMenuCard: function (itemdata) {
                if (!itemdata) this.style.display = "none";
                else           this.style.display = "inline-block";
                if (!itemdata.length) return;  console.log("itemdata4menu", itemdata);
                
                var icard = this;
                icard._toggleCard("open");
                
                // 1. Header 
                icard._titleText =  "Cluster with " + itemdata.length +" itemdata";
                icard._titleImg = "";
                
                // 2. Modify/Hide(?) CtrlLine ??? 

                // 3. Create/Apply Main Content
                var menu = document.createElement("paper-menu");
                var item;

                itemdata.forEach(function(data){

                    item = document.createElement("paper-item");
                    item.setAttribute("value", data.value);
                    item.classList.add("cluster");
                    item.appendChild(document.createTextNode(data.text));

                    menu.appendChild(item);
                });

                icard.$.content1.innerHTML = '';
                icard.$.content1.append(menu); 

                // 4. Setup LINKS from menu-items
                //    = pass docobjid into app-shell 
                var items = Polymer.dom(this.root).querySelectorAll("paper-item");
                items.forEach(function(item){
                    item.addEventListener('tap', function(e){
                        icard._toggleCard("close");
                        icard.docobjid = e.target.getAttribute("value");
                    });
                });
            },

            // FormUpdate starts after img-check
            _setupImgCard : function(imgData) { 
                if (!imgData) {
                    this.style.display = "none";
                    return; 
                } // console.log("Image was (ORIENTATON-) checked");
                this.style.display = "inline-block";

                // Auxiliary object for imgToggling
                this.imgDoc = {
                    name : this.docobj.name,
                    value : imgData,
                    src : imgData
                };

                this._titleImg = this.imgDoc.src;

                this._setupCardData(this.imgDoc);
            },

            _setupCardData : function(imgDocObj) {  // console.log(" Create CARD data/form  .", imgDocObj);

                var self = this; 
                // create Dorm describing an Image 
                function imgFormUpdate(imgDoc) {
                    // console.log("imgDoc keys", Object.keys(imgDoc));
                    // console.log(Object.keys(imgDoc.location));
                    // console.log(Object.keys(imgDoc.location.geometry));
                    // console.log(Object.keys(imgDoc.location.properties));
                    
                    // var exifRaw = this.exifGetRaw(imgDoc.value); 
                    var exif = self.exifGetNamed(imgDoc.value); // console.log("EXIF", exif);
                    // var exifData = self.exifGetData(exif); 

                    var content = imgDoc.name; // location.properties.name; 

                    var locStatus = imgDoc.location ? "geo" : "non"; 
                    

                    var head = document.createElement("h4");
                    var newContent = document.createTextNode("More info about "+locStatus+"-located image"); 
                    head.appendChild(newContent);

                    var p1 = document.createElement("p");
                    newContent = document.createTextNode(content); 
                    p1.appendChild(newContent);

                    var p2 = document.createElement("p");
                    newContent = document.createTextNode("Camera: " + exif["Make"]); 
                    p2.appendChild(newContent);

                    var inp = document.createElement("paper-input");
                    inp.setAttribute("label", "User comment");
                    inp.setAttribute("value", exif["UserComment"]);
                    
                    content = document.createElement("div");
                    content.appendChild(head);
                    content.appendChild(p1);
                    content.appendChild(p2);
                    content.appendChild(inp);

                    return content; 
                };

                this._titleText = imgDocObj.name ? imgDocObj.name : "nn";

                // Update (informal) form fields 
                var content = imgFormUpdate(imgDocObj);

                var formContainer =  this.$.content1;
                formContainer.innerHTML = '';
                formContainer.append(content); 

                // Update app-properties // ??? 
                this.imgDoc = imgDocObj;

                // Reset the Input to be ready to receive "next" doc ?? 
                // with "long-enough" delay  
                // this.docobj = {}; 
            },

            // Add location-property to actually active imgDoc-object
            _applyLocationToImg : function() {
                var exifmode = true; 
                if (!this.maplocation) {
                    alert("maplocation not available !"); 
                    return;
                } 

                var location = this.maplocation,
                    imgname = this.imgDoc.name,
                    img = this.imgDoc.value;  //console.log("locating imgDoc " + imgname, "img=", img);

                if (exifmode) { // Update Location data in exif (GPS*) of img and trigger reload 
                    // console.log("Locating imgDoc ", this.imgDoc.name, "at", location); 

                    var exif = this.exifSetLocation(location) ; // console.log("exif geolocated", exif); // return;  

                    img  = this.exifToImg(img, exif);

                    this.set('docobj.value', img);
                    this.set('docobj.exif', true);
                    
                } else {        // 

                    function createGeojson(longlat, imgname, img) { console.log("createGeojson at", longlat, imgname); // , img);
                        if (typeof longlat == "string") {  
                            longlat = JSON.parse(longlat);
                        } else if (longlat.lng) { // mbFeature 
                            longlat = longlat.toArray(); 
                        } 

                        var geojson = {
                            "type" : "Feature",
                            "geometry" : {
                                "type" : "Point",
                                "coordinates": longlat
                            },
                            "properties" : {
                                "name": imgname,
                                "img": img
                            }
                        };
                        return geojson;
                    };

                    var geojson = createGeojson(location, imgname, img);  // console.log("apply gjson to "+ imgname, geojson); 

                    this.set('docobj.geojson', geojson);
                }

            },

            // Move imgDocObj to DB (fi FB)
            _storetofb : function() {
                console.log("Placeholder: STORING to DB",this.imgDoc) ; 
            },

            // Enhance UX toggling Img-visibility
            _toggleImgVisibility : function(e) { 
                if (!this.imgDoc) return;  
                var handle = this.$.vistoggle;
                if (this.imgDoc.src)   { console.log("Hide Image");
                    this.set("imgDoc.src","");
                    handle.setAttribute("icon","app:visibility");
                } else { console.log("Show Image");
                    this.set("imgDoc.src", this.imgDoc.value);
                    handle.setAttribute("icon","app:visibility-off");
                }   
               
                // this.classList.add("hidden") 
            },

            // toggle visibility of paper-card 
            _toggleCard : function(open) {  // console.log("type=", typeof(open));

                var handle = this.$.handle,
                    card = this.$.card,
                    display   = card.style.display; 
                    // cardwidth = card.style.width,

                if (typeof(open) === "object") {
                    if (display === "none") open = "open";
                    else open = "close" ; 
                }    

                if (open == 'open') { 
                    card.style.display = "block";
                    handle.setAttribute("icon", "app:first-page");
                } else {    
                    card.style.display = "none";
                    handle.setAttribute("icon", "app:last-page");
                }   // console.log("toggled paper-card visibility to", open) 
            },

            // B. COMPILE Feature-data for OUTPUT
            /**
             * Create some formatted html-text(dom?) 
             * to identify basic properties of an animated object (animation status)
             *
             * @param      {<type>}  trackObj  The animated trackObj (as mb-feature)
             * @return     {string}  A formatted information about trackObj-status.
             */
            calcBasicInfo: function(trackObj) {
                if (!trackObj || !trackObj.properties) return;

                var trackInfo = "<b>" + trackObj.properties.id + "</b>" + "<br>";
                if (trackObj.properties.time) trackInfo += trackObj.properties.time + "<hr>";

                if (trackObj.properties.speed) trackInfo += "SOG: " + trackObj.properties.speed + " nds <br>";
                if (trackObj.properties.bearing) trackInfo += "Head: " + trackObj.properties.bearing + "°<hr>";

                return trackInfo;
            },

            /**
             * Build (app-specific) trackData extending the basic infoSet 
             * to enable enhanced presentation of trackObj
             *
             * @param      {<type>}  trackObj  The track object
             * @param      {<type>}  openFlag  The open flag
             * @return     {<type>}  The more track data.
             */
            calcExtendedInfo: function(trackObj, openFlag) {
                if (!trackObj || !trackObj.properties) return;

                var basicInfo = this.calcBasicInfo(trackObj);

                var extendedData = {
                    "title": trackObj.properties.title,
                    "html": basicInfo,
                    "properties": trackObj.properties
                };

                if (openFlag) {
                    extendedData.open = 1;
                }

                if (trackObj.properties.master) {
                    extendedData.headline = trackObj.properties.master.skipper;
                }
                // console.log("calcTrackData", trackObj, trackData)
                return extendedData;
            },

            // C.  FORMAT INFO-Card 

            refreshCardContent: function(data) {
                var nbsp = "&nbsp;"; //"~"; 
                if (!data) return;

                // if (data.properties && data.properties.master) {
                // var pp = JSON.parse(data.properties.master);
                if (this.masterdata && data.properties.id) {
                    // 
                    pp = this.masterdata[data.properties.id];
                    if (pp) {
                        // console.log("masterdata:", pp);
                        // DIV0
                        var imgurl = pp.img,
                            skipper = pp.skipper,
                            boat = pp.ship,
                            header = "";

                        if (imgurl) this.cardimgurl = "wp-data/" + imgurl;
                        // console.log("some data ", imgurl, this.cardimgurl, skipper, boat);

                        if (skipper && boat) {

                            // to show items with no line-breaks (fi. in flex-formatted cards)
                            // replace many spaces 
                            skipper = skipper.split(' ').join(nbsp);
                            boat = boat.split(' ').join(nbsp);
                            // statt: 
                            // skipper = skipper.replace(" ", nbsp);
                            // boat = boat.replace(" ", nbsp);

                            header = "<b>" + boat + "</b>" + "<br>" + skipper;

                            this.$.content0.innerHTML = header;
                        }
                    }
                }

                // DIV1
                if (data.html) this.$.content1.innerHTML = data.html;
            }

        });
    </script>

</dom-module>