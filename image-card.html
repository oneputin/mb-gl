<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<!--<link rel="import" href="../paper-button/paper-button.html">-->

<!--<link rel="import" href="../iron-icons/iron-icons.html">-->
<link rel="import" href="icons-svg.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">


<link rel="import" href="../paper-card/paper-card.html">

<link rel="import" href="../paper-input/paper-input.html">


<link rel="import" href="../image-meta/exif-behavior.html">

<link rel="import" href="mb-map-behavior.html">


<!--
`image-card`

OUT: RICH-content Info-card related to one selected feature,  
-  absolutely positioned as (mapbox-)map-overlay   

Mode-A: Can be vertically dragged & horizontally resized.  
Mode-B: Free drag   

To 'close' 
    - with click anywhere on the card
    - with click on specific "cancel"-button
@demo demo/routingtracks.html 
-->

<dom-module id="image-card">

    <template>

    <style is="custom-style">
        :host {
            position: absolute;
            display: none; /*inline-block; */
            opacity: 1; 
            /*to place vertically centered */
            /*top: 50%;
            margin-bottom: -50%;
            transform: translate(0, -50%);*/

            /*  */
            --paper-card-header-text: {
                padding: 8px;
                font-size: 12px;
                font-weight: 400;
            }
        }

        /* ctrl vis from outside */
        /*:host.hidden { 
            display: none; 
        }*/

        #container {
             @apply(--layout-horizontal); 
        }

        #handle {
            background-color: white;
            border-color: gray;
            border-style: solid;
            border-width: 1px 1px 1px 1px;
            font-weight: bold;
            min-width: 2em;
            margin-left: 0;
            height: 40px;
            padding: 5px;
        }

        paper-card.info { 
            @apply(--layout-horizontal); 
            align-items: flex-start;
            --paper-card-header-color: #f00;
            transition: 2s;
        }

        paper-card.info.out { 
            transition: 2s;
            width: 0;
        }    


        paper-card.edit { 
            @apply(--layout-vertical-reverse); 
            align-items: flex-start;
            --paper-card-header-color: #f00;
        }

        .card-actions {
            @apply(--layout-horizontal); 
        }

        .flex {
            @apply(--layout-flex); 
        }

        #content0 {
            font-size: 12px;
            font-weight: 400;
            border-bottom: 1px solid #e8e8e8;
            padding: 2px 2px;
        }

        .info-content {
            @apply(--layout-flex);
            width: 100%;
            float: left;
        }

        .card-image {
            width: 100px;
            height: 170px;
            background-color: red;
            background-size: cover;
        }

        .info-html { 
            color: var(--paper-grey-600); 
            opacity: 1;
        }
        
        .info-link { 
            color: var(--google-blue-500); 
        }

        paper-icon-button {
            background-color: var(--paper-light-blue-500);
        }

    </style>
    <!--  -->

    <div id="container">
        
        <paper-card 
            id = "card"
            heading="[[_titleText]]" 
            image = "[[_titleImg]]" 
            class = "edit">

            <div class="info-content">

                <!-- Build content from blocks -->
                <div class="card-content">
                    <div id="content0">Location : [[location]]</div>
                    <div id="content1" class="info-html">
                    </div>
                </div>

                <div class="card-actions">
                    <paper-button id="locate" on-tap="_applylocation">Locate</paper-button>
                    <!--<paper-button id="rotate" on-tap="_applyrotation">Orientation</paper-button>-->
                    <paper-button class="info-link" on-tap="_storetofb">STORE</paper-button>
                    <div class="flex"></div>
                    <paper-icon-button icon="close" on-click="_toggleImg"></paper-icon-button>
                </div>

            </div>
        </paper-card>

        <paper-icon-button icon="app:last-page" on-tap="_toggleCard" id="handle"></paper-button>

    </div>

    <content>
    </content>    

</template>

    <script>
        Polymer({
            is: 'image-card',

            properties: {
                _titleText : {
                    type: String
                },
                _titleImg : {
                    type: String
                },

                // src of card-content
                carddoc: {
                    type: Object,
                    notify : true
                }, 
                // 
                querydocid: {
                    type: String,
                    notify : true
                }, 
                
                imgDoc: {
                    type: Object
                }, 

                // Alternative src of card-content 
                // menu from list of {value:value,text:text} items)                
                itemdata : {
                    type: Array
                },

                metadataset: {
                    type: Object
                },

                // 
                location : {
                    type: String,
                    observer: '_formatLocation'
                },
            },

            behaviors: [
                Mbb.MapBehavior,
                Mbb.ExifBehavior
            ],

            observers: [
                '_refreshCardImg(carddoc.*)',
                '_refreshCardMenu(itemdata)'
            ],

            listeners: {
                // 'cluster.tap': 'clusterSelect'
            },

            attached: function() {// console.log("DOM attached");
                // this.dataUsageChanged();
                this._toggleCard("close");
            },

            clusterSelect : function(e){
                console.log("selected item", e);
            },

            // A. Basic 

            _formatLocation : function(location) {
                if (!location) return;  
                var prec = this.prec ? this.prec : 5;
                if (typeof location == "string") location = JSON.parse(location);
                var ll=[];  
                location.forEach(function(x){
                    ll.push(parseFloat(x.toFixed(prec)));
                }) ;
                this.location = JSON.stringify(ll);
            },

            _refreshCardMenu: function (itemdata) {
                if (!itemdata) this.style.display = "none";
                else           this.style.display = "inline-block";
                if (!itemdata.length) return;  console.log("itemdata4menu", itemdata);
                
                var icard = this;
                icard._toggleCard("open");
                
                // 1. Header 
                icard._titleText =  "Cluster with " + itemdata.length +" itemdata";
                icard._titleImg = "";
                
                // 2. Modify/Hide(?) CtrlLine ??? 

                // 3. Create/Apply Main Content
                var menu = document.createElement("paper-menu");
                var item;

                itemdata.forEach(function(data){

                    item = document.createElement("paper-item");
                    item.setAttribute("value", data.value);
                    item.classList.add("cluster");
                    item.appendChild(document.createTextNode(data.text));

                    menu.appendChild(item);
                });

                icard.$.content1.innerHTML = '';
                icard.$.content1.append(menu); 

                // 4. Setup LINKS from menu-items
                //    = pass querydocid into app-shell 

                var items = Polymer.dom(this.root).querySelectorAll("paper-item");
                
                items.forEach(function(item){
                    item.addEventListener('tap', function(e){
                        icard._toggleCard("close");
                        icard.querydocid = e.target.getAttribute("value");
                    });
                });
            },

            // create Dorm describing an Image 
            imgFormCreate: function (imgDoc) {
                // console.log("imgDoc keys", Object.keys(imgDoc));
                // console.log(Object.keys(imgDoc.location));
                // console.log(Object.keys(imgDoc.location.geometry));
                // console.log(Object.keys(imgDoc.location.properties));
                
                var locStatus = imgDoc.location ? "geo" : "non"; 

                this._toggleCard("open");

                // var exifRaw = this.exifGetRaw(imgDoc.value); 
                var exif = this.exifGetNamed(imgDoc.value); // console.log("EXIF", exif);
                var exifData = this.exifGetData(exif); 

                var content = imgDoc.name; // location.properties.name; 

                var head = document.createElement("h4");
                var newContent = document.createTextNode("More info about "+locStatus+"-located image"); 
                head.appendChild(newContent);

                var p1 = document.createElement("p");
                newContent = document.createTextNode(content); 
                p1.appendChild(newContent);

                var p2 = document.createElement("p");
                newContent = document.createTextNode("Camera: " + exif["Make"]); 
                p2.appendChild(newContent);

                var inp = document.createElement("paper-input");
                inp.setAttribute("label", "User comment");
                inp.setAttribute("value", exif["UserComment"]);
                
                content = document.createElement("div");
                content.appendChild(head);
                content.appendChild(p1);
                content.appendChild(p2);
                content.appendChild(inp);

                return content; 
            },

            // Update 
            _refreshCardImg : function(imgData) { // console.log("_Apply another doc to FORM", imgData);
                // little self-steuerung 
                // a Automatik-Tür
                if (!imgData) this.style.display = "none";
                else          this.style.display = "inline-block";
                
                // b RAW ContentCheck , NO Action 
                var imgDoc = imgData.base; // Polymer-observer specific
                if (!imgDoc.value) return; 

                // 
                var loc = "", formcontent = "";
                this._titleText = imgDoc.name ? imgDoc.name : "nn";
                this._titleImg = imgDoc.value ? imgDoc.value : "";
                 
                if (imgDoc.location) {

                    // disable the LOCATE button of the CARD.Ctrls
                    this.$.locate.disabled = true; 

                    loc = imgDoc.location.geometry.coordinates; 
                    // loc = JSON.stringify(loc); 
                    // console.log("Image IS located at", loc) ; 

                } else {

                    // activate the LOCATE button
                    this.$.locate.disabled = false; 
                
                    loc = ""; // this.location; 
                }

                formcontent = this.imgFormCreate(imgDoc);
                
                // trigger form update

                // 1. img viewed in                 
                imgDoc.src = imgDoc.value; 
                this.imgDoc = imgDoc; 
                this.location = loc;

                // 2. Update (informal) form fields 

                this.$.content1.innerHTML = '';
                this.$.content1.append(formcontent); 
                
                // Reset the Input to be ready for "next" 
                this.carddoc = {}; 
            },

            // Add location-property to actually active imgDoc-object
            _applylocation : function() {
                if (!this.location) {
                    alert("location not set !"); 
                    return;
                } console.log("locating imgDoc ", this.imgDoc.name); 

                function createGeojson(longlat, imgname, img) { //console.log("createGeojson at", longlat, imgname, img);

                    longlat = JSON.parse(longlat);

                    var geojson = {
                        "type" : "Feature",
                        "geometry" : {
                            "type" : "Point",
                            "coordinates": longlat
                        },
                        "properties" : {
                            "name": imgname,
                            "img": img
                        }
                    };
                    return geojson;
                };

                var imgname = this.imgDoc.name,
                    img = this.imgDoc.value;  //console.log("locating imgDoc " + imgname, "img=", img);

                var geojson = createGeojson(this.location, imgname, img);  // console.log("apply gjson to "+ imgname, geojson); 

                this.set('carddoc.geojson', geojson);

            },

            // Simple 90° rotations (one direction) 
            _applyrotation : function() {
                var imgname = this.imgDoc.name;
                console.log("_applyrotation", imgname); 
            },    

            // 
            _storetofb : function() {
                console.log("STORING",this.imgDoc) ; 
            },

            _toggleImg : function(e) { 
                if (!this.imgDoc) return;  
                if (this.imgDoc.src)   this.set("imgDoc.src","");
                else                    this.set("imgDoc.src", this.imgDoc.value);
                // this.classList.add("hidden") 
            },

            // toggle visibility of paper-card 
            _toggleCard : function(open) {  // console.log("type=", typeof(open));

                var handle = this.$.handle,
                    handlechar = handle.innerText,
                    card = this.$.card,
                    cardwidth = card.style.width
                    display = card.style.display; // console.log("handle", handlechar); console.log("card-width", card.style.width, card.style.display); 

                if (typeof(open) === "object") {
                    if (display === "none") open = "open";
                    else open = "close" ; 
                }    

                /*  //TESTED to use CSS-animation to slowly open/close : NOPE     
                    if (handlechar === '>') { 
                        card.style.width = "100%";
                        handle.innerHTML = "<";
                    } else {
                        card.style.width = 0;
                        handle.innerHTML = ">";
                    }    
                */

                if (open == 'open') { 
                    card.style.display = "block";
                    handle.setAttribute("icon","app:first-page");
                    // handle.innerText = "<";
                } else {    
                    card.style.display = "none";
                    handle.setAttribute("icon", "app:last-page");
                    // handle.innerText = ">";
                }    
                // console.log("toggled paper-card visibility to", open) 
            },

            // B. COMPILE Feature-data for OUTPUT
            /**
             * Create some formatted html-text(dom?) 
             * to identify basic properties of an animated object (animation status)
             *
             * @param      {<type>}  trackObj  The animated trackObj (as mb-feature)
             * @return     {string}  A formatted information about trackObj-status.
             */
            calcBasicInfo: function(trackObj) {
                if (!trackObj || !trackObj.properties) return;

                var trackInfo = "<b>" + trackObj.properties.id + "</b>" + "<br>";
                if (trackObj.properties.time) trackInfo += trackObj.properties.time + "<hr>";

                if (trackObj.properties.speed) trackInfo += "SOG: " + trackObj.properties.speed + " nds <br>";
                if (trackObj.properties.bearing) trackInfo += "Head: " + trackObj.properties.bearing + "°<hr>";

                return trackInfo;
            },

            /**
             * Build (app-specific) trackData extending the basic infoSet 
             * to enable enhanced presentation of trackObj
             *
             * @param      {<type>}  trackObj  The track object
             * @param      {<type>}  openFlag  The open flag
             * @return     {<type>}  The more track data.
             */
            calcExtendedInfo: function(trackObj, openFlag) {
                if (!trackObj || !trackObj.properties) return;

                var basicInfo = this.calcBasicInfo(trackObj);

                var extendedData = {
                    "title": trackObj.properties.title,
                    "html": basicInfo,
                    "properties": trackObj.properties
                };

                if (openFlag) {
                    extendedData.open = 1;
                }

                if (trackObj.properties.master) {
                    extendedData.headline = trackObj.properties.master.skipper;
                }
                // console.log("calcTrackData", trackObj, trackData)
                return extendedData;
            },

            // C.  FORMAT INFO-Card 

            refreshCardContent: function(data) {
                var nbsp = "&nbsp;"; //"~"; 
                if (!data) return;

                // if (data.properties && data.properties.master) {
                // var pp = JSON.parse(data.properties.master);
                if (this.masterdata && data.properties.id) {
                    // 
                    pp = this.masterdata[data.properties.id];
                    if (pp) {
                        // console.log("masterdata:", pp);
                        // DIV0
                        var imgurl = pp.img,
                            skipper = pp.skipper,
                            boat = pp.ship,
                            header = "";

                        if (imgurl) this.cardimgurl = "wp-data/" + imgurl;
                        // console.log("some data ", imgurl, this.cardimgurl, skipper, boat);

                        if (skipper && boat) {

                            // to show items with no line-breaks (fi. in flex-formatted cards)
                            // replace many spaces 
                            skipper = skipper.split(' ').join(nbsp);
                            boat = boat.split(' ').join(nbsp);
                            // statt: 
                            // skipper = skipper.replace(" ", nbsp);
                            // boat = boat.replace(" ", nbsp);

                            header = "<b>" + boat + "</b>" + "<br>" + skipper;

                            this.$.content0.innerHTML = header;
                        }
                    }
                }

                // DIV1
                if (data.html) this.$.content1.innerHTML = data.html;
            }

        });
    </script>

</dom-module>