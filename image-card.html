<link rel="import" href="../polymer/polymer.html">


<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-button/paper-button.html">

<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-card/paper-card.html">

<link rel="import" href="mb-map-behavior.html">


<!--
`image-card`

OUT: RICH-content Info-card related to one selected feature,  
-  absolutely positioned as (mapbox-)map-overlay   

Mode-A: Can be vertically dragged & horizontally resized.  
Mode-B: Free drag   

To 'close' 
    - with click anywhere on the card
    - with click on specific "cancel"-button
@demo demo/routingtracks.html 
-->

<dom-module id="image-card">

    <template>

    <style is="custom-style">
        :host {
            position: absolute;
            display: inline-block; /*none; */
            opacity: 1; 
            /*to place vertically centered */
            /*top: 50%;
            margin-bottom: -50%;
            transform: translate(0, -50%);*/

            /*  */
            --paper-card-header-text: {
                padding: 8px;
                font-size: 12px;
                font-weight: 400;
            }
        }

        :host.hidden { /* can be ctrled from outside*/
            display: none; 
        }

        paper-card.info { 
            @apply(--layout-horizontal); 
            align-items: flex-start;
            --paper-card-header-color: #f00;
        }

        paper-card.edit { 
            @apply(--layout-vertical-reverse); 
            align-items: flex-start;
            --paper-card-header-color: #f00;
        }


        .card-actions {
            @apply(--layout-horizontal); 
        }

        .flex {
            @apply(--layout-flex); 
        }

        #div0 {
            font-size: 12px;
            font-weight: 400;
            border-bottom: 1px solid #e8e8e8;
            padding: 2px 2px;
        }

        .info-content {
            @apply(--layout-flex);
            width: 100%;
            float: left;
        }

        .card-image {
            width: 100px;
            height: 170px;
            background-color: red;
            background-size: cover;
        }

        .info-html { 
            color: var(--paper-grey-600); 
            opacity: 1;
        }
        
        .info-link { 
            color: var(--google-blue-500); 
        }

        paper-icon-button {
            background-color: var(--paper-light-blue-500);
        }

    </style>
    <!--  -->
        <!--image="{{cardimgurl}}" -->
    <paper-card 
        heading="[[editimg.name]]" 
        image="[[editimg.src]]" 
        class="edit">
        <!--heading="{{carddata.title}}" -->
        <!--class="info">-->

        <!--<img class="" src="[[]]">-->

        <div class="info-content">

            <div class="card-content">

                <div id="div0">location : [[location]]</div>

                <div id="div1" class="info-html">
                    [[geojson]]
                </div>

            </div>

            <div class="card-actions">
                <paper-button id="locate" on-tap="_applylocation">Locate</paper-button>
                <paper-button id="rotate" on-tap="_applyrotation">Rotate</paper-button>
                <paper-button class="info-link" on-tap="_storetofb">STORE</paper-button>
                <div class="flex"></div>
                <paper-icon-button icon="close" on-click="_onBackClick"></paper-icon-button>
            </div>

        </div>

        <!--<paper-button class="info-link" on-click="_onBackClick">X</paper-button>-->
        <!--<paper-icon-button icon="close" on-click="_onBackClick"></paper-icon-button>-->

    </paper-card>

    <content>
    </content>    

</template>

    <script>
        Polymer({
            is: 'image-card',

            properties: {

                metadataset: {
                    type: Object
                },

                loadedimg: {
                    type: Object
                }, 

                editimg: {
                    type: Object
                }, 
                
                target : {
                    type: String,
                    observer: '_applytarget'
                }
            },

            behaviors: [
                Mbb.MapBehavior,
            ],

            observers: [
                '_applyimage(loadedimg.*)'
            ],

            attached: function() {
                // this.dataUsageChanged();
                // console.log("target attached");
            },

            // A. Basic 

            _applytarget : function(target) {
                if (!this.loadedimg || !this.loadedimg.location) {
                    this.location = target;
                }
            },

            // 
            _applyimage : function(img) { console.log("_Apply new image to FORM", img);
                
                var editimg = img.base; 

                var loc = "", geojson = "";
                if (editimg.location) {
                    geojson = JSON.stringify(editimg.location);
                    loc = JSON.stringify(editimg.location.geometry.coordinates); 
                    console.log("Image IS located at", loc) ; 
                    // disable the LOCATE button
                    this.$.locate.disabled = true; 
                } else {
                    this.$.locate.disabled = false; 
                    loc = this.target; 
                    console.log("Image MUST be located starting from ", loc) ; 
                }

                // 
                editimg.src = editimg.value;
                this.editimg = editimg; 
                this.geojson = geojson;
                this.location = loc;
            },

            // Add location-property to img-object
            _applylocation : function() {

                var imgname = this.editimg.name;

                function createGeojson(longlat) {
                    longlat = JSON.parse(longlat);

                    var geojson = {
                        "type" : "Feature",
                        "geometry" : {
                            "type" : "Point",
                            "coordinates": longlat
                        },
                        "properties" : {
                            "name": imgname 
                        }
                    };
                    return geojson;
                };

                var geojson = createGeojson(this.location); console.log("apply gjson=", geojson); 

                this.set('loadedimg.location', geojson);
            },

            // 
            _applyrotation : function() {
                var imgname = this.editimg.name;

            },    

            // 
            _storetofb : function() {
                console.log("STORING",this.editimg) ; 
            },

            _onBackClick : function(e) { 
                if (this.editimg.src)   this.set("editimg.src","");
                else                    this.set("editimg.src", this.editimg.value);
                // this.classList.add("hidden") 
            },



            // B. COMPILE Feature-data for OUTPUT
            /**
             * Create some formatted html-text(dom?) 
             * to identify basic properties of an animated object (animation status)
             *
             * @param      {<type>}  trackObj  The animated trackObj (as mb-feature)
             * @return     {string}  A formatted information about trackObj-status.
             */
            calcBasicInfo: function(trackObj) {
                if (!trackObj || !trackObj.properties) return;

                var trackInfo = "<b>" + trackObj.properties.id + "</b>" + "<br>";
                if (trackObj.properties.time) trackInfo += trackObj.properties.time + "<hr>";

                if (trackObj.properties.speed) trackInfo += "SOG: " + trackObj.properties.speed + " nds <br>";
                if (trackObj.properties.bearing) trackInfo += "Head: " + trackObj.properties.bearing + "Â°<hr>";

                return trackInfo;
            },

            /**
             * Build (app-specific) trackData extending the basic infoSet 
             * to enable enhanced presentation of trackObj
             *
             * @param      {<type>}  trackObj  The track object
             * @param      {<type>}  openFlag  The open flag
             * @return     {<type>}  The more track data.
             */
            calcExtendedInfo: function(trackObj, openFlag) {
                if (!trackObj || !trackObj.properties) return;

                var basicInfo = this.calcBasicInfo(trackObj);

                var extendedData = {
                    "title": trackObj.properties.title,
                    "html": basicInfo,
                    "properties": trackObj.properties
                };

                if (openFlag) {
                    extendedData.open = 1;
                }

                if (trackObj.properties.master) {
                    extendedData.headline = trackObj.properties.master.skipper;
                }
                // console.log("calcTrackData", trackObj, trackData)
                return extendedData;
            },

            // C.  FORMAT INFO-Card 

            refreshCardContent: function(data) {
                var nbsp = "&nbsp;"; //"~"; 
                if (!data) return;

                // if (data.properties && data.properties.master) {
                // var pp = JSON.parse(data.properties.master);
                if (this.masterdata && data.properties.id) {
                    // 
                    pp = this.masterdata[data.properties.id];
                    if (pp) {
                        // console.log("masterdata:", pp);
                        // DIV0
                        var imgurl = pp.img,
                            skipper = pp.skipper,
                            boat = pp.ship,
                            header = "";

                        if (imgurl) this.cardimgurl = "wp-data/" + imgurl;
                        // console.log("some data ", imgurl, this.cardimgurl, skipper, boat);

                        if (skipper && boat) {

                            // to show items with no line-breaks (fi. in flex-formatted cards)
                            // replace many spaces 
                            skipper = skipper.split(' ').join(nbsp);
                            boat = boat.split(' ').join(nbsp);
                            // statt: 
                            // skipper = skipper.replace(" ", nbsp);
                            // boat = boat.replace(" ", nbsp);

                            header = "<b>" + boat + "</b>" + "<br>" + skipper;

                            this.$.div0.innerHTML = header;
                        }
                    }
                }

                // DIV1
                if (data.html) this.$.div1.innerHTML = data.html;
            }

        });
    </script>

</dom-module>