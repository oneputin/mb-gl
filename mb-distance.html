<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="mb-api.html">
<link rel="import" href="mb-map-behavior.html">

<!--
`mb-distance`
wraps a distance utility 

@demo demo/routingtracks.html 
-->

<dom-module id="mb-distance">
    <template>
        
        <style>
            :host {
                display: block;
                position: absolute;
                z-index: 9;
                top: 0%;
                height: 2 em;

                /*left: 0%;*/
                left: 50%;
                margin-right: -50%;
                transform: translate(-50%, 0);

                font: 1 em Courier, Lucida;
                background-color: rgba(255,64,129,0.8); /*#ff4081*/
                color: white;                    
                /*opacity: 0.7;*/ /*related to all content bg,fg*/
            }

            #innerarea {
                padding: 0.2em;
            }
        </style>

        <div id='innerarea'>[[info]]</div>

    </template>

    <script>
        var distscope;

        Polymer({

            is: 'mb-distance',

            properties: {
                /**
                 *  map-object of related mb-gl-map
                 */
                map: {
                    type: Object//,
                },
                
                mbid: {
                    type: String,
                    observer: 'styleChanged'
                },

                // GeoJSON object to hold our measurement features
                geojson: {
                    type: Object,
                    value: {
                        "type": "FeatureCollection",
                        "features": []
                    }
                },

                // Used to draw a line between points
                linestring: {
                    type: Object,
                    value: {
                        "type": "Feature",
                        "geometry": {
                            "type": "LineString",
                            "coordinates": []
                        }
                    }
                },

                distance: {
                    type: Number,
                    notify: true
                },

                info: {
                    type: String,
                    observer: 'checkContent'
                },

                checked: {
                    type: Boolean,
                    value: true,
                    observer: "toggleMeasure"
                }
            },

            observers: [],

            attached: function() {
                // make this-scope available in named event-functions
                distscope = this;
            },

            checkContent: function(content) {
                // console.log("checkContent",content);
            },

            // refresh mapcontent on changed basemap
            styleChanged: function(mbid, mbidold) {
                if (this.checked) {
                    this.toggleMeasure(false);
                    this.toggleMeasure(true);                    
                }
            },

            // 
            toggleMeasure: function(checked) {
                if (!this.map) return;
                // console.log("toggleMeasure-1", this.map);
                var msg, distsrc, mousecursor;
                if (checked) {
                    msg = "measure toogled ON";
                    this._mousecursor = this.map.getCanvas().style.cursor; // console.log("_mousecursor", this._mousecursor); 
                    distsrc = this.resetThemes(checked);
                    this.map.on('click', this.clickFunction);
                    this.style.display = "block";
                } else {
                    msg = "measure toggled OFF";
                    this.map.off('click', this.clickFunction);
                    distsrc = this.resetThemes(checked);           
                    this.map.getCanvas().style.cursor = this._mousecursor;         
                    this.style.display = "none";
                }

                // clear context
                this.info = "click to measure";
                this.linestring.geometry.coordinates = [];
                this.geojson.features = [];
                distsrc.setData(this.geojson);
                // console.log("toggleMeasure-2", msg);
            },

            clickFunction: function(e) {
                // console.log("CLICK-ENTER", e, distscope);
                var map = distscope.map,
                    geojson = distscope.geojson,
                    linestring = distscope.linestring,
                    distance;

                var features = map.queryRenderedFeatures(e.point, {
                    layers: ['measure-points']
                });

                // Remove the linestring from the group
                // So we can redraw it based on the points collection
                if (geojson.features.length > 1) geojson.features.pop();

                // If a feature was clicked, remove it from the map
                if (features && features.length) {
                    var id = features[0].properties.id;
                    geojson.features = geojson.features.filter(function(point) {
                        return point.properties.id !== id;
                    });

                } else {

                    var point = {
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [
                                e.lngLat.lng,
                                e.lngLat.lat
                            ]
                        },
                        "properties": {
                            "id": String(new Date().getTime())
                        }
                    };

                    geojson.features.push(point);
                }

                if (geojson.features.length > 1) {

                    linestring.geometry.coordinates = geojson.features.map(function(point) {
                        return point.geometry.coordinates;
                    });

                    geojson.features.push(linestring);

                    distance = turf.lineDistance(linestring);

                    distscope.info = 'Total distance: ' + distance.toLocaleString() + 'km';
                }

                map.getSource('geojson').setData(geojson);
            },

            // 
            resetThemes: function(flag) {
                if (!this.map) return;
                var map = this.map;

                function distmouse (e) {
                    if (!map.getLayer('measure-points')) return; 
                    var features = map.queryRenderedFeatures(e.point, { layers: ['measure-points'] });
                    // UI indicator for clicking/hovering a point on the map
                    map.getCanvas().style.cursor = (features.length) ? 'pointer' : 'crosshair';
                }

                if (!map.getSource('geojson')) {
                    // console.log("this=", this);
                    map.addSource('geojson', {
                        "type": "geojson",
                        "data": this.geojson
                    });
                }

                if (flag) {  // Add styles to the map
                    map.addLayer({
                        id: 'measure-points',
                        type: 'circle',
                        source: 'geojson',
                        paint: {
                            'circle-radius': 5,
                            'circle-color': '#000'
                        },
                        filter: ['in', '$type', 'Point']
                    });
                    map.addLayer({
                        id: 'measure-lines',
                        type: 'line',
                        source: 'geojson',
                        layout: {
                            'line-cap': 'round',
                            'line-join': 'round'
                        },
                        paint: {
                            'line-color': '#000',
                            'line-width': 2.5
                        },
                        filter: ['in', '$type', 'LineString']
                    });
                    map.on('mousemove', distmouse);
                    // if (this.checked) map.on('click', this.clickFunction);
                } else {
                    map.off('mousemove', distmouse);
                    map.removeLayer("measure-points");
                    map.removeLayer('measure-lines');                    
                }

                return map.getSource('geojson');
            },

        });
    </script>
</dom-module>