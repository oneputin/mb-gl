<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="tracks-from-gpx.html">
<link rel="import" href="tracks-from-pnts.html">


<!--
`tracks-load`

component loads tracking data 
- from location sets of different formats
    - raw handheld (gps as gpx)
    - tabular handheld export (gps as csv)
    - tabular database export (vendee-tables)
- into different app-formats, = F(routemode)
    - 'log-formats' (map-lines, z-diagram, listing) 
    - 'trackdata-templates' (as required by routing-api)

@demo demo/routingtracks.html 
-->

<dom-module id="tracks-load">

    <template>

    <style is="custom-style">
        :host {
            display: none; /*inline-block;*/
            position: absolute;
            opacity: 1; 
            top: 50%;
            margin-bottom: -50%;
            transform: translate(0, -50%);
        }
    </style>

    <!-- IF's to alternatively formatted srces -->
    <tracks-from-pnts 
        srcmeta="[[srcmetad]]"        
        routemode="[[routemode]]"
        trackdata="{{_trackdata}}">
    </tracks-from-pnts>    

    <tracks-from-gpx 
        srcmeta="[[srcmetax]]"
        routemode="[[routemode]]"
        trackdata="{{_trackdata}}">
    </tracks-from-gpx>    

    <content>
    </content>    

</template>

    <script>
        Polymer({
            is: 'tracks-load',

            properties: {

                // OUT: TRACKS as static log conternt
                trackdata: {
                    type: Object,
                    notify: true
                },

                routemode: {
                    type: Boolean
                },

                /** metadata describing trackdata to load
                 *  
                 */
                tracksetmeta: {
                    type: Object,
                    notify: true
                },

                // raw data imported from different  
                _trackdata: {
                    type: Object
                },

            },

            behaviors: [
            ],

            observers: [
                '_requestManager(tracksetmeta.*, routemode)',
                '_responseManager(_trackdata)'
            ],

            attached: function() {
                // this._uxManager();
            },


            /** Prepares import of trackdata
             *  - from alternative low-level import-components (evaluates metadata)  
             *  - with structures dependent on routemode
             */
            _requestManager: function(srcmeta, routemode) {
                this.debounce("request", function() {  //console.log(srcmeta, routemode);
                    if (srcmeta.path == 'tracksetmeta') srcmeta = srcmeta.value;

                    var srcurl = srcmeta.url,      // 
                        srctype = srcmeta.type,    // 
                        srctitle = srcmeta.title;  // 

                    // Check some url - conditions ???
                    if (!srcurl) {
                        return;
                    } 

                    if (this.tracksetmeta && (srcurl != this.tracksetmeta.url)) {
                        //this.routecontent = [];
                        //this.trackdata = [];
                        srctitle = this.tracksetmeta.title;
                    } 

                    // Extend metadata with Query/Format - parameters
                    if ((srctype == "kml") || (srctype == "gpx")) {

                        srctype = "xml"; 
                        srcmeta.xmlquery = {};
                    
                        if (srctype == "gpx") {
                            // ALWAYS extract only tracks (neither waypoints or routes)
                            srcmeta.xmlquery = {
                                "tags": "Track",
                                "structure": "doc"
                            };                    
                        } 

                        // OPTIONAL: JOIN with user-defined query-expressions  
                        if (srcmeta.query) {  
                            srcmeta.xmlquery = Object.assign(srcmeta.xmlquery, srcmeta.query);
                        } 
                    }

                    // console.log("tracksetmeta. AFTER", srcmeta);
                    // this.tracksetmeta = srcmeta;
                    // trigger one of alternative import-elements
                    if (srctype == "xml")  this.srcmetax = srcmeta;
                    else                   this.srcmetad = srcmeta;
                }, 100);     
            },

            /** Return loaded tracks into alternative  
             *  Output-parameters 
             */    
            _responseManager : function(trackdata) {
                if (!trackdata) return; 
                console.log("CHECKOUT TrackData:", trackdata); 
                
                this.trackdata = trackdata;
                this._trackdata = null;
            },


        });
    </script>

</dom-module>