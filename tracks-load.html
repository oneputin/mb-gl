<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="tracks-from-gpx.html">
<link rel="import" href="tracks-from-pnts.html">


<!--
`tracks-load`

component loads tracking data 
- from location sets of different formats
    - raw handheld (gps as gpx)
    - tabular handheld export (gps as csv)
    - tabular database export (vendee-tables)
- into different app-formats
    - 'log-formats' (map-lines, z-diagram, listing) 
    - 'trackdata-templates' (as required by routing-api)

@demo demo/routingtracks.html 
-->

<dom-module id="tracks-load">

    <template>

    <style is="custom-style">
        :host {
            display: none; /*inline-block;*/
            position: absolute;
            opacity: 1; 
            top: 50%;
            margin-bottom: -50%;
            transform: translate(0, -50%);
        }
    </style>

    <!-- IF's to alternatively formatted srces -->
    <tracks-from-pnts 
        srcmeta="[[srcmetad]]"        
        logmode="[[logmode]]"
        trackdata="{{_trackdata}}">
    </tracks-from-pnts>    

    <tracks-from-gpx 
        srcmeta="[[srcmetax]]"
        logmode="[[logmode]]"
        trackdata="{{_trackdata}}">
    </tracks-from-gpx>    

    <content>
    </content>    

</template>

    <script>
        Polymer({
            is: 'tracks-load',

            properties: {

                // OUT: TRACKS as static log conternt
                rawcontent: {
                    type: Object,
                    notify: true
                },

                // OUT: Tracks as animatable content 
                routecontent: {
                    type: Object,
                    notify: true
                },

                /** metadata describing trackdata to load
                 *  
                 */
                tracksetmeta: {
                    type: Object
                    // notify: true
                },

                /** toggles preprocessing and out-format of rawdata
                 * - true: log-trace
                 * - false: animatable track
                 */
                logmode: {
                    type: Boolean,
                    value: true
                },

                // raw data imported from different  
                _trackdata: {
                    type: Object
                },

            },

            behaviors: [
            ],

            observers: [
                '_requestManager(tracksetmeta.*, logmode)',
                '_responseManager(_trackdata)'
            ],

            attached: function() {
                // this._uxManager();
            },


            /** Prepares import of trackdata
             *  from alternative low-level import-components (evaluates metadata)  
             */
            _requestManager: function(srcmeta, logmode) {
                if (srcmeta.path == 'tracksetmeta') srcmeta = srcmeta.value;
                // console.log("tracksetmeta. RAW=", srcmeta, logmode);

                var srcurl = srcmeta.url,      // 
                    srctype = srcmeta.type,    // 
                    srctitle = srcmeta.title;  // 

                // Check some url - conditions ???
                if (!srcurl) {
                    return;
                } 

                if (this.tracksetmeta && (srcurl != this.tracksetmeta.url)) {
                    //this.routecontent = [];
                    //this.rawcontent = [];
                    srctitle = this.tracksetmeta.title;
                } 

                // Extend metadata with Query/Format - parameters
                if ((srctype == "kml") || (srctype == "gpx")) {

                    srctype = "xml"; 
                    srcmeta.xmlquery = {};
                   
                    if (srctype == "gpx") {
                        // ALWAYS extract only tracks (neither waypoints or routes)
                        srcmeta.xmlquery = {
                            "tags": "Track",
                            "structure": "doc"
                        };                    
                    } 

                    // OPTIONAL: JOIN with user-defined query-expressions  
                    if (srcmeta.query) {  
                        srcmeta.xmlquery = Object.assign(srcmeta.xmlquery, srcmeta.query);
                    } 
                }

                // 
                let datasetlabel="Animated Tracks";
                if (logmode)  datasetlabel="Static TrackLogs";
                srcmeta['datasetlabel'] = datasetlabel;
 
                // console.log("tracksetmeta. AFTER", srcmeta);
                // this.tracksetmeta = srcmeta;
                // trigger one of alternative import-elements
                if (srctype == "xml")  this.srcmetax = srcmeta;
                else                   this.srcmetad = srcmeta;

            },

            /** Return loaded tracks into alternative  
             *  Output-parameters 
             */    
            _responseManager : function(trackdata) {
                if (!trackdata) return; 
                // console.log("checkOUT TrackData:", this.logmode,  trackdata); 
                if (this.logmode)   {
                    //console.log("_responseManager rawContent:", trackdata); 
                    this.rawcontent = trackdata;
                } else {
                    //console.log("_responseManager routeContent:", trackdata); 
                    this.routecontent = trackdata
                }
                this._trackdata = null;
            },

            /** APP/GUI-elemente anpassen, 
             *  die sich bei verschiedenartiger Nutzung derselben Grunddatan unterscheiden  
             */
            _uxManager : function(logmode) {
                let datasetlabel="Animated Logs";
                if (logmode == null) logmode = this.logmode; 
                if (logmode)  datasetlabel="Static Logs";
                this.tracksetmeta['datasetlabel'] = datasetlabel;
            },

        });
    </script>

</dom-module>