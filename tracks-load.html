<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="tracks-from-gpx.html">
<link rel="import" href="tracks-from-pnts.html">


<!--
`tracks-load`

component loads tracking data 
- from location sets of different formats
    - raw handheld (gps as gpx)
    - tabular handheld export (gps as csv)
    - tabular database export (vendee-tables)
- into different app-formats
    - 'log-formats' (map-lines, z-diagram, listing) 
    - 'trackdata-templates' (as required by routing-api)

@demo demo/routingtracks.html 
-->

<dom-module id="tracks-load">

    <template>

    <style is="custom-style">
        :host {
            display: none; /*inline-block;*/
            position: absolute;
            opacity: 1; 
            top: 50%;
            margin-bottom: -50%;
            transform: translate(0, -50%);
        }
    </style>

    <!-- IF's to alternatively formatted srces -->
    <tracks-from-pnts 
        srcmeta="[[srcmetad]]"        
        logmode="[[logmode]]"
        trackdata="{{_trackdata}}">
    </tracks-from-pnts>    

    <tracks-from-gpx 
        srcmeta="[[srcmetax]]"
        logmode="[[logmode]]"
        trackdata="{{_trackdata}}">
    </tracks-from-gpx>    

    <content>
    </content>    

</template>

    <script>
        Polymer({
            is: 'tracks-load',

            properties: {

                // OUT-tracks as static log conternt
                rawcontent: {
                    type: Object,
                    notify: true
                },

                // OUT-tracks as animatable content 
                routecontent: {
                    type: Object,
                    notify: true
                },

                /** metadata describing trackdata to load
                 *  
                 */
                tracksetmeta: {
                    type: Object
                    // notify: true
                },

                /** toggles preprocessing and out-format of rawdata
                 * - true: log-trace
                 * - false: animatable track
                 */
                logmode: {
                    type: Boolean,
                    value: true
                },

                // raw data imported from different  
                _trackdata: {
                    type: Object
                },

            },

            behaviors: [
            ],

            observers: [
                '_requestManager(tracksetmeta.*, logmode)',
                '_responseManager(_trackdata)'
            ],

            attached: function() {
                // this._uxManager();
            },


            /** Prepares import of trackdata
             *  from alternative low-level import-components (evaluates metadata)  
             */
            _requestManager: function(tracksetmeta, logmode) {
                if (tracksetmeta.path == 'tracksetmeta') tracksetmeta = tracksetmeta.value;
                // console.log("tracksetmeta. RAW=", tracksetmeta);

                var srcurl = tracksetmeta.url,      // 
                    srctype = tracksetmeta.type,    // 
                    srctitle = tracksetmeta.title;  // 

                // Check some url - conditions ???
                if (!srcurl) return;

                if (this.srcmeta && (srcurl != this.srcmeta.url)) {
                    //this.routecontent = [];
                    //this.rawcontent = [];
                    srctitle = this.srcmeta.title;
                } 

                // Extend metadata with Query/Format - parameters
                if ((srctype == "kml") || (srctype == "gpx")) {

                    srctype = "xml"; 
                    tracksetmeta.xmlquery = {};
                   
                    if (srctype == "gpx") {
                        // ALWAYS extract only tracks (neither waypoints or routes)
                        tracksetmeta.xmlquery = {
                            "tags": "Track",
                            "structure": "doc"
                        };                    
                    } 

                    // OPTIONAL: JOIN with user-defined query-expressions  
                    if (tracksetmeta.query) {  
                        tracksetmeta.xmlquery = Object.assign(tracksetmeta.xmlquery, tracksetmeta.query); 
                    } 
                }

                // console.log("tracksetmeta. AFTER", tracksetmeta);
                this.srcmeta = tracksetmeta;
 
                // trigger one of alternative import-elements
                if (srctype=="xml")  this.srcmetax = tracksetmeta;
                else                 this.srcmetad = tracksetmeta;

                let datasetlabel="Animated Logs";
                if (logmode)  datasetlabel="Static Logs";

                tracksetmeta['datasetlabel'] = datasetlabel;
            },

            /** Return loaded tracks into alternative  
             *  Output-parameters 
             */    
            _responseManager : function(trackdata) {
                // console.log("checkOUT TrackData:", this.logmode,  trackdata); 
                // console.log("_responseManager:", this.logmode, this.tracksetmeta, trackdata); 
                if (this.logmode)   {
                    this.rawcontent = trackdata;
                } else {
                    this.routecontent = trackdata
                }
            },

            /** APP/GUI-elemente anpassen, 
             *  die sich bei verschiedenartiger Nutzung derselben Grunddatan unterscheiden  
             */
            _uxManager : function(logmode) {
                let datasetlabel="Animated Logs";
                if (logmode == null) logmode = this.logmode; 
                if (logmode)  datasetlabel="Static Logs";
                this.tracksetmeta['datasetlabel'] = datasetlabel;
            },

        });
    </script>

</dom-module>