<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../google-chart/google-chart.html">
<link rel="import" href="mb-map-behavior.html">
<link rel="import" href="mb-content-behavior.html">
<link rel="import" href="mb-app-behavior.html">
<link rel="import" href="dynamic-menu.html">

<!--
`tracks-log`
presentation of track-properties (= selected feature) 

## Properties of *raw* data 
### elevation-log
- dropdown-menu of z-coords
- z(t)-line-chart (t as unix-h) 

### speed-log
- v(t)-line-chart

## Properties of *derived* data

@demo demo/routingtracks.html 
-->

<dom-module id="tracks-log">

    <template>

        <style>

            dynamic-menu {
               background-color: var(--paper-grey-300);
            }
            #zlog  {
                height: 400px;
                width: 100%;
            }

        </style>
    
        <h3 class="log" >Elevations on track  [[track]] </h3> 

        <google-chart
            id="zlog"
            type="line"
            selection="{{selected}}"
            options='{{chartoptions}}'
            cols='[{"label": "Time", "type": "number"},{"label": "Elev", "type": "number"}]'
            rows='[[zdata]]'>
        </google-chart>

        <dynamic-menu 
            id="zmenu"
            class="metadata"
            menulabel="z-track"
            menuitems="[[zitems]]"
            selectitem="{{zitem}}">
        </dynamic-menu>

        <div id="textcontent"> 
            <pre>{{log}}</pre>
            <pre>selection: {{selected}}</pre>
        </div>


    </template>

    <script>
        
        Polymer({
            is: 'tracks-log',

            properties: {

                metadata: {
                    type: Object
                },

                trackdata: {
                    type: Object,
                    notify: true,
                    observer: 'checkoutFeature'
                },

                log: {
                    type: String
                },
                
                selected: {
                    type: Object,
                    observer: 'toString'
                },

                zitems : {
                    type: Array
                },
                zitem: {
                    type: Object,
                    observer: 'toString' 
                },

                checked: {
                    type: Boolean,
                    value: true,
                    observer: "toggleElement"
                }
            },

            behaviors: [
                Mbb.AppBehavior,
                Mbb.ContentBehavior,
                Mbb.MapBehavior
            ],                

            observers: [
            ],

            ready: function() {
            },

            toggleElement: function(checked) {
                if (checked) {
                    this.style.display = "block";
                } else {
                    this.style.display = "none";
                }
            },    

            /**
             * Select/Hilite a feature on the map  (fi. zoomTo)
             * @param      {object}  f       { mapbox-jeature }
             */
            checkoutFeature: function(f) { 
                if (!f.feature) return;    
                // console.log("Selecting Feature: " + f.id , f);
                
                // A. generic map-select
                var selObj = this.featuresSelect([f.feature], f.layer);
                // console.log("Selected Feature: " + f.id , f, selObj);
                //console.log("Metadata of: " + f.layer , this.metadata);

                // B. Create a text-log
                var pp = f.feature.properties;   // console.log("Props of Selected F.", pp);
                
                var log = "["+f.id +"] in { "+ f.layer+" }"; 
                this.track = log; 

                this.createElevTrack(pp); 
            },

            // 
            createElevTrack: function(pp){
                var scope = this;
                var zitems = [], zitem, zdata = [];

                    times = pp["coordTimes"],
                    elevs = pp["coordZ"];

                // var sp = ":" + "&nbsp;" + "&nbsp;";
                var sp = String.fromCharCode(160),
                    delim = sp + sp +sp ;

                times.forEach(function(t, j){
                    let zeit = t.split("T")[1],
                        utc = scope.utcTime(scope.trackTime(t), "h"); 
                    zitem = {
                        "id" : j,
                        "title" : zeit + delim + elevs[j] + "[m]",
                        "utctime" : utc
                    }
                    zitems.push(zitem);
                })
                this.zitems = zitems; 


                scope.chartoptions = {
                    "title": "Track Elevations",
                    "width": 800,
                    "height": 500,
                    "legend": "none"
                };   

                var utc0;
                times.forEach(function(t, j){
                    let utc = scope.utcTime(scope.trackTime(t), "h"); 
                    if (j==0) utc0 = utc; 
                    zitem = [
                        utc-utc0,
                        elevs[j]                        
                    ]
                    zdata.push(zitem);
                })
                this.zdata = zdata; 

            },   

            toString : function(obj) {
                var str = JSON.stringify(obj); console.log("obj2string", str); 
                this.log = str; 
            }


        });
    </script>
</dom-module>