<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../google-chart/google-chart.html">
<link rel="import" href="mb-map-behavior.html">
<link rel="import" href="tracks-behavior.html">
<link rel="import" href="dynamic-menu.html">

<!--
`tracks-log`
presentation of track-properties (= selected feature) 

## Properties of *raw* data 
### elevation-log
- dropdown-menu of z-coords
- z(t)-line-chart (t as unix-h) 

### speed-log
- v(t)-line-chart

## Properties of *derived* data

@demo demo/routingtracks.html 
-->

<dom-module id="tracks-log">

    <template>

        <style>

            :host {
                display: block;
                position: absolute;
                z-index: 9;
                top: 0;
               
                left: 50%;
                margin-right: -50%;
                transform: translate(-50%, 0);

                font: 0.8em Courier, Lucida;
                background-color: rgba(255,64,129,0.8); /*#ff4081*/
                color: white;  
                 
                padding: 10px;
            }

            dynamic-menu {
               background-color: var(--paper-grey-300);
            }
            #zlog  {
                height: 400px;
                width: 100%;
            }
            #metaxa {
                color: blue;
            }

            #zmenu  {
                left: 50%;
                margin-right: -50%;
                transform: translate(-50%, 0);
                z-index: 99;
            }

        </style>
    
        <h3 class="log" >Elevations of track  <span id="meta">[[track]]</span> </h3> 

        <template is="dom-if" if="{{zdata}}">
            <dynamic-menu 
                id="zmenu"
                class="metadata"
                menulabel="z-track"
                menuitems="[[zitems]]"
                selectitem="{{zitem}}">
            </dynamic-menu>
        </template>
            
        <!--<pre><b>Selected MenuItem</b><br>{{menulog}}</pre>-->

        <template is="dom-if" if="{{zdata}}">
            <pre><b>Checking LogIndex/MenuIndex: </b>[[logindex]]---[[zitem.id]]</pre>
            <google-chart
                id="zlog"
                type="line"
                selection="{{chartselection}}"
                options='{{chartoptions}}'
                cols='[{"label": "Time", "type": "datetime"},{"label": "Elev", "type": "number"}]'
                rows='[[zdata]]'>
            </google-chart>
        </template>

        <div id="textcontent"> 
        </div>

    </template>

    <script>
        
        Polymer({
            is: 'tracks-log',

            properties: {

                metadata: {
                    type: Object
                },

                trackselected: {
                    type: Object,
                    notify: true,
                    observer: 'checkoutTrack'
                },

                menulog: {
                    type: String
                },
                
                logindex: {
                    type: Number
                },

                chartselection: {
                    type: Object,
                    observer: 'getchartselection'
                },

                zitems : {
                    type: Array
                },

                zitem: {
                    type: Object,
                    observer: 'getmenuselection' 
                },

                disable: {
                    type: Boolean,
                },

                checked: {
                    type: Boolean,
                    value: true,
                    observer: "toggleElement"
                }
            },

            behaviors: [
                Mbb.TracksBehavior,
                Mbb.MapBehavior
            ],                

            observers: [

            ],

            ready: function() {
                // console.log("ZITEMS:", this.zitems) 
            },

            toggleElement: function(checked) {
                if (checked) {
                    this.style.display = "block";
                } else {
                    this.style.display = "none";
                }
            },    

            getchartselection: function(chartpoints){
                console.log("getchartselection", chartpoints);
                this.logindex = chartpoints[0].row;
                this.zitem = this.zitems[this.logindex];
            },

            getmenuselection: function(menuitem){
                console.log("getmenuselection", menuitem);
                var chartpoints = [{
                    column: 1,
                    row: menuitem.id
                }];
                this.chartselection = chartpoints;
            },


            /**
             * Select/Hilite a feature on the map  (fi. zoomTo)
             * @param      {object}  f       { mapbox-jeature }
             */
            checkoutTrack: function(f) { 
                if (this.disable) return; 
                if (!f || !f.feature || !this.checked) return;    
                // console.log("Checkout Feature to LOG: " + f.id , f);
                
                // var selObj = this.featuresSelect([f.feature], f.layer);
                //console.log("Selected Feature: " + f.id , f, selObj);
                //console.log("Metadata of: " + f.layer , this.metadata);

                var pp = f.feature.properties;   console.log("TRACK selected", pp);
                if (!pp.coordZ) {
                    this.zdata = null;
                    return; 
                }

                // A. generic Track-identification
                var cnt = pp.coordZ.length;
                var log = "<a href=''>["+f.id +"]</a> (n="+cnt+")<br> in logbook <a href=''>{ "+ f.layer+" }</a>"; 
                this.$.meta.innerHTML = log;
                
                // B. Refresh Generic Track viewer(s) (Menu, Chart) 
                this.refreshElevChart(pp); 
                this.refreshElevMenu(pp); 

                // C.  
                // this.chartlog = JSON.stringify(pp);
            },

            // Refresh parameters of chart-element <google-chart>
            refreshElevChart: function(pp){
                var scope = this,
                    times = pp["coordTimes"],
                    elevs = pp["coordZ"];
                
                if (!times || !elevs || !times.length || !elevs.length) {
                    console.log("No data for elevetion-chart in ", pp); 
                    this.zdata = [];
                    return;
                } // console.log(times, elevs); 

                // B. Create Chart 
                // B.1 Setup ChartOptions
                scope.chartoptions = {
                    "title": "Track Elevations [m NN]",
                    "width": 800,
                    "height": 500,
                    "legend": "none"
                };   

                // B.2 Create TimeChart-data with argument in datetime-format
                var zdata = [];
                times.forEach(function(t, j){
                    let utc1970 = scope.utcTime(scope.trackTime(t)); 
                    zitem = [
                        new Date(utc1970),
                        elevs[j]                        
                    ]
                    zdata.push(zitem);
                })
                this.zdata = zdata; 
            },   

            // Refresh parameters of chart-element <google-chart>
            refreshElevMenu: function(pp){
                var scope = this,
                    times = pp["coordTimes"],
                    elevs = pp["coordZ"];
                
                if (!times || !elevs || !times.length || !elevs.length) {
                    console.log("No elev-data found in ", pp); 
                    this.zitems = [];
                    return;
                } // console.log(times, elevs); 

                // A. Create MenuItems  
                var zitems = [], zitem;
                var sp = String.fromCharCode(160), // &nbsp;
                    delim = sp + sp; //  +sp ;

                times.forEach(function(t, j){
                    let zeit = t.split("T")[1],
                        utc = scope.utcTime(scope.trackTime(t), "h"); 
                    zitem = {
                        "id" : j,
                        "title" : zeit + delim + elevs[j] + "[m]",
                        "utctime" : utc,
                        "elevation": elevs[j]
                    }
                    zitems.push(zitem);
                })
                this.zitems = zitems; 

            },   

            toString : function(obj) {
                var str = JSON.stringify(obj); // console.log("obj2string", str); 
                this.menulog = str; 
            }
        });
    </script>
</dom-module>