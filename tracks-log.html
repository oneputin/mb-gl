<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../google-chart/google-chart.html">
<link rel="import" href="mb-map-behavior.html">
<link rel="import" href="mb-app-behavior.html">
<link rel="import" href="dynamic-menu.html">

<!--
`tracks-log`
presentation of track-properties (= selected feature) 

## Properties of *raw* data 
### elevation-log
- dropdown-menu of z-coords
- z(t)-line-chart (t as unix-h) 

### speed-log
- v(t)-line-chart

## Properties of *derived* data

@demo demo/routingtracks.html 
-->

<dom-module id="tracks-log">

    <template>

        <style>

            :host {
                display: block;
                position: absolute;
                z-index: 9;
                top: 0;
                
                left: 50%;
                margin-right: -50%;
                transform: translate(-50%, 0);

                font: 0.8em Courier, Lucida;
                background-color: rgba(255,64,129,0.8); /*#ff4081*/
                color: white;   
            }

            dynamic-menu {
               background-color: var(--paper-grey-300);
            }
            #zlog  {
                height: 400px;
                width: 100%;
            }
            #metaxa {
                color: blue;
            }

        </style>
    
        <h3 class="log" >Properties of track  <span id="meta">[[track]]</span> </h3> 

        <google-chart
            id="zlog"
            type="line"
            selection="{{selected}}"
            options='{{chartoptions}}'
            cols='[{"label": "Time", "type": "datetime"},{"label": "Elev", "type": "number"}]'
            rows='[[zdata]]'>
        </google-chart>

        <!--<dynamic-menu 
            id="zmenu"
            class="metadata"
            menulabel="z-track"
            menuitems="[[zitems]]"
            selectitem="{{zitem}}">
        </dynamic-menu>-->

        <div id="textcontent"> 
            <pre>{{log}}</pre>
            <pre>selection: {{selected}}</pre>
        </div>


    </template>

    <script>
        
        Polymer({
            is: 'tracks-log',

            properties: {

                metadata: {
                    type: Object
                },

                trackselected: {
                    type: Object,
                    notify: true,
                    observer: 'checkoutTrack'
                },

                log: {
                    type: String
                },
                
                selected: {
                    type: Object,
                    observer: 'toString'
                },

                zitems : {
                    type: Array
                },
                zitem: {
                    type: Object,
                    observer: 'toString' 
                },

                disable: {
                    type: Boolean,
                },

                checked: {
                    type: Boolean,
                    value: true,
                    observer: "toggleElement"
                }
            },

            behaviors: [
                Mbb.AppBehavior,
                Mbb.MapBehavior
            ],                

            observers: [
            ],

            ready: function() {
            },

            toggleElement: function(checked) {
                if (checked) {
                    this.style.display = "block";
                } else {
                    this.style.display = "none";
                }
            },    

            /**
             * Select/Hilite a feature on the map  (fi. zoomTo)
             * @param      {object}  f       { mapbox-jeature }
             */
            checkoutTrack: function(f) { 
                if (this.disable) return; 
                if (!f || !f.feature) return;    
                // console.log("Checkout Feature to LOG: " + f.id , f);
                
                // A. generic map-select
                // var selObj = this.featuresSelect([f.feature], f.layer);
                //console.log("Selected Feature: " + f.id , f, selObj);
                //console.log("Metadata of: " + f.layer , this.metadata);

                // B. Create a text-log
                var pp = f.feature.properties;   // console.log("Props of Selected F.", pp);
                
                var log = "<a href=''>["+f.id +"]</a> in <a href=''>{ "+ f.layer+" }</a>"; 
                // this.track = log; 
                this.$.meta.innerHTML = log;

                this.refreshElevChart(pp); 
            },

            // Refresh parameters of chart-element <google-chart>
            refreshElevChart: function(pp){
                var scope = this,
                    times = pp["coordTimes"],
                    elevs = pp["coordZ"];
                
                if (!times || !elevs || !times.length || !elevs.length) {
                    console.log("No data for elevetion-chart in ", pp); 
                    this.zitems = [];
                    this.zdata = [];
                    return;
                } // console.log(times, elevs); 

                var zitems = [], zitem, zdata = [];
                var sp = String.fromCharCode(160), // &nbsp;
                    delim = sp + sp +sp ;

                times.forEach(function(t, j){
                    let zeit = t.split("T")[1],
                        utc = scope.utcTime(scope.trackTime(t), "h"); 
                    zitem = {
                        "id" : j,
                        "title" : zeit + delim + elevs[j] + "[m]",
                        "utctime" : utc
                    }
                    zitems.push(zitem);
                })
                this.zitems = zitems; 

                // Create Chart 
                scope.chartoptions = {
                    "title": "Track Elevations [m NN]",
                    "width": 800,
                    "height": 500,
                    "legend": "none"
                };   

                // create data with argument in datetime-format
                times.forEach(function(t, j){
                    let utc1970 = scope.utcTime(scope.trackTime(t)); 
                    zitem = [
                        new Date(utc1970),
                        elevs[j]                        
                    ]
                    zdata.push(zitem);
                })
                this.zdata = zdata; 
            },   

            toString : function(obj) {
                var str = JSON.stringify(obj); // console.log("obj2string", str); 
                this.log = str; 
            }
        });
    </script>
</dom-module>