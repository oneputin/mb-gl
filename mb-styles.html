<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="dynamic-menu.html">

<!--
`mb-styles`  
recieves or selects a style from menu  
- exports style-url

@demo demo/routingplanes.html 
-->
<dom-module id="mb-styles">

    <template>
        <style>
            :host {
                display: block;
                position: absolute;
                z-index: 9;
                top: 0;
                
                left: 50%;
                margin-right: -50%;
                transform: translate(-50%, 0);

                font: 0.8em Courier, Lucida;
                background-color: rgba(255,64,129,0.8); /*#ff4081*/
                color: white;   
            }
        </style>

        <iron-ajax
            auto
            url="[[_styleseturl]]"
            handle-as="json"
            on-response="_getStyles">
        </iron-ajax>

        <dynamic-menu
            menuitems="{{_styles}}"
            menulabel="MapStyles"
            selectprop="id"
            selectitem="{{_styleid}}">
        </dynamic-menu>

    </template>

    <script>

        Polymer({
            is: 'mb-styles',

            properties : {

                // IN: url of styles-collection or json-collection as string 
                styleset: {  
                    type: String,
                    observer: '_stylesetCtrl'
                    // value: "demo-styles.json"
                },

                checked: {
                    type: Boolean,
                    value: true,
                    observer: '_toggleVisibility'
                },

                // OUT: url of selected mapbox-style
                mapstyle : {  // external paramater  
                    type: String,
                    notify: true
                },

                selectable: {
                    type: Boolean,
                    notify: true
                },    
                // 
                _styleseturl : { 
                    type: String
                },
                // 
                _styleid : { 
                    type: String,
                    observer: 'switchStyle'
                },

                _styles: {
                    type: Array,
                    observer:'_stylesCheck'
                }
            },

            attached : function(){
                if (!this.checked) this._toggleVisibility(false);
            },

            _stylesCheck : function(styles){
                if (styles.length > 2) this.selectable = true;
                else this.selectable = false; 
                
                // if (styles.length) {  } 
            },

            _stylesetCtrl : function(styleset){
                this._styleseturl = styleset;
            },

            _getStyles: function(ajaxresponse) {
                if (!ajaxresponse || !ajaxresponse.detail) return;
                this._styles = ajaxresponse.detail.response;
            },

            // triggered from menu  
            switchStyle: function(styleid) {
                var styleurl;

                this._styles.some(function(s){
                    if (s.id == styleid) {
                        if (!s.owner) s.owner = "mapbox";
                        styleurl = 'mapbox://styles/' + s.owner +'/' + styleid ;
                        return true;
                    } 
                }); 

                if (styleurl && (this.mapstyle != styleurl)) {  // console.log("SWITCHSTYLE TO " + styleid, styleurl);
                    this.mapstyle = styleurl;
                }    
            },

            _toggleVisibility: function(checked) {

                if (checked==null) checked = this.checked;
                if (checked) {
                    if (this._styles &&  this._styles.length > 1) {
                        // console.log("showMe Styles", this._styles);
                        this.style.display = "block";
                    } else {
                        console.log("NO further styles available"); 
                    }    
                } else {
                    this.style.display = "none";
                }
            },


        });
    </script>

</dom-module>
