<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="dynamic-menu.html">

<!--
`mb-styles`  
selects and applies a style to actual map

@demo demo/routingplanes.html 
-->
<dom-module id="mb-styles">

    <template>
        <style>
            :host {
                display: block;
                position: absolute;
                z-index: 9;
                top: 0;
                
                left: 50%;
                margin-right: -50%;
                transform: translate(-50%, 0);

                font: 0.8em Courier, Lucida;
                background-color: rgba(255,64,129,0.8); /*#ff4081*/
                color: white;                    
            }
        </style>

        <iron-ajax
            auto
            url="[[stylesurl]]"
            handle-as="json"
            on-response="getStyles">
        </iron-ajax>

        <dynamic-menu
            menudata="{{styles}}"
            menulabel="MapStyles"
            selectprop="id"
            selectvalue="{{styleid}}">
        </dynamic-menu>

    </template>

    <script>

        Polymer({
            is: 'mb-styles',

            properties : {
                /*map: {
                    type: Object,
                    notify: true,
                    observer: 'setupTool'
                },*/

                // 
                mbversion: {
                    type: String,
                    value: '-v9'
                },

                stylesurl: {  // config-url
                    type: String,
                    value: "demo-styles.json"
                },

                styles: {
                    type: Array,
                },

                styleid : { // internal parameter
                    type: String,
                    observer: 'switchStyle'
                },

                mapstyle : {  // external paramater  
                    type: String,
                    notify: true
                },

                checked: {
                    type: Boolean,
                    value: true,
                    observer: 'toggleTool'
                }

            },

            attached : function(){
                if (!this.styles) {
                    this.styles = [{
                        id: "basic",
                        title: "basic"
                    }];
                }     
                if (!this.checked) this.toggleTool(false);
            },

            getStyles: function(ajaxresponse) {
                if (!ajaxresponse || !ajaxresponse.detail) return;
                this.styles = ajaxresponse.detail.response;
            },

            // 
            switchStyle: function(styleid) {
                //if (!this.map) return;  
                //console.log("Stylesheet BEFORE", this.map.style.stylesheet); 

                var styleurl,
                    mbversion = this.mbversion ;

                this.styles.some(function(s){
                    if (s.id == styleid) {
                        if (s.owner) {
                            styleurl = 'mapbox://styles/' + s.owner +'/' + styleid ;
                        } else { // owner = "mapbox"
                            styleurl = 'mapbox://styles/mapbox/' + styleid + mbversion;
                        }    
                        return true;
                    } 
                }); 

                if (styleurl) {  // console.log("stylesheet switched TO " + styleid, styleurl);
                    this.mapstyle = styleurl;
                    // this.map.setStyle(styleurl);
                }    
            },

            /*setupTool: function(){
                if (!this.map) return;
                this.toggleTool();
            },*/

            toggleTool: function(checked) {
                // if (!this.map) return;

                if (checked==null) checked = this.checked;
                // console.log("checked", checked);
                if (checked) {
                    this.style.display = "block";
                } else {
                    this.style.display = "none";
                }
            },


        });
    </script>

</dom-module>
