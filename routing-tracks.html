<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-ajax/iron-ajax.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-button/paper-button.html">

<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-card/paper-card.html">

<link rel="import" href="tracks-from-gpx.html">
<link rel="import" href="tracks-from-pnts.html">

<link rel="import" href="mb-map-behavior.html">


<!--
`routing-tracks`
Interface for import/export of tracking data from handheld gps-devices

IN: transfer raw handheld-data (of different formats)
--- into 'routedata-template' (dataformat required by routing-api-api)

OUT: RICH-content Info-card related to one selected feature,  
---  absolutely positioned as (mapbox-)map-overlay   

Mode-A: Can be vertically dragged & horizontally resized.  
Mode-B: Free drag   

To 'close' 
    - with click anywhere on the card
    - with click on specific "cancel"-button

@demo demo/routingtracks.html 
-->

<dom-module id="routing-tracks">

    <template>

    <style is="custom-style">
        :host {
            position: absolute;
            display: none; /*inline-block;*/
            opacity: 1; 
            top: 50%;
            margin-bottom: -50%;
            transform: translate(0, -50%);

            /*  */
            --paper-card-header-text: {
                padding: 8px;
                font-size: 12px;
                font-weight: 400;
            }
        }

        paper-card.info { 
            @apply(--layout-horizontal); 
            align-items: flex-start;
            --paper-card-header-color: #f00;
        }

        #div0 {
            font-size: 12px;
            font-weight: 400;
            border-bottom: 1px solid #e8e8e8;
            padding: 2px 2px;
        }
        .info-content {
            @apply(--layout-flex);
            float: left;
        }

        .card-image {
            width: 100px;
            height: 170px;
            background-color: red;
            background-size: cover;
        }

        .info-html { 
            color: var(--paper-grey-600); 
            opacity: 1;
        }
        
        .info-link { 
            color: var(--google-blue-500); 
        }

        paper-icon-button {
            background-color: var(--paper-light-blue-500);
        }

    </style>

    <!-- alternative srces -->
    <tracks-from-pnts 
        srcmeta="[[srcmeta]]"        
        previewmode="[[previewmode]]"
        trackdata = "{{routedata}}"
        quickmap="{{quickmapcontent}}">
    </tracks-from-pnts>    

    <tracks-from-gpx 
        srcmeta="[[srcmeta]]"
        previewmode="[[previewmode]]"
        trackdata="{{routedata}}"
        quickmap="{{quickmapcontent}}">
    </tracks-from-gpx>    

    <paper-card 
        heading="{{carddata.title}}" 
        image="{{cardimgurl}}" 
        class="info">

        <div class="info-content">

            <div class="card-content">

                <div id="div0"></div>

                <div id="div1" class="info-html">

                </div>

            </div>

            <div class="card-actions">
                <paper-button class="info-link">more...</paper-button>
            </div>

        </div>

        <!--<paper-button class="info-link" on-click="_onBackClick">X</paper-button>-->
        <!--<paper-icon-button icon="close" on-click="_onBackClick"></paper-icon-button>-->

    </paper-card>

    <content>
    </content>    

</template>

    <script>
        Polymer({
            is: 'routing-tracks',

            properties: {

                datasetlabel: {
                    type: String,
                    notify : true
                },
                //
                tracksrcmeta: {
                    type: Object
                },

                srcmeta: {
                    type: Object
                },

                routedata: {
                    type: Object,
                    value: [],
                    observer: '_checkPropObject',
                    notify: true
                },

                // 
                previewmode: {
                    type: Boolean,
                    observer: 'dataUsageChanged'
                },

                xmlurl: {
                    type: String
                },

                xmlquery: {
                    type: Object
                },

                jsonurl: {
                    type: String
                },

                quickmapcontent: {
                    type: Object,
                    notify: true
                }

            },

            behaviors: [
                Mbb.MapBehavior,
            ],

            observers: [
                'requestDispatcher(tracksrcmeta.*)'
            ],

            attached: function() {
                this.dataUsageChanged();
                // console.log("target attached");
            },

            _checkPropObject : function(routedata) {
                // console.log("_checkPropObject", routedata); 
            },

            // APP/GUI-elemente anpassen, 
            // die sich bei verschiedenartiger Nutzung derselben Grunddatan unterscheiden  
            dataUsageChanged : function(previewmode) {
                if (previewmode == null) previewmode = this.previewmode; 
                if (previewmode) {
                    this.datasetlabel="Raw Tracks"
                } else {
                    this.datasetlabel="Track Routes"
                }
            },

            clearSourceUsage : function() {
                this.routedata = [];
                var srcTitle = this.srcmeta.title;
            },

            // Evaluate RoutingSource-Object to trigger import of routedata
            // from different data-types 
            requestDispatcher: function(tracksrcmeta) {
                if (tracksrcmeta.path == 'tracksrcmeta') tracksrcmeta = tracksrcmeta.value;
                // console.log("requestDispatcher. BEFORE=", tracksrcmeta);

                var srcurl = tracksrcmeta.url,
                    srctype = tracksrcmeta.type,
                    srctitle = tracksrcmeta.title;

                // Check some url - conditions ???
                if (!srcurl) return;
                if (this.srcmeta && (srcurl != this.srcmeta.url)) {
                    this.clearSourceUsage();  // 
                } 

                if ((srctype == "kml") || (srctype == "gpx")) {
                    tracksrcmeta.xmlquery = {
                        "tags": "Track",
                        "structure": "doc"
                    };
                }
                // console.log("requestDispatcher. AFTER", tracksrcmeta);
                
                this.srcmeta = tracksrcmeta;
            },

            // B. COMPILE Feature-data 
            /**
             * Create some formatted html-text(dom?) 
             * to identify basic properties of an animated object (animation status)
             *
             * @param      {<type>}  trackObj  The animated trackObj (as mb-feature)
             * @return     {string}  A formatted information about trackObj-status.
             */
            calcBasicInfo: function(trackObj) {
                if (!trackObj || !trackObj.properties) return;

                var trackInfo = "<b>" + trackObj.properties.id + "</b>" + "<br>";
                if (trackObj.properties.time) trackInfo += trackObj.properties.time + "<hr>";

                if (trackObj.properties.speed) trackInfo += "SOG: " + trackObj.properties.speed + " nds <br>";
                if (trackObj.properties.bearing) trackInfo += "Head: " + trackObj.properties.bearing + "Â°<hr>";

                return trackInfo;
            },

            /**
             * Build (app-specific) trackData extending the basic infoSet 
             * to enable enhanced presentation of trackObj
             *
             * @param      {<type>}  trackObj  The track object
             * @param      {<type>}  openFlag  The open flag
             * @return     {<type>}  The more track data.
             */
            calcExtendedInfo: function(trackObj, openFlag) {
                if (!trackObj || !trackObj.properties) return;

                var basicInfo = this.calcBasicInfo(trackObj);

                var extendedData = {
                    "title": trackObj.properties.title,
                    "html": basicInfo,
                    "properties": trackObj.properties
                };

                if (openFlag) {
                    extendedData.open = 1;
                }

                if (trackObj.properties.master) {
                    extendedData.headline = trackObj.properties.master.skipper;
                }
                // console.log("calcTrackData", trackObj, trackData)
                return extendedData;
            },

            // C.  FORMAT INFO-Card 

            refreshCardContent: function(data) {
                var nbsp = "&nbsp;"; //"~"; 
                if (!data) return;

                // if (data.properties && data.properties.master) {
                // var pp = JSON.parse(data.properties.master);
                if (this.masterdata && data.properties.id) {
                    // 
                    pp = this.masterdata[data.properties.id];
                    if (pp) {
                        // console.log("masterdata:", pp);
                        // DIV0
                        var imgurl = pp.img,
                            skipper = pp.skipper,
                            boat = pp.ship,
                            header = "";

                        if (imgurl) this.cardimgurl = "wp-data/" + imgurl;
                        // console.log("some data ", imgurl, this.cardimgurl, skipper, boat);

                        if (skipper && boat) {

                            // to show items with no line-breaks (fi. in flex-formatted cards)
                            // replace many spaces 
                            skipper = skipper.split(' ').join(nbsp);
                            boat = boat.split(' ').join(nbsp);
                            // statt: 
                            // skipper = skipper.replace(" ", nbsp);
                            // boat = boat.replace(" ", nbsp);

                            header = "<b>" + boat + "</b>" + "<br>" + skipper;

                            this.$.div0.innerHTML = header;
                        }
                    }
                }

                // DIV1
                if (data.html) this.$.div1.innerHTML = data.html;
            }

        });
    </script>

</dom-module>