<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!--
`import-vendee`
transfer raw vendee-data 
into 'routedata' (dataformat required by mb-routes-api)

@demo demo/vendeemap.html 
-->
<dom-module id="import-vendee">

    <template>

        <iron-ajax
            auto
            url="[[url]]"
            handle-as="json"
            on-response="getrawdata">
        </iron-ajax>

        <iron-ajax
            auto
            url="[[starterurl]]"
            handle-as="json"
            on-response="getstarterdata">
        </iron-ajax>

    </template>

    <script>
        Polymer({
            is: 'import-vendee',
            properties: {

                routedata: {
                    type: Object,
                    notify: true
                },

                url: {
                    type: String
                },

                starterurl: {
                    type: String
                },
                rawdata: {
                    type: Object
                },
                starterdata: {
                    type: Object
                },

                wpicon: {
                    value: "lighthouse"
                },
                trackicon: {
                    value: "harbor"
                }
            },

            observers: [
                'importVendee(rawdata, starterdata)'
            ],

            /**
             * Load raw data via ajax
             *
             * @param      {<type>} ajaxresponse : Routedata as wp-dataset packaged in default ajax-response
             */
            getrawdata: function(ajaxresponse) {
                var rawdata = ajaxresponse.detail.response;
                if (!rawdata) return;
                // console.log("routedata", rawdata);
                this.rawdata = rawdata; // triggers 'setupTracking'
            },


            getstarterdata: function(ajaxresponse) {
                var rawdata = ajaxresponse.detail.response;
                if (!rawdata) return;
                // console.log("starterdata", rawdata);
                this.starterdata = rawdata; // triggers 'setupTracking'
            },

            // SPECIFIC import
            importVendee: function(rawdata, starterdata) {
                /**
                 *  transform digitaldegree to d-m with 3 digits (last digit ca 1-2m)
                 *  "maritime formatting"  
                 */
                // console.log(rawdata, starterdata);

                function dmtodd(dm, lonflag, prec) {
                    if (!prec) prec = 6;
                    dm = dm.split("Â°"); // console.log("dm-array", dm);
                    dd = parseInt(dm[0]) + parseFloat(dm[1]) / 60;
                    if (dm[1].slice(-1) == "W") dd = 0 - dd;
                    if (dm[1].slice(-1) == "S") dd = 0 - dd;
                    return dd;
                }


                // A. Redistribute raw starter-data and wp-records into temporary objects (starters, routes) 
                var routes = {},
                    starters = {},
                    route, starter, id;

                // A. Restructure starter-table into collection    
                starterdata.forEach(function(st, j) {
                    //  
                    id = st.id;
                    starter = starters[id];
                    if (!starter) {
                        starters[id] = st;
                    }
                }.bind(this));
                // console.log("starters", starters);

                // B. GROUP all posi-records by id in objects for every boat
                rawdata.forEach(function(wp, j) {
                    //  
                    var wpx = {},
                        lng, lat;
                    var pass = mba.utcTime(wp.date + "." + wp.time);
                    wpx.ab = pass;
                    wpx.an = pass;

                    lat = dmtodd(wp.lat);
                    lng = dmtodd(wp.lng);
                    wpx.coords = [lng, lat]; // { "lng": lng, "lat": lat };
                    wpx.icon = this.wpicon;

                    //  
                    id = wp.id;
                    route = routes[id];
                    if (!route) {
                        route = [];
                        routes[id] = route;
                    }
                    route.push(wpx);
                }.bind(this));

                // C. Join temporary starters- and routes-objects 
                //    into array of api-conform routes with wps sorted by time 
                var routedata = [];
                Object.keys(routes).forEach(function(id) {

                    var starter = starters[id];

                    var waypoints = routes[id];
                    waypoints.sort(function(wp1, wp2) {
                        return wp1.ab - wp2.ab;
                    });

                    /*************************
                     * Resolve original id 
                     * into better readable id and short-key
                     */
                    var key = id.split(">")[1];
                    id = id.replace("<br>", "/")
                        // *************************

                    var route = {
                        "id": id,
                        "key": key,
                        "obj": "ship",
                        "icon": this.trackicon,
                        "waypoints": waypoints,
                        "master": starter
                    };
                    routedata.push(route);
                }.bind(this));
                console.log("IMPORTED vendee-data", routedata); // , rawdata);
                this.routedata = routedata;
            }

        })
    </script>

</dom-module>