<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../google-chart/google-chart.html">
<link rel="import" href="mb-map-behavior.html">
<link rel="import" href="tracks-behavior.html">

<!--
`tracklog-view`
container for presentation of track-properties (fi. elevations) 

### Case: elevation-log
- z(t)-line-chart (t as unix-h) 

### speed-log
- v(t)-line-chart

## Properties of *derived* data

@demo demo/routingtracks.html 
-->

<dom-module id="tracklog-view">

    <template>

        <style>

            :host {
                display: block;
                position: absolute;
                z-index: 9;
                top: 0;
               
                left: 50%;
                margin-right: -50%;
                transform: translate(-50%, 0);

                font: 0.8em Courier, Lucida;
                background-color: rgba(255,64,129,0.8); /*#ff4081*/
                color: white;  
                 
                padding: 10px;
            }

            #zlog  {
                height: 400px;
                width: 100%;
            }

            #metaxa {
                color: blue;
            }
        </style>
        <template is="dom-if" if="{{zdata}}">
            <pre><b>Checking TP-Index: </b>[[logindex]]</pre>
            <google-chart
                id="zlog"
                type="line"
                selection="{{chartselection}}"
                options='{{chartoptions}}'
                cols='[{"label": "Time", "type": "datetime"},{"label": "Elev", "type": "number"}]'
                rows='[[zdata]]'>
            </google-chart>
        </template>

        <div id="textcontent"> 
        </div>

    </template>

    <script>
        
        Polymer({
            is: 'tracklog-view',

            properties: {

                metadata: {
                    type: Object
                },

                logdata: {
                    type: Array,
                    observer: 'checkindata'
                },

                logindex: {
                    type: Number,
                    observer: 'setChartSelection',
                    notify: true
                },

                chartselection: {
                    type: Object,
                    observer: 'getChartSelection'
                },

                disable: {
                    type: Boolean,
                },

                checked: {
                    type: Boolean,
                    value: true,
                    observer: "toggleElement"
                }
            },

            behaviors: [
                Mbb.TracksBehavior,
                Mbb.MapBehavior
            ],                

            observers: [

            ],

            ready: function() {
                // console.log("ZITEMS:", this.zitems) 
            },

            toggleElement: function(checked) {
                if (checked) {
                    this.style.display = "block";
                } else {
                    this.style.display = "none";
                }
            },    

            getChartSelection: function(chartpoints){
                // if (chartpoints[0].row) { 
                    // console.log("getChartSelection", chartpoints);
                    this.logindex = chartpoints[0].row;
                // }
            },

            // update selectionpoint(s) on chart 
            setChartSelection: function(logindex){
                var chartpoints = [{
                    column: 1,
                    row: logindex
                }]; // console.log("setChartSelection at " + logindex, chartpoints);
                this.chartselection = chartpoints;
            },


            /**
             * Select/Hilite a feature on the map  (fi. zoomTo)
             * @param      {object}  f       { mapbox-jeature }
             */
            checkindata: function(logdata) { 
                if (this.disable || !logdata) return; 
                // B. Refresh Generic Track viewer(s) (Menu, Chart) 
                this.refreshElevChart(logdata); 
            },

            // Refresh parameters of chart-element <google-chart>
            refreshElevChart: function(pp){
                var scope = this,
                    times = pp["coordTimes"],
                    elevs = pp["coordElevs"];
                
                if (!times || !elevs || !times.length || !elevs.length) {
                    console.log("No data for elevetion-chart in ", pp); 
                    this.zdata = [];
                    return;
                } // console.log(times, elevs); 

                // B. Create Chart 
                // B.1 Setup ChartOptions
                scope.chartoptions = {
                    "title": "Track Elevations [m NN]",
                    "width": 800,
                    "height": 500,
                    "legend": "none"
                };   

                // B.2 Create TimeChart-data with argument in datetime-format
                var zdata = [];
                times.forEach(function(t, j){
                    let utc1970 = scope.utcTime(scope.trackTime(t)); 
                    zitem = [
                        new Date(utc1970),
                        elevs[j]                        
                    ]
                    zdata.push(zitem);
                })
                this.zdata = zdata; 
            }   

        });
    </script>
</dom-module>