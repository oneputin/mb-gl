<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-fab/paper-fab.html">

<link rel="import" href="../google-chart/google-chart.html">
<link rel="import" href="tracks-behavior.html">

<!--
`tracklog-view`
container for presentation of track-properties (fi. elevations) 

### Case: elevation-log
- z(t)-line-chart (t as unix-h) 

### speed-log
- v(t)-line-chart

## Properties of *derived* data

@demo demo/routingtracks.html 
-->

<dom-module id="tracklog-view">

    <template>

        <style>

            :host {
                display: block;
                position: absolute;
            }

            #container {
                background-color: rgba(255,255,255,0.3); /*#ff4081*/
                @apply(--layout-vertical);

            }

            .chartctrls {
                @apply(--layout-horizontal);
            }

            .flexchild {
                @apply(--layout-flex);
            }


            .red {
                color: red;
                text-align: center;
                vertical-align: middle;
                height: 100%;
            }

            #chart {
                width: 100%;
                height: 100%;
            }

            #fab {
                display: block;
                position:absolute;
                right:5px;
                top:5px;
                opacity: 0.8;                 
            }

        </style>

        <template is="dom-if" if="{{zdata}}">

            <template is="dom-if" if="{{!checked}}">
                <paper-fab 
                    id = "fab" 
                    class = "fab" 
                    icon = "assessment" 
                    title = "heart" 
                    on-tap = "_toggleVisibility">
                </paper-fab>
            </template>

            <template is="dom-if" if="{{checked}}">
                
                <div id="container">

                    <div class="chartctrls">
                        <paper-icon-button icon="unfold-more" on-click="_toggle"></paper-icon-button>
                        <div class="flexchild red">[[logindex]]</div>
                        <paper-icon-button icon="close" on-click="_closer"></paper-icon-button>
                    </div>

                    <google-chart
                        id = "chart"
                        class = "flexchild"
                        type = "line"
                        cols = '[{"label": "Time", "type": "datetime"},{"label": "Elev", "type": "number"}]'
                        selection="{{chartselection}}"
                        options='[[chartoptions]]'
                        rows='[[zdata]]'>
                    </google-chart>


                </div>
            
            </template>

        </template>

    </template>

    <script>
        
        Polymer({
            is: 'tracklog-view',

            properties: {

                metadata: {
                    type: Object
                },

                trackfeature:{
                    type: Object,
                    observer: 'getQuickInfo'
                },

                logdata: {
                    type: Array // , observer: 'checkindata'
                },

                logindex: {
                    type: Number,
                    observer: 'setChartSelection',
                    notify: true
                },

                chartselection: {
                    type: Object,
                    observer: 'getChartSelection'
                },

                chartoptions: {
                    type: Object,
                    value : {
                        "title": "Track Elevations [m NN]",
                        "legend": "none",
                        "width": 100,
                        "height": 100
                    }     
                },

                minsize : {
                    type: Number,
                    value: 200
                },

                maxsize : {
                    type: Number,
                    value: 600
                },

                _issized: {
                    type: Boolean,
                    value : false,
                    observer : '_toggleSize'
                },

                disable: {
                    type: Boolean
                },

                checked: {
                    type: Boolean,
                    value: false,
                    notify : true
                }
            },

            behaviors: [
                Mbb.TracksBehavior,
            ],                

            observers: [
                'refreshLogChart(logdata, chartoptions)'
            ],

            attached: function() {
                this._toggleSize(50); 
                var w = Polymer.dom(this).parentNode.offsetWidth; // console.log(w);// window.innerWidth
                this.maxsize = w * 0.8; // + "px"; // 80vw"; // window.innerWidth * 0.8 
            },

            getQuickInfo: function(f){
                
            },
            
            _closer : function() {
                // this.checked = false;
                this._toggleVisibility(false); 
                this._issized = false;
            },

            _toggle : function() {
                this._issized = !this._issized;
            },

            _toggleSize: function(size) { 
                // debounce to enable _issized-flipflop
                var gchrt = this.$$("google-chart"); 
                
                this.debounce("size", function(){ // console.log("TOGGLESIZE", typeof size, size,  this._issized); // , typethis.chartoptions);                 
                    if (typeof size == "number") {
                        // use this size for chart
                    } else if (!this._issized) {
                        size = this.minsize;
                    } else {
                        size = this.maxsize;
                    }
                    this.set('chartoptions.width', size);
                    this.set('chartoptions.height', size);
                }, 50);
            },    

            // alternative visibility of control and container
            _toggleVisibility: function(flag) {                
                
                if (flag == null) flag = !this.checked; 
                if (!flag)  this._toggleSize(50);
                else {
                    this._issized = true;
                    this._issized = false;
                }
                this.checked = flag;
                return; 
            },    

            getChartSelection: function(chartpoints){
                // if (chartpoints[0].row) { 
                    // console.log("getChartSelection", chartpoints);
                    this.logindex = chartpoints[0].row;
                // }
            },

            // update selectionpoint(s) on chart 
            setChartSelection: function(logindex){
                var chartpoints = [{
                    column: 1,
                    row: logindex
                }]; // console.log("setChartSelection at " + logindex, chartpoints);
                this.chartselection = chartpoints;
            },

            // Refresh data and/or parameters of chart-element <google-chart>
            refreshLogChart: function(chartdata, chartoptions){
                if (this.disable || !chartdata) return;  // console.log("CHARTOPTIONS ::: ", chartdata, chartoptions); 
                var scope = this,
                    times = chartdata["coordTimes"],
                    elevs = chartdata["coordElevs"];
                
                if (!times || !elevs || !times.length || !elevs.length) {
                    console.log("No data for elevetion-chart in ", chartdata); 
                    this.zdata = [];
                    return;
                } // console.log(times, elevs); 

                // B. Create Chart 
                // B.1 Option: Update ChartOptions

                //this.chartoptions = {
                //};   

                // B.2 Create TimeChart-data with argument in datetime-format
                var zdata = [], utc1970;
                times.forEach(function(t, j){
                    utc1970 = scope.utcTime(scope.trackTime(t)); 
                    zitem = [
                        new Date(utc1970),
                        elevs[j]                        
                    ]
                    zdata.push(zitem);
                })
                this.zdata = zdata; 
            }   

        });
    </script>
</dom-module>