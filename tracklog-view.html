<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-fab/paper-fab.html">

<link rel="import" href="../google-chart/google-chart.html">
<link rel="import" href="tracks-behavior.html">

<!--
`tracklog-view`
container for presentation of track-properties (fi. elevations) 

### Case: elevation-log
- z(t)-line-chart (t as unix-h) 

### speed-log
- v(t)-line-chart

## Properties of *derived* data

@demo demo/routingtracks.html 
-->

<dom-module id="tracklog-view">

    <template>

        <style>

            :host {
                display: block;
                position: absolute;
                top: 0;
                right: 0; 
                z-index: 9;

                /* if to center 
                height: 50%;
                width: 50%;
                left: 50%;
                margin-right: -50%;
                transform: translate(-50%, 0); */

                font: 0.8em Courier, Lucida;
                /*background-color: rgba(255,64,129,0.8); */ /*#ff4081*/
                color: white;  
                 
                padding: 10px;
            }

            #logchart  {
                position : absolute;
                width: 100px;
                height: 100px;
            }

            .chartctrls {
                display: block;
                /*display: inline-block;
                position: absolute;*/
                @apply(--layout-horizontal);
                @apply(--layout-center);
                /*top: 12px;*/
                bottom : 5px;
                color : black;
                /*height : 50px;*/
                width: 100%;
                z-index: 99;
            }

            .flexchild {
                @apply(--layout-flex);
            }

            #metaxa {
                color: blue;
            }

            #container {
                display: block; /*none;*/
                position: relative;
                background-color: rgba(255,255,255,0.3); /*#ff4081*/
            }
            #control {
                display: block;
                position:absolute;
                right:5px;
                top:5px;
                opacity: 0.8;                 
            }

        </style>

        <template is="dom-if" if="{{zdata}}">

            <template is="dom-if" if="{{!checked}}">
                <paper-fab 
                    id = "control" 
                    class="fab" 
                    icon="assessment" 
                    title="heart" 
                    on-tap="_toggleVisibility">
                </paper-fab>
            </template>

            <template is="dom-if" if="{{checked}}">
                <div id="container">
                    <google-chart
                        id="logchart"
                        type="line"
                        cols='[{"label": "Time", "type": "datetime"},{"label": "Elev", "type": "number"}]'
                        selection="{{chartselection}}"
                        options='[[chartoptions]]'
                        rows='[[zdata]]'>
                    </google-chart>

                    <div class="chartctrls">
                        <pre class="flexchild"><b>Checking TP-Index: </b>[[logindex]]</pre>
                        <paper-icon-button icon="unfold-more" on-click="_toggle"></paper-icon-button>
                        <paper-icon-button icon="close" on-click="_closer"></paper-icon-button>
                    </div>
                </div>
            </template>

        </template>

    </template>

    <script>
        
        Polymer({
            is: 'tracklog-view',

            properties: {

                metadata: {
                    type: Object
                },

                logdata: {
                    type: Array // , observer: 'checkindata'
                },

                logindex: {
                    type: Number,
                    observer: 'setChartSelection',
                    notify: true
                },

                chartselection: {
                    type: Object,
                    observer: 'getChartSelection'
                },

                chartoptions: {
                    type: Object,
                    value : {
                        "title": "Track Elevations [m NN]",
                        "legend": "none",
                        "width": 100,
                        "height": 100
                    }     
                },

                minsize : {
                    type: Number,
                    value: 240
                },
                maxsize : {
                    type: Number,
                    value: 640
                },
                _maxsize: {
                    type: Boolean,
                    value : false,
                    observer : '_toggleSize'
                },

                disable: {
                    type: Boolean
                },

                checked: {
                    type: Boolean,
                    value: false,
                    //observer: "_toggleVisibility",
                    notify : true
                }
            },

            behaviors: [
                Mbb.TracksBehavior,
            ],                

            observers: [
                'refreshLogChart(logdata, chartoptions)'
            ],

            attached: function() {
                // console.log("ZITEMS:", this.zitems) 
                // this.$.zlog.redraw();
            },

            _closer : function() {
                // this.checked = false;
                this._toggleVisibility(false); 
            },

            _toggle : function() {
                this._maxsize = !this._maxsize;
            },

            _toggleSize: function() { // console.log("TOGGLE", this.chartoptions, this._maxsize); 
                
                if (!this._maxsize) {
                    this.style.width = this.minsize + "px";
                    this.style.height = this.minsize + "px";
                    this.set('chartoptions.width', this.minsize - 40);
                    this.set('chartoptions.height', this.minsize - 40);
                } else {
                    this.style.width = this.maxsize + "px";
                    this.style.height = this.maxsize + "px";
                    this.set('chartoptions.width', this.maxsize - 40);
                    this.set('chartoptions.height', this.maxsize - 40);
                }
            },    

            // alternative visibility of control and container
            _toggleVisibility: function(flag) {
                
                if (flag == null) flag = !this.checked; 
                this.checked = flag;
                return; 

                // old 
                var cont = this.$$("#container"),
                    ctrl = this.$$("#control"); 
                    //console.log(flag, cont.style, ctrl.style);
                if (flag) { console.log("SHOW", flag);
                    cont.style.display == "block";
                    ctrl.style.display == "none"
                    // this.style.display = "block";
                } else { console.log("HIDE", flag);
                    cont.style.display == "none";
                    ctrl.style.display == "block"
                    // this.style.display = "none";
                }
                this.updateStyles();
            },    

            getChartSelection: function(chartpoints){
                // if (chartpoints[0].row) { 
                    // console.log("getChartSelection", chartpoints);
                    this.logindex = chartpoints[0].row;
                // }
            },

            // update selectionpoint(s) on chart 
            setChartSelection: function(logindex){
                var chartpoints = [{
                    column: 1,
                    row: logindex
                }]; // console.log("setChartSelection at " + logindex, chartpoints);
                this.chartselection = chartpoints;
            },

            // Refresh data and/or parameters of chart-element <google-chart>
            refreshLogChart: function(chartdata, chartoptions){
                if (this.disable || !chartdata) return;  // console.log("CHARTOPTIONS ::: ", chartdata, chartoptions); 
                var scope = this,
                    times = chartdata["coordTimes"],
                    elevs = chartdata["coordElevs"];
                
                if (!times || !elevs || !times.length || !elevs.length) {
                    console.log("No data for elevetion-chart in ", chartdata); 
                    this.zdata = [];
                    return;
                } // console.log(times, elevs); 

                // B. Create Chart 
                // B.1 Option: Update ChartOptions

                //this.chartoptions = {
                //};   

                // B.2 Create TimeChart-data with argument in datetime-format
                var zdata = [];
                times.forEach(function(t, j){
                    let utc1970 = scope.utcTime(scope.trackTime(t)); 
                    zitem = [
                        new Date(utc1970),
                        elevs[j]                        
                    ]
                    zdata.push(zitem);
                })
                this.zdata = zdata; 
            }   

        });
    </script>
</dom-module>