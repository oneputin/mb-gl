<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="tracks-behavior.html">

<!--
`mb-dragpoint`
Draggable mb-point with optional snapping to mb-theme features 

@demo demo/slidemap.html 
-->

<dom-module id="mb-waypoint">

    <template>
    </template>

    <script>
        Polymer({
            is: 'mb-waypoint',

            properties: {

                mbid: {
                    type: Object,
                    observer: 'dragPointAdd'
                }, 

                // 
                lnglat: {
                    type: Object,
                    observer: 'dragPointGet'
                },

                // externally available
                coords: {
                    type: Array,
                    value : [0,0],
                    observer: 'dragPointRefresh',
                    notify: true                    
                },

                // 
                index: {
                    type: Number,
                    value : -1,
                    observer: 'indexedPointRefresh',
                    notify: true
                },

                // 
                indexedtarget: {
                    type: Object // ,   observer : 'indexedDataBuild'
                },

                allproperties : {
                    type: Array,
                    value:  ["coordElevs","coordTimes"]  // standard of trackLines
                },

                titleproperty: {
                    type: String,
                    value : "coordElevs"                    
                },

                // Array of indexed data
                indexeddata: {
                    type: Object
                },

                // 
                selectsymbol: {
                    type: String,
                    value : "toilet-15"                    
                },
                // 
                maptoast: {
                    type: String,
                    notify: true
                }
            },

            behaviors: [
                Mbb.TracksBehavior,
            ],

            observers: [
                'indexedDataBuild(indexedtarget.feature)',
                'dragPointGet(indexedtarget.lnglat)'
            ],

            // nearest geoJsonPoint 
            nearestPoint: function(targetPoint, points) {
              var dist, nearestPoint;
              points.features.forEach(function(pt) {
                var dist = distance(targetPoint, pt, 'miles');
                if(!nearestPoint) {
                  nearestPoint = pt;
                  nearestPoint.properties.distance = dist;
                } else {
                  if(dist < nearestPoint.properties.distance) {
                    nearestPoint = pt;
                    nearestPoint.properties.distance = dist;
                  }
                }
              });
              delete nearestPoint.properties.distance;
              return nearestPoint;
            },

            // index of nearest coords in coordList
            nearestCoord:function (targetCoords, coordList) {
              var targetPoint = turf.point(targetCoords),
                  pt, dist, nearestDist, nearestIndex;
              coordlist.forEach(function(coords, index) {
                pt = turf.point(coords);
                dist = turf.distance(targetPoint, pt, 'miles');
                if(nearestIndex == null) {
                  nearestDist = dist;
                  nearestIndex = index;
                } else {
                  if(dist < nearestDist) {
                    nearestIndex = index;
                    nearestDist = dist;
                  }
                }
              });
              return nearestIndex;
            }
        })
    </script>
</dom-module>
             