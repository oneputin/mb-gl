<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="icons-svg.html">

<!--
`mb-routes-ctrl-time`
slider ctrls to modify timing of animated objects

@demo demo/routemap.html 
-->

<dom-module id="mb-routes-ctrl-time">

    <template>
    
    	<style type="text/css">

            :host {
                display: inline-block;
                opacity: 1; 
            }
	        .ctrlbox {
                /*background-color: var(--paper-orange-500);
                opacity: 0.5;
                padding: 20px;*/
                @apply(--layout-vertical);
            }
            
            paper-slider {
                /*--paper-slider-bar-color: white;*/
                /*--paper-slider-container-color: yellow;*/
                border-style: solid;
                border-width: 1px;
                
                margin-bottom: 1em;
                --paper-slider-height: 5px;
            }
            
            paper-slider.scale {     
                --paper-slider-knob-color: var(--paper-red-500);
                --paper-slider-active-color: var(--paper-red-500);
            }

            paper-icon-button.blue {
                --paper-icon-button-ink-color: var(--paper-orange-500);
                background-color: var(--paper-light-blue-500);
                color: white;
                border-radius: 3px;
                padding: 2px;
                margin: 5px; 
            }

    	</style>
	
		<div class="ctrlbox"> 
            <h3>Animation setup</h3>
            <div>1min ~ [[scalestring]] reality</div>
            <div class="slider">
                <paper-slider id="scalectrl" class="scale" value="{{scaleslidervalue}}" on-change="scaleChangeHandler" min="1" max='10'></paper-slider>
            </div>

            <div>Throttle [[fpsvalue]][%]</div>
            <paper-slider id="fpsctrl" value="{{fpsvalue}}" on-change="fpsChangeHandler" min="10" max='100' step='10' pin ></paper-slider>

	    </div>

    </template>

    <script>
        // on-change="fpsChange"
        Polymer({
            is: 'mb-routes-ctrl-time',

            properties: {

                /**
                 * Max timescale foreseen for hosting app   
                 */
                timescalemax: {
                    type: Number,
                    value: 600,
                    observer: '_setupTimeCtrls'
                },

                // 
                timer: {
                    type: Object,
                    notify: true
                },

                /**
                 * Animation TimeScale
                 */
                _timescale: {
                    type: Number,
                    value: 600
                },

                /**
                 * Default Animation frequency of 'js5'  
                 */
                _fpsmax: {
                    type: Number,
                    value: 60
                },
                /**
                 * Applied animation frequency
                 */
                _fps: {
                    type: Number
                }

            },

            ready: function() {
                this._setupTimeCtrls();
            },

            observers: [
                'applyTimer(_timescale, _fps)'
            ],

            debouncedClickAction: function(e) {
                // will not call `processClick` more than once per 100ms
                this.debounce('click', function() {
                    this.processClick();
                }, 100);
            },


            applyTimer: function(timescale, fps) {

                this._formatscale(timescale);

                this.debounce('apply', function() {
                    if (!this.timer) {
                        this.timer = {};
                        this.set('timer.timescalemax', this.timescalemax);
                    }
                    this.set('timer.timescale', timescale);
                    this.set('timer.fpsmax', this._fpsmax);
                    this.set('timer.fps', fps);
                    console.log("applied timer", this.timer);
                }, 500);

            },

            // 
            fpsChangeHandler: function() {
                this._fps = this._fpsmax * this.fpsvalue / 100; //console.log("fps", fps)
            },

            scaleChangeHandler: function() {
                var timescale = this.scalemin * this.scaleslidervalue;
                console.log("new timescale", timescale);
                this._timescale = timescale;
            },

            resetTimeScale: function(timescalemax) {
                if (!timescalemax) timescalemax = 600; // 10 h
                this.scalemin = timescalemax / 10;

                //if (!this._timescale) 
                this.scaleslidervalue = 5;
                //else this.scaleslidervalue = Math.round(this._timescale / this.scalemin);

                this._timescale = this.scalemin * this.scaleslidervalue;
            },

            /**
             * Setup the Ctrl-actions (start/stop, restart, fps-slider) 
             *
             */
            _setupTimeCtrls: function(timescalemax) {
                if (!timescalemax) timescalemax = this.timescalemax;
                this.resetTimeScale(timescalemax);

                // fps-StartValues
                this.fpsvalue = 100;
                this._fps = this._fpsmax;
            },

            // readable presentation of timescale within this element  
            _formatscale: function(minutes) {
                if (!minutes) return;
                console.log("timescale[minutes] to format:", minutes);
                var h, m, s;
                if (minutes < 60) {
                    m = minutes;
                    this.scalestring = m + " min";
                } else if (minutes < 1440) {
                    h = Math.floor(minutes / 60);
                    m = minutes - (60 * h);
                    s = m ? h + " h, " + m + " min" : h + " h";
                    this.scalestring = s;
                } else {
                    this.scalestring = (minutes / 1440).toFixed(2) + " d";
                }

            }

        });
    </script>

</dom-module>

</dom-module>