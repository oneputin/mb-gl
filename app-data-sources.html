<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">

<link rel="import" href="mb-api.html">
<link rel="import" href="mb-tools-behavior.html">
<!--<link rel="import" href="mb-distance.html"> -->
<!--
`app-data-sources`
wraps a 1-3-step NOSQL-metadata-selection tool 
- loading an index of datasource-groups 
- selecting source-features from selected group
- subselection from list of source-features

@demo demo/routingplanes.html 
-->

<dom-module id="app-data-sources">

    <template>
        <style>
            :host {
                display: block;
                position: absolute;
                width: 600px;
            }

            paper-dropdown-menu {
                position: absolute;
                border-style: solid;
                border-width: 1px;
                padding: 10px;
                background-color: var(--paper-light-green-500);
                opacity: 0.8;
            }
            
            paper-dropdown-menu.datasets {
                left: 10px;
                top: 0px;
            }
            
            paper-dropdown-menu.routes {
                left: 300px;
                top: 0px;
            }
                
        </style>
        
        <iron-ajax 
            auto 
            url="[[indexurl]]" 
            handle-as="json" 
            on-response="setupme">
        </iron-ajax>

        <iron-ajax
            auto
            url="[[dataseturl]]"
            handle-as="json"
            on-response="_loadDataSetMeta">
        </iron-ajax>

        <div>
            <template is="dom-if" if="{{datasets}}">
                <paper-dropdown-menu class="datasets" label="{{datasetslabel}}">
                    <paper-listbox class="dropdown-content" selected="0" on-iron-select="_queryDataSetMeta" attr-for-selected="src">
                        <template is="dom-repeat" items="{{datasets}}">
                            <paper-item src="{{item}}" url="{{item.url}}">
                                {{item.title}}
                            </paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>
            </template>

            <!-- subselection a reference to one of thedataset-elements -->
            <template is="dom-if" if="{{_selectflag}}">
                <paper-dropdown-menu class="routes" label="{{routeslabel}}">
                    <paper-listbox class="dropdown-content" selected="0" on-iron-select="selectDataObj" attr-for-selected="id">
                        <template is="dom-repeat" items="{{_dataset}}">
                            <paper-item src="{{item}}" id="{{item.id}}">
                                {{item.title}}
                            </paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>
            </template>
        </div>   

    </template>

    <script>
        Polymer({
            is: 'app-data-sources',

            properties: {

                /**
                 * { item_description }
                 */
                indexurl: {
                    type: String
                },

                datasets: {
                    type: Array,
                },

                dataset: {
                    type: Array,
                    notify: true
                },

                dataid: {
                    type: String,
                    notify: true
                },



                _dataset: {
                    type: Array
                },

                _selectflag : {
                    type: Boolean,
                    value: false
                },
            },

            observers: [
                'toggleGui(dataset)'
            ],

            /**
             * Toggle a flag to Hide/Show the subselection - menu
             * if more than one dataobjects in active dataset
             *
             * @param      {<type>}  dataset  The dataset
             */
            toggleGui: function(dataset) {
                // console.log("toggleGui", data); 
                if (dataset.length > 1) {
                    this._selectflag = true;
                    _dataset = this.enhanceList(dataset);
                } else {
                    this._selectflag = false;
                    if (dataset.length) this.dataid = dataset[0].id;
                }    
            },

            enhanceList: function(dataset) {
                var dset = [];
                dataset.forEach(function(d){
                    dset.push(d);
                }) 
                dset.push({id:"all",title:"Select all"});
                dset.push({id:"clear",title:"Clear all"});
                this._dataset = dset; 
            }, 

            /**
             * Load datagroup-metas 
             * Optionally preselect first group 
             *
             * @param      {<type>}  ajaxresponse  The ajaxresponse
             */
            setupme : function(ajaxresponse) {
                var datasetmetas = ajaxresponse.detail.response,
                    datasetmeta = datasetmetas[0];
                // console.log("all datasets and first in dataindex", datasets, dataset);
                if (datasetmetas.length > 1) {
                    this.datasets = datasetmetas; // 
                    datasetmetas.some(function(rs) {
                        if (rs.start) {
                            datasetmeta = rs;
                            return true;
                        }
                    });

                } // console.log("dataset marked as 'START'", dataset);
                this.dataseturl = datasetmeta.url; // TRIGGER 
            },

            /**
             * Query / Load meta for a dataSet.
             *
             * @param      {<type>}  e       { parameter_description }
             */
            _queryDataSetMeta : function(e) {
                // console.log("YYY _queryDataSetMeta", e.detail.item.src); //this.importurl = e.detail.item.url;
                var datasetsitem = e.detail.item.src;
                this.dataseturl = datasetsitem.url; // TRIGGER 
            },
            // Ajax-responses
            _loadDataSetMeta: function(ajaxresponse) {
                if (!ajaxresponse || !ajaxresponse.detail) return;
                // console.log("loadRawDataSet", ajaxresponse.detail.response);
                this.dataset = ajaxresponse.detail.response;
            },

            /**
             * Select an item of active dataset
             * Return the id into property-IF
             *
             * @param      {<type>}  e       { parameter_description }
             */
            selectDataObj : function(e) {
                // console.log("selectDataObj", e.detail.item.id)
                this.dataid = e.detail.item.id;
            }

        })
    </script>
</dom-module>