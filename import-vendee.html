<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!--
`import-vendee`
transfer raw vendee-data 
into dataformat required by mb-routes-api

@demo demo/vendeemap.html 
-->
<dom-module id="import-vendee">

    <template>

        <iron-ajax
            auto
            url="[[url]]"
            handle-as="json"
            on-response="getrawdata">
        </iron-ajax>

        <iron-ajax
            auto
            url="[[starterurl]]"
            handle-as="json"
            on-response="getstarterdata">
        </iron-ajax>

    </template>

    <script>
        Polymer({
            is: 'import-vendee',
            properties: {
                url: {
                    type: String
                },
                starterurl: {
                    type: String
                },
                rawdata: {
                    type: Object
                },
                starterdata: {
                    type: Object
                },

                routedata: {
                    type: Object,
                    notify: true
                },
                wpicon: {
                    value: "lighthouse"
                },
                trackicon: {
                    value: "harbor"
                }
            },

            observers: [
                'importVendee(rawdata, starterdata)'
            ],

            /**
             * Setup of animation framework from new track(wp)-dataset
             *
             * @param      {<type>}  routedata  Routedata as wp-dataset
             */
            getrawdata: function(ajaxresponse) {
                var rawdata = ajaxresponse.detail.response;
                if (!rawdata) return;
                // console.log("routedata", rawdata);
                this.rawdata = rawdata; // triggers 'setupTracking'
            },

            getstarterdata: function(ajaxresponse) {
                var rawdata = ajaxresponse.detail.response;
                if (!rawdata) return;
                // console.log("starterdata", rawdata);
                this.starterdata = rawdata; // triggers 'setupTracking'
            },

            // SPECIFIC import
            importVendee: function(rawdata, starterdata) {
                /**
                 *  transform digitaldegree to d-m with 3 digits (last digit ca 1-2m)
                 *  "maritime formatting"  
                 */
                // console.log(rawdata, starterdata);

                function dmtodd(dm, lonflag, prec) {
                    if (!prec) prec = 6;
                    dm = dm.split("Â°"); // console.log("dm-array", dm);
                    dd = parseInt(dm[0]) + parseFloat(dm[1]) / 60;
                    if (dm[1].slice(-1) == "W") dd = 0 - dd;
                    if (dm[1].slice(-1) == "S") dd = 0 - dd;
                    return dd;
                }


                // A. Redistribute raw starter-data and wp-records into temporary objects (starters, routes) 
                var routes = {},
                    starters = {},
                    route, starter, id;

                starterdata.forEach(function(st, j) {
                    //  
                    id = st.ID;
                    starter = starters[id];
                    if (!starter) {
                        starters[id] = st;
                    }
                }.bind(this));
                // console.log("starters", starters);

                rawdata.forEach(function(wp, j) {
                    //  
                    var wpx = {},
                        lng, lat;
                    var pass = mba.utcTime(wp.Date + "." + wp.Time);
                    wpx.ab = pass;
                    wpx.an = pass;

                    lat = dmtodd(wp.Lat);
                    lng = dmtodd(wp.Lng);
                    wpx.coords = [lng, lat]; // { "lng": lng, "lat": lat };
                    wpx.icon = this.wpicon;

                    //  
                    id = wp.ID;
                    route = routes[id];
                    if (!route) {
                        route = [];
                        routes[id] = route;
                    }
                    route.push(wpx);
                }.bind(this));

                // B. reformat temporary routes-object 
                // into array of api-conform routes with wps sorted by time 
                var routedata = [];
                Object.keys(routes).forEach(function(id) {
                    var waypoints = routes[id];
                    waypoints.sort(function(wp1, wp2) {
                        return wp1.ab - wp2.ab;
                    });

                    var starter = starters[id];

                    var key = id.split(">")[1];
                    id = id.replace("<br>", "/")
                    var route = {
                        "id": id,
                        "key": key,
                        "obj": "ship",
                        "icon": this.trackicon,
                        "waypoints": waypoints,
                        "starter": starter
                    };
                    routedata.push(route);
                }.bind(this));
                console.log("IMPORTED vendee-data", routedata); // , rawdata);
                this.routedata = routedata;
            }

        })
    </script>

</dom-module>