<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="icons-svg.html">
<link rel="import" href="mb-app-behavior.html">

<!--
`timer-setup`
Setup/modify timescale-parameters  fi. for animations  
- `timescalemax` ctrls "basic scale" of time variation (should be passed in by app-shell) 
used to create the animation dataset from raw data 
- `throttle` varies basic-timescale, introducing additional delays after execution of every time-step,    
can be remote-controlled 'step'-wise  
ctrls are compiled and exported as `timer`-properties: timescale, timescalemax, fps, fpsmax     

@demo demo/routemap.html 
-->

<dom-module id="timer-setup">

    <template>
    
    	<style type="text/css">

            :host {
                display: inline-block;
                opacity: 1; 
            }
	        .ctrlbox {
                /*background-color: var(--paper-orange-500);
                opacity: 0.5;
                padding: 20px;*/
                @apply(--layout-vertical);
            }
            
            paper-slider {
                /*--paper-slider-bar-color: white;*/
                /*--paper-slider-container-color: yellow;*/
                border-style: solid;
                border-width: 1px;
                
                margin-bottom: 1em;
                --paper-slider-height: 5px;
            }
            
            paper-slider.scale {     
                --paper-slider-knob-color: var(--paper-red-500);
                --paper-slider-active-color: var(--paper-red-500);
            }

            paper-icon-button.blue {
                --paper-icon-button-ink-color: var(--paper-orange-500);
                background-color: var(--paper-light-blue-500);
                color: white;
                border-radius: 3px;
                padding: 2px;
                margin: 5px; 
            }

    	</style>
	
		<div class="ctrlbox"> 
            <h3>Animation scales (1 minute)</h3>
            <div>Max: [[maxscalestring]]</div>
            <div class="slider">
                <paper-slider id="scaleslider" class="scale" value="{{scaleslidervalue}}" on-change="scaleChangeHandler" min="1" max='10'></paper-slider>
            </div>

            <!--<div>Active: [[fpsslidervalue]][%]</div>-->
            <div>Active: [[scalestring]]</div>
            <paper-slider id="fpsslider" value="{{fpsslidervalue}}" immediate-value="{{fpsslidervalue}}" on-immediate-value-change="fpsChangeHandler" on-value-change="fpsChangeHandler" min="1" max='[[fpsslidermax]]' step='1'></paper-slider>


            <div>TraceLength: [[tracescale]]</div>
            <paper-slider id="tracectrl" value="{{traceslidervalue}}" immediate-value="{{traceslidervalue}}" on-immediate-value-change="traceChangeHandler" on-value-change="traceChangeHandler" min="1" max='[[traceslidermax]]' step='1'></paper-slider>


	    </div>

    </template>

    <script>
        // on-change="fpsChange"
        Polymer({
            is: 'timer-setup',

            properties: {

                /**
                 * collection of timer-properties usable to ctrl 
                 */
                timer: {
                    type: Object,
                    notify: true
                },

                /**
                 * IN: max fps-slider-value (decides about "slider-granularity") 
                 */
                fpsslidermax: {
                    type: Number,
                    value: 12
                },

                /**
                 * Max timescale foreseen for hosting app   
                 */
                timescalemax: {
                    type: Number
                },

                metadataset : {
                    type: Object
                },

                starttimer : {
                    type: Object
                },

                /**
                 * TimeScale of animation (real-minutes per animation-minute)
                 */
                _timescale: {
                    type: Number,
                    value: 600
                },

                /**
                 * Default Animation frequency of `requestAnimationFrame`  
                 */
                _fpsmax: {
                    type: Number,
                    value: 60
                },

                /**
                 * Animation frequency used to slow-down animation (if < fpsmax)
                 */
                _fps: {
                    type: Number
                },

            },

            behaviors: [
                Mbb.AppBehavior,
            ],

            observers: [
                'applyTimer(_timescale, _fps)',
                'setThrottle(timer.ctrl)',
                '_setupTimeCtrls(timer.timescalemax)',
                '_setupTimer(starttimer, metadataset.timer)'
            ],

            ready: function(){
                var metadataset = {}; 
                // if (this.metadataset && this.metadataset.timer) metadataset = this.metadataset;
                this._setupTimer(this.starttimer, this.metadataset.timer);
                // this._setupTimeCtrls(this.timer.timescalemax);
            },

            // BASIC setup for every geo-dataset with a time-variability 
            _setupTimer: function(starttimer, metadatatimer) {
                // from Timer-Setup in app-shell-context  and/or  from metadata

                this.debounce('setup', function() {
                    console.log("_setupTimer: BASIC from",  metadatatimer, starttimer);
                    
                    this.timer = {}

                    var timer = {};

                    if (starttimer && Object.keys(starttimer).length) {
                        timer = this.objectClone(starttimer);
                    }    

                    if (metadatatimer && Object.keys(metadatatimer).length) {
                        timer = Object.assign({}, timer, metadatatimer);
                    } 

                    this.timer = this.objectClone(timer);  console.log("SETUP timer as:", timer);

                    this._setupTimeCtrls(this.timer.timescalemax);

                }, 200);      

            },    

            /**
             * Setup the Ctrl-actions (start/stop, restart, fps-slider) 
             *
             */
            _setupTimeCtrls: function(timescalemax) {

                if (!timescalemax) return; 
                this.debounce('setupctrls', function() {
                    // A. Initial timescale
                    // 
                    if (!this.timer.timescalestart) {
                        this.timer.timescalestart = timescalemax; // was / 2; 
                    }    
                    // this._resetTimeScale(timescalemax, this.timer.timescalestart);

                    this.scalemin = timescalemax / 10;

                    this.scaleslidervalue = 10 * this.timer.timescalestart / timescalemax;

                    this._timescale = this.scalemin * this.scaleslidervalue;

                    // B. Initial value of fps-throttle 
                    //    NO throttle fps = 60

                    if (!this.timer.fpsstart) {
                        this.timer.fpsstart = this._fpsmax; //  / 2;
                    }

                    this.fpsslidervalue = this.timer.fpsstart / this._fpsmax * this.fpsslidermax;
                    
                    this._fps = this._fpsmax * this.fpsslidervalue / this.fpsslidermax; //console.log("fps", fps)

                    console.log("_setupTimeCtrls-FINISHED from ", this._timescale, this._fps ); 
                }, 200);     
            },



            /**
             * Processes remotecontrol events for scale-throttle
             *
             * @param      {string}  ctrl    remote-event key
             */
            setThrottle: function(ctrl) {
                if (!ctrl) return;
                var throttle = this.$.fpsslider;
                if (ctrl == "up") {
                    throttle.increment();
                }
                if (ctrl == "down") {
                    throttle.decrement();
                }
            },

            /**
             * Setup/Change timer properties with notify-power 
             *
             * @param      {<type>}  timescale  Timescale of animation
             * @param      {<type>}  fps        Optional animation-throttle
             */
            applyTimer: function(timescale, fps) {

                this.maxscalestring = this._formatscale(timescale);

                this.debounce('apply', function() {

                    if (!this.timer) {
                        this.timer = {};
                        this.set('timer.timescalemax', this.timescalemax);
                        this.set('timer.fpsmax', this._fpsmax);
                    }

                    this.set('timer.timescale', timescale);
                    this.set('timer.fps', fps);
                    console.log("TIMER REFRESHED", this.timer);

                    this.maxscalestring = this._formatscale(timescale);
                    this.scalestring = this._formatscale(timescale * fps / this._fpsmax);
                    console.log("Time-Scales (max, actual):", this.maxscalestring, this.scalestring);
                }, 100);

            },

            /**
             * Event-handler of throttle-slider 
             */
            fpsChangeHandler: function() {
                if (!this.fpsslidervalue) return;
                // console.log("set fps for sliderval", this.fpsslidervalue);
                var fps = Math.round(this._fpsmax * this.fpsslidervalue / this.fpsslidermax); // console.log("fps", fps)

                this.scalestring = this._formatscale(this._timescale * fps / this._fpsmax);

                this._fps = fps;
            },

            /**
             * Event-handler of timescale-slider 
             */
            scaleChangeHandler: function() {
                console.log("set timescale for sliderval", this.scaleslidervalue);
                this._timescale = this.scalemin * this.scaleslidervalue; // console.log("new timescale", this.timescale);
            },

            /**
             * Event-handler of Duration-slider 
             */
            traceChangeHandler: function() {
                if (!this.traceslidervalue) return;
            },



            /**
             * Create readable presentation of a "minutes-timescale"   
             * as scalestrings
             * @param      {number}  minutes  Number of unix-minutes (since 1970)
             */
            _formatscale: function(minutes) {
                if (!minutes) return;
                // console.log("timescale[minutes] to format:", minutes);
                var h, m, s, scalestring;
                if (minutes < 60) {
                    m = minutes;
                    scalestring = m + " min";
                } else if (minutes < 1440) {
                    h = Math.floor(minutes / 60);
                    m = minutes - (60 * h);
                    s = m ? h + " h, " + m + " min" : h + " h";
                    scalestring = s;
                } else {
                    scalestring = (minutes / 1440).toFixed(2) + " d";
                }
                return scalestring;
            }

        });
    </script>

</dom-module>

</dom-module>