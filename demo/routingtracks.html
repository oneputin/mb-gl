<!doctype html>
<html>
<head>
    <title>routing-tracks demo</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
   
    <!-- web-components required for dev-gui --> 
    <link rel="import" href="../../iron-demo-helpers/demo-pages-shared-styles.html">
    <link rel="import" href="../../iron-demo-helpers/demo-snippet.html">
    <link rel="import" href="../../paper-styles/demo-pages.html">
   
    <!-- web-components applied for app-gui --> 
    <link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
    <link rel="import" href="../../iron-collapse/iron-collapse.html">
    <link rel="import" href="../../paper-radio-button/paper-radio-button.html">

    <!-- app-components related to map-api --> 
    <link rel="import" href="../mb-map.html">
    <link rel="import" href="../mb-location-log.html">
    <link rel="import" href="../mb-styles.html">
    <link rel="import" href="../mb-distance.html">
    <link rel="import" href="../mb-orientation-ctrl.html">

    <!-- generic components for app-content-ctrl -->
    <link rel="import" href="../mb-content-browser.html"> 
    <link rel="import" href="../mb-content-manager.html">
    <!--<link rel="import" href="../mb-content-select.html">-->

    <!-- generic animation components -->
    <link rel="import" href="../routing-api.html">
    <link rel="import" href="../timer-ctrl.html">
    <link rel="import" href="../timer-setup.html">

    <!-- specific animation components for some datasources -->
    <link rel="import" href="../tracks-info.html">
    <link rel="import" href="../tracks-api.html">
    <link rel="import" href="../tracks-load.html">
    <link rel="import" href="../layer-waypoints.html">
    <link rel="import" href="../track-log-ctrl.html">
    <link rel="import" href="../track-log-view.html">

    <link rel="import" href="../mb-dragpoint.html">

    <style is="custom-style">
        .container {
            @apply(--layout-horizontal);
            /*align-items: flex-start;*/
        }
        
        .content_area {
            width: 800px;
            height: 670px;
        }

        mb-map {
            /*width: 55%;*/
            width: 800px;
            height: 670px;
        }
        
        .ctrls-in-map {
            display: inline-block;
            position: absolute;
            @apply(--layout-horizontal);
            @apply(--layout-center);
            bottom: 12px;
            width: 100%;
        }
        
        .ctrls_out {
            /* itself flex layouted div */
            width: 40%;
            margin-left: 10px;
            @apply(--layout-vertical);
            /*@apply(--layout-start);*/
        }

        .flexchild {
            @apply(--layout-flex);
        }
        
        timer-ctrl {
            @apply(--layout-flex);
        }
        
        mb-orientation-ctrl {
            /*@apply(--layout-flex);*/
        }
        
        timer-setup {
            display: none;
            border-style: solid;
            border-width: 1px;
            padding: 10px;
            /*position: absolute;
              top: 40px;
              right: 20px; */
        }
        
        mb-content-browser {
            padding: 10px;
            display: inline-block;
            @apply(--layout-vertical);
            @apply(--layout-start);
        }

        track-log-ctrl {
            padding: 10px;
            display: inline-block;
            @apply(--layout-vertical);
            @apply(--layout-start);
        }
        
        #radios {
            padding: 10px;
            display: inline-block;
            @apply(--layout-vertical);
            @apply(--layout-start);
        }
        
        paper-radio-button {
            /*align-self: center;*/
            border: 1px solid var(--paper-green-200);
            padding: 8px 16px;
            margin: 8px 0px;
        }
        
        paper-radio-button.red {
            --paper-radio-button-checked-color: var(--paper-red-500);
            --paper-radio-button-checked-ink-color: var(--paper-red-500);
            --paper-radio-button-unchecked-color: var(--paper-red-900);
            --paper-radio-button-unchecked-ink-color: var(--paper-red-900);
            --paper-radio-button-label-color: var(--paper-red-500);
        }
    </style>
</head>

<body>

<template is="dom-bind" id="app">

    <div class="container">
        <!-- LEFT block: CONTENT (Map, diagram, list) -->

        <div id="content" class="content_area">

            <template is="dom-if" if="{{mapstyle}}">
                
                <mb-map 
                    map="{{map}}" 
                    mapapikey="[[mbkey]]" 
                    mapstyle="[[mapstyle]]" 
                    mbid="{{mbid}}" 
                    cbox="{{cbox}}" 
                    zoom="{{zoom}}" 
                    mapctrl = "[[mapctrl]]"
                    maptoast = "[[maptoast]]">

                    <!-- placed here to overlay the map -->
                    <track-log-view
                        disable = "[[userouting]]"
                        checked = "[[elevationshow]]"
                        metadata ="[[metadataset]]"
                        logdata ="[[logdata]]"
                        logindex = "{{logindex}}">
                    </track-log-view>    

                    <mb-styles 
                        checked = "{{styleselectshow}}"
                        styleset ="[[morestyles]]"
                        selectable = "{{styleselectable}}"
                        mapstyle = "{{mapstyle}}"> 
                    </mb-styles>

                    <!-- TOOL to measure user-generated lines -->
                    <mb-distance 
                        checked="[[mapmeasureshow]]"
                        distance="{{distance}}" 
                        map="[[map]]"> 
                    </mb-distance>

                    <mb-location-log 
                        checked="[[locationlogshow]]"
                        lnglat="{{lnglat}}" 
                        map="[[map]]"> 
                    </mb-location-log>

                    <!-- not implemented 
                    <tracks-info 
                        metadataset = "[[metadataset]]" 
                        trackinfo = "[[trackinfo]]" 
                        trackdata = "{{trackdata}}">
                    </tracks-info>
                    -->
                    <template is="dom-if" if="{{userouting}}">
                        <div class="ctrls-in-map">
                            <!-- ctrl of animation-progress  -->
                            <timer-ctrl 
                                timerctrl="{{trackctrl}}"
                                timer="{{timer}}">
                            </timer-ctrl>

                            <!-- ctrl of map-orientation -->
                            <mb-orientation-ctrl 
                                trackmap="[[trackalignmap]]">
                            </mb-orientation-ctrl>
                            
                        </div>
                    </template>

                </mb-map>

            </template>    

        </div>

        <!-- RIGHT Block: several external app-controls -->

        <div class="ctrls_out">
            <!-- element with [n] visible features -->
            <div id="radios">
                
                <template is="dom-if" if="{{!userouting}}">
                    <paper-radio-button checked="{{elevationshow}}">Track Log</paper-radio-button>
                </template>    

                <template is="dom-if" if="{{mapstyle}}">
                    <paper-radio-button checked="{{waypointshow}}">Waypoints</paper-radio-button>
                    <paper-radio-button class="animate red" checked="{{routemode}}">Track Animation</paper-radio-button>
                    <template is="dom-if" if="{{!userouting}}">
                        <paper-radio-button class="style" checked="{{styleselectshow}}" disabled="{{!styleselectable}}">Style selection</paper-radio-button>
                    </template>
                    <paper-radio-button checked="{{mapmeasureshow}}">Map Measure</paper-radio-button>
                    <paper-radio-button checked="{{locationlogshow}}">Location Log</paper-radio-button>
                </template>   

                <paper-radio-button class="drag">Show Dragpoint</paper-radio-button>
                <paper-radio-button class="mobile">Simulate Mobiles</paper-radio-button>
            </div>

            <!-- B. TRACK-APIs -->

            <!-- B.1 TRACK-animation (ROUTING) --> 

            <routing-api 
                disable = "[[!userouting]]"
                map = "[[map]]" 
                timer = "{{timer}}"
                trackctrl = "{{trackctrl}}"      

                routedata = "[[trackdata]]" 

                metadataset = "{{metadataset}}"
                contentbox = "{{contentbox}}"               
                mapcontent = "[[mapcontent]]"

                routeselected ="{{datasetitem}}"> 
                <!--trackdata = "{{trackdata}}"
                trackinfo = "[[trackinfo]]">-->
            </routing-api>

            <timer-setup  
                timer="{{timer}}"
                starttimer="[[starttimer]]"
                metadataset="[[metadataset]]">
            </timer-setup>
                
            <!-- B.2 TRACK-Explorer -->
            <tracks-api 
                disable = "[[userouting]]"
                maptoast = "{{maptoast}}"
                rawcontent = "[[trackdata]]" 
                metadata = "{{metadataset}}" 
                contentbox = "{{contentbox}}" 
                mapcontent = "[[mapcontent]]"
                mapevents = "{{mapevents}}"
                trackselected = "{{datasetitem}}"
                trackpntindex = "{{logindex}}">
            </tracks-api>

            <mb-dragpoint 
                map = "[[map]]" 
                visible = "[[dragpointshow]]"
                indexedtarget = "[[datasetitem]]"
                index = "{{logindex}}"
                maptoast = "{{maptoast}}">
            </mb-dragpoint>
            <!-- lnglat = "[[lnglat]]"--> 

            <!-- SYNC mapcontent from contentbox -->
            <mb-content-manager 
                map = "[[map]]" 
                mbid = "[[mbid]]" 
                contentbox ="{{contentbox}}" 
                mapevents = "[[mapevents]]"
                mapcontent = "{{mapcontent}}"
                dataset = "{{dataset}}"
                featureselected="{{datasetitem}}">
            </mb-content-manager>

            <!-- C. DATA-Supply INTERFACE -->
            <div class="flexchild">
                
                <mb-content-browser 
                    indexurl="[[indexurl]]" 
                    metadatasetslabel="[[metadatasetslabel]]" 
                    metadataset="{{metadataset}}"

                    dataset="[[dataset]]" 
                    selectitem="{{datasetitem}}"> 

                    <tracks-load 
                        routemode = "[[routemode]]"
                        tracksetmeta = "[[metadataset]]" 
                        trackdata = "{{trackdata}}"> 
                    </tracks-load>

                </mb-content-browser>
                <!-- selectprop="id"--> 

                <layer-waypoints 
                    mbid = "[[mbid]]" 
                    visible = "[[waypointshow]]" 
                    querymeta = "[[metadataset]]"
                    wpdata = "{{wpdata}}"> 
                </layer-waypoints>

            </div>

            <!-- C. DATA-LOG CTRL -->
            <div class="flexchild">
                <!-- checked = "[[elevationshow]]" -->
                <track-log-ctrl
                    disable = "[[userouting]]"
                    checked = "true"
                    metadata ="[[metadataset]]"
                    logobject ="[[datasetitem]]"
                    logdata = "{{logdata}}"
                    logindex = "{{logindex}}">
                </track-log-ctrl>    
            </div>    

        </div>

    </div>
</template>

<script>
    var mobilemode = (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
    // mobilemode = "simulate"; console.log("mobilemode=", mobilemode);

    var scope = document.querySelector('#app');

    scope.mbkey = "pk.eyJ1Ijoib25lcHV0aW4iLCJhIjoiY2ltbHBidWxhMDAwa3ZubHdpNHMwdmNwMiJ9.XnPbDF8YdaDgfMFAVi9Vyw";
    scope.mapstyle = 'mapbox://styles/mapbox/light-v9';
    scope.morestyles = "demo-styles.json";

    // Data-INIT
    scope.indexurl = "index-handheld.json"; // list of available datasets
    scope.basedataurl = ""; // list of available datasets
    scope.metadataset = {}; // metadata of selected dataset

    scope.metadatasetslabel="Trackbooks"
    scope.dataset = []; // collection 
    scope.datasetitem = {}; // track/route-object

    // Map-INIT
    scope.cbox = "13,52";
    scope.zoom = 8;
    // scope.lnglat = "13,52";

    // STATE init
    scope.routemode = false; // true; // false

    scope.dragpointshow = false;
    scope.waypointshow = false;
    scope.styleselectshow = false;
    scope.locationlogshow = true;
    
    // Animation- INIT
    scope.trackalignmap; // 
    scope.timer = {}; //
    scope.starttimer = {  // parameters used if not defined otherwise in metadata
        "timescalemax": 600 // 1min ~ 10h
        //"timescalestart": 300
        //"fpsstart": 30
        //"tracelength": true //  '0.0.0.0.5'
    };

    // SHELL-actions
    scope.mapctrl = {};

    /*scope.addEventListener('dom-change', function() {
        console.log("DOM-CHANGED", scope.trackctrl, scope.timer);
    });*/

    document.addEventListener('WebComponentsReady', function() {
        
        // Switch "visibility" of elements related with routing-api- and routing-gui  
        function toggleRouting(radio) {
            if (!radio) scope.userouting = false;
            else if (radio.checked)  scope.userouting = true;
            else scope.userouting = false;
        }

        var r1 = document.querySelector("paper-radio-button.animate");
        if (r1) {
            toggleRouting(r1); 
            // Inverse Toggling of RoutingFlag  
            r1.addEventListener("change", function(){  // console.log("R1-CHANGED", this.checked)
                toggleRouting(this); 
            });
        }

        var r2 = document.querySelector("paper-radio-button.mobile"); // console.log("MOBILE-RADIO", r2);
        if (r2) {
            if (r2.checked) mobilemode = "simulate"; 
            r2.addEventListener("change", function() {  // console.log("Simulate mobile:", r2.checked)
                if (r2.checked) mobilemode = "simulate"; 
                else mobilemode = false;
            });
        }    

        var r3 = document.querySelector("paper-radio-button.drag"); // console.log("MOBILE-RADIO", r2);
        if (r3) {
            if (r3.checked && !scope.userouting) scope.dragpointshow = true; 
            r3.addEventListener("change", function() { 
                if (r3.checked && !scope.userouting) scope.dragpointshow = true; 
                else scope.dragpointshow = false;
                console.log("Show dragpoint:", scope.dragpointshow);
            });
        }    

    });

    /*
        // B. events resulting from scope-property-changes 
        r1.addEventListener("change", function(){  // console.log("R1-CHANGED", this.checked)
            if (this.checked) {
                toggleRoutingControls(false);
            } else {
                toggleRoutingControls(true);
            }
        });


        // testfunction 
        function toggleTestElement(r1, flag) {
            var elname = "paper-radio-button",
                x, t ;
            if (flag) {
                x = document.createElement(elname), 
                t = document.createTextNode("Test button");    
                x.setAttribute("class", "red");
                x.classList.add("test");
                // x.classList.add( "red");
                x.setAttribute("checked", "true");
                x.appendChild(t);  
                r1.parentElement.appendChild(x); 
            } else {
                var p = r1.parentElement;
                x = document.querySelector(elname + ".test");
                console.log("parent", p, x )
                r1.parentElement.removeChild(x);
            }
        }
        // testfunction 
        function toggleRoutingControls(flag) {
            var el,
                parent = document.querySelector("div.ctrls-in-map");
            if (!parent) {
                return; 
            }     
            if (flag) {
                // animation-progress-ctrl
                el = document.createElement("timer-ctrl"), 
                el.setAttribute("timer", "{{timer}}");
                el.setAttribute("trackctrl", "{{trackctrl}}");
                parent.appendChild(el); 
                // Polymer.dom(scope).appendChild(el); // NOPE 

                // map-orientation
                el = document.createElement("mb-orientation-ctrl"),
                el.setAttribute("trackmapmode", "{{trackmode}}");
                parent.appendChild(el); 
                scope.render(); 
            } else {

                el = document.querySelector("timer-ctrl");
                if (el && (el.parentNode == parent)) parent.removeChild(el);

                el = document.querySelector("mb-orientation-ctrl");
                if (el && (el.parentNode == parent)) parent.removeChild(el);
            }
        }

    });*/

</script>

</body>

</html>