<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-slider/paper-slider.html">

<link rel="import" href="../paper-material/paper-material.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="mb-app-behavior.html">

<link rel="import" href="icons-svg.html">

<!--
`routing-ctrl`
elements controling the time-parameters 
of any animation behavior (fi. of track-objects)  

some ctrls (back,forward...) and "slider" are "redundant and should be used exclusively 

-->

<dom-module id="routing-ctrl">

    <template>
    
    	<style type="text/css">
        
	        .ctrlbox {
                @apply(--layout-horizontal);
                @apply(--layout-center);
	        }
            
            paper-icon-button.blue {
                --paper-icon-button-ink-color: var(--paper-orange-500);
                background-color: var(--paper-light-blue-500);
                color: white;
                border-radius: 3px;
                padding: 2px;
                margin: 5px; 
            }

            paper-icon-button.trans {
                color: var(--paper-light-blue-500);
                margin: 1px; 
            }

            #slider {
                @apply(--layout-flex);
                border-style: solid;
                border-width: 1px;
                margin: 5px;
                --paper-slider-height: 5px;
            }

            #logtime {
                margin: 5px;
                padding: 5px;
                background-color: var(--paper-light-blue-500);
                color: white;
            }

            #logtime.running {
                background-color: var(--paper-orange-500);
            }    

    	</style>

		<div id="_target" class="ctrlbox"> 
            
            <!--<paper-icon-button id="replay" icon="{{_icon1}}" title="restart" class="blue"></paper-icon-button>-->
            <!-- group of ctrls -->
            <paper-icon-button id="slowdown" icon="{{_icon_remove}}" title="slowdown" class="trans"></paper-icon-button>
            
            <paper-icon-button id="toggle" icon="{{_icon2}}" title="startstop" class="blue"></paper-icon-button>
            
            <paper-icon-button id="speedup" icon="{{_icon_add}}" title="speedup" class="trans"></paper-icon-button>
            
            <paper-slider id="slider" value="{{sliderval}}" immediate-value="{{slidertime}}" min="{{start}}" max='{{stop}}' on-immediate-value-change="slideChangeHandler"></paper-slider>
           
            <paper-material elevation="2" id="logtime" on-click="timerlog">{{logtime}}</paper-material>

	    </div>

    </template>

    <script>
        Polymer({
            is: 'routing-ctrl',

            properties: {

                /**
                 * OUT: Communicates requested animation-ctrl-action to outside
                 */
                trackctrl: {
                    type: Boolean,
                    value: false,
                    notify: true
                },

                /**
                 * IN: - To reset ctrl-interval after changing timer.start and/or timer.stop 
                 *     - to sync slider with timer.time
                 *
                 */
                timer: {
                    type: Object
                },

                /**
                 * IN: Unit of slidervalues required to convert between slider and animation-time (always [h])
                 *  optional [h], [min], [sec]
                 */
                sliderunit: {
                    type: String,
                    value: "min"
                },

                start: {
                    type: Number
                },

                stop: {
                    type: Number
                },


                slidertime: {
                    type: Number
                },

                _trackctrl: {
                    type: Boolean,
                    value: false
                },


                _icon1: {
                    type: String,
                    value: "ctrl:skip-previous"
                },

                _icon2: {
                    type: String,
                    value: "ctrl:play-arrow"
                },

                _icon_add: {
                    type: String,
                    value: "ctrl:add-circle-outline"
                },

                _icon_remove: {
                    type: String,
                    value: "ctrl:remove-circle-outline"
                },

                /** 
                 * optional 
                 */ 
                /*checked: {
                    type: Boolean,
                    value: true,
                    observer: 'toggleVisibility'
                },*/

            },

            behaviors: [
                Mbb.AppBehavior
            ],

            attached: function() {
                // if (typeof this.checked == 'undefined') this.toggleVisibility(true);
            },

            timerlog: function(){
                console.log("timerLog:", this.timer)
            },

            listeners: {
                // for value-sliders
                //'change': 'changeHandler'
            },

            observers: [
                'syncCtrls(trackctrl)',
                'syncSlider(timer.time)',
                'resetSlider(timer.stop, timer.start)' 
            ],

            ready: function() {
                this.setupAnimationCtrls();
            },

            // 
            toggleCtrl: function() {
                if ((this.trackctrl == true)||(this._trackctrl == true)) {
                    this.trackctrl = false;
                    this._trackctrl = false
                } else if ((this.trackctrl == false)||(this._trackctrl == false)) {
                    this.trackctrl = true;
                    this._trackctrl = true
                } 
                // console.log("AFTER toggleCtrl ", this.trackctrl, this._trackctrl)
            },


            /**
             * Initialize/Reset the (animation-)progress-slider for imported data
             * 
             * @param      {number}  stoptime  The stoptime
             */
            resetSlider: function(stoptime, starttime) { // , stoptime) {
                // console.log("RESET routing-ctrl for", starttime, stoptime, this.timer)
                this.trackctrl = false;  

                this.debounce("reset", function(){
                    if (!stoptime) return;

                    // 1. GUESSS and set the startTime
                    if (!starttime) starttime = this.starttime;
                    if (!starttime) {
                        this.starttime = 0;
                        starttime = 0;
                    } else {
                        this.starttime = starttime;
                    }   

                    // this.set("time.time", starttime); 

                    // 2. SET the Slider-Boundaries for "relative routeTime" in "sliderunits" 

                    this.start = 0; // 

                    // Setup the "relative"" stop-time
                    var deltat = stoptime - starttime;
                    if (this.sliderunit == "min")       deltat = deltat * 60;
                    else if (this.sliderunit == "sec")  deltat = deltat * 3600;
                    this.stop  = Math.ceil(deltat);

                    console.log("Setup timeSlider for start-/stop-times ", starttime, stoptime, "SLIDERLENGTH = "+this.stop+"["+this.sliderunit+"]");

                    // this.syncSlider(starttime); 

                    // this.slideChangeHandler(starttime); 

                }, 100);    
            },

            /**
             * Sync animation-status with controls 
             *
             * @param      {number}  tracktime  The time from FIRST start of animation-app
             */
            syncSlider: function(tracktime) {
                if (!tracktime) return;

                // A. Sync the slider with externally modified tracktime 
                var sliderval = tracktime - this.starttime; 
                if ((sliderval < 0)||(sliderval > this.stop)) {
                    console.log("sliderval outside: ", tracktime, this.starttime, sliderval); 
                    this.trackctrl = false; 
                    return;
                }

                // A.2 Adjust the "unixHours"
                if (this.sliderunit == "min") sliderval = sliderval * 60;
                if (this.sliderunit == "sec") sliderval = sliderval * 3600;

                // B.1 Sync the slider-position
                this.sliderval = sliderval;

                // B.2 Sync the tracktime in special box
                var logtime = this.logTime(tracktime, "h", "<br>");
                this.$.logtime.innerHTML = logtime;
            },

            /**
             * Communicate changes of slidertime triggered by useraction on slider 
             */
            slideChangeHandler: function() {

                var slidertime = this.slidertime;
                if (this.sliderunit == "min") slidertime = slidertime / 60;
                if (this.sliderunit == "sec") slidertime = slidertime / 3600;

                var tracktime = this.starttime + slidertime;

                // NOTIFY new time to routing-api 
                this.trackctrl = tracktime;  
                // ************************
                // B.2 Sync the tracktime in LogBox
                var logtime = this.logTime(tracktime, "h", "<br>");
                this.$.logtime.innerHTML = logtime;

                // STOP animation, if it was running  
                if (this._trackctrl)  {  // console.log("STOPPED at slidertime: " + this.slidertime + "["+this.sliderunit+"]", "tracktime: "+this.logTime(tracktime, "h"));
                    this.trackctrl = false;  
                    this._trackctrl = false; 
                }    
            },

            /**
             * Sync ctrl-button-icons after remote "trackctrl"-change  
             * ctrls must reflect the handling options during actual status 
             *
             * @param      {string}  trackctrl  The trackctrl
             * @param      {<type>}  trackmode  The trackmode
             */
            syncCtrls: function(trackctrl, _trackctrl) {
                // console.log("trackctrl", trackctrl, _trackctrl);    

                if (trackctrl) {

                    if (trackctrl == "reset") {
                        // 
                        this._icon2 = "ctrl:play-arrow";

                    } else if (trackctrl == true) {   // dedicated START-action  
                        // 
                        this._icon2 = "ctrl:pause";
                        this.$.logtime.classList.add('running'); // console.log("this.$.logtime", this.$.logtime); 
                    
                    } else {    // new time 
                        // NO style change 

                    }

                } else {
                    
                    this._icon2 = "ctrl:play-arrow";
                    this.$.logtime.classList.remove('running');
                }
            },



            /**
             * Setup the Ctrl-actions (start/stop, restart, time-slider) 
             * changing status-properties 
             */
            setupAnimationCtrls: function() {

                this.val = 1;

                var ctrl1 = this.$.replay,
                    ctrl2 = this.$.toggle,

                    ctrl3a = this.$.slowdown,
                    ctrl3b = this.$.speedup;

                var slider = this.$.slider,
                    tracetime;

                if (ctrl1) { // ReStart-Button-event
                    ctrl1.addEventListener('click', function() {
                        this.trackctrl = "reset";
                    }.bind(this));
                }

                if (ctrl2) {  
                    // Start/Stop-Button-event
                    ctrl2.addEventListener('click', function() {
                        this.toggleCtrl();
                    }.bind(this));
                }

                if (ctrl3a) {  // Used to externally Ctrl the animation frequency  
                    // Slowdown animation-frequency
                    ctrl3a.addEventListener('click', function() {
                        this.set("timer.ctrl", "down"); // console.log("slowdown");
                        //this.set("timer.ctrl", "none");
                    }.bind(this));

                    // Speedup animation-frequency
                    ctrl3b.addEventListener('click', function() {
                        this.set("timer.ctrl", "up"); //console.log("speedup");
                        //this.set("timer.ctrl", "none");
                    }.bind(this));
                }

                // QuickKeyCtrls 
                document.body.addEventListener('keydown', function(e) {
                    if (e.which === 32) { // space
                        console.log("Toggle start/stop")
                    }
                    // Trigger a STOP always
                    if (e.which === 37) { // left
                        console.log("timestep back")
                    }
                    if (e.which === 39) { // right
                        console.log("timestep forward")
                    }
                    // Do NOT change timechange-status
                    if (e.which === 38) { // up
                        console.log("run faster")
                        e.preventDefault();
                    }
                    if (e.which === 40) { // down
                        console.log("run slower")
                        e.preventDefault();
                    }
                }, true);



            }

        });
    </script>

</dom-module>

</dom-module>