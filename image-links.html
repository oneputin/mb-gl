<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../iron-icons/iron-icons.html">

<link rel="import" href = "../files-input/files-input.html">
<link rel="import" href = "../image-meta/exif-locations.html">

<link rel="import" href = "fab-area.html">

<!--
`image-links`
container for upload/presentation of geolocated images 

@demo demo/imagelinks.html 
-->

<dom-module id="image-links">

    <template>

        <style>

            :host {
                display: block;
                position: relative;
            }
            paper-item : {
                padding: 3px;
                border: 1;
            }

            .content : {
                @apply(--layout-horizontal);
                @apply(--layout-justified);
            }
        </style>

        <fab-area 
            ctrllabel = "[[ctrllabel]]"
            checked = false>

            <div class="ctrl">
                <paper-listbox>
                    <template is="dom-repeat" items="{{nonlocated}}">
                        <paper-item value="[[item]]" on-tap="locateimage">[[item]]</paper-item>
                    </template>    
                </paper-listbox>
            </div>        

            <div class="content">    
                <!--  -->
                <files-input
                    type="image"
                    multiple=true
                    loadedfiles="{{imageset}}">
                </files-input>    

                <!--  -->
                <exif-locations
                    imageset = "[[imageset]]"
                    locationmode = "geojson"
                    locations = "{{featureset}}"
                    nonlocated = "{{nonlocated}}">
                </exif-locations>
            
            </div>

        </fab-area>

    </template>

    <script>
        var wpscope; 

        Polymer({
            is: 'image-links',

            properties: {

                // content of pointlayer
                imageset : {
                    type: Array //, observer: '_storeImages'
                },

                locateimg : {
                    type: Object,
                    notify : true
                },

                location : {
                    type: String,
                    observer : 'testlocation'
                },

                // content of pointlayer
                featureset : {
                    type: Object,
                    observer: '_refreshLayer'
                },

                // content of pointlayer
                nonlocated : {
                    type: Array,
                    observer: '_createMenu'
                },

                // visibility of pointlayer
                visible : {
                    type : Boolean,
                    value : true
                },

                layerid : {
                    type : String,
                    value : "imglinks"
                },

                ctrllabel : {
                    type : String,
                    value : ''
                }

            },

            behaviors: [
            ],           

            observers: [
            ],

            ready: function() {
                wpscope = this;
            },

            locateimage : function(e) { 
                var item = e.target;   // console.log("item-value", item.value); // , item.value);
                this._supplyimage(item.value); 
            },

            _createMenu : function (nonlocated) {
                if (nonlocated.length) this.ctrllabel = "not located"; // console.log("nonlocated", nonlocated);
                else this.ctrllabel = ""
            },

            /**
             * 
             */            
            _supplyimage : function(imgname) {
                this.imageset.some(function(img){
                    if (img.name == imgname) {  //console.log("selected img " + imgname, img); // , img.value);
                        this.locateimg = img;
                        return;
                    } 
                }.bind(this));   
            },

            // 
            mapclickAction : function (feature) { // console.log("clicked at ", feature); 
                var id = feature.properties.name;
                this._supplyimage(id); 
            },

            hoverAction : function (feature) {
                console.log("hovered ", feature); 
            },

            // generic click-listener
            _mapclickListener : function(e) {
                var f = wpscope._mapeventListener(e); 
                if (!f) return; // console.log("clicked",f);

                wpscope.mapclickAction(f);
            }, 

            // generic hover-listener
            _maphoverListener : function(e) {
                var f = wpscope._mapeventListener(e); 
                if (!f) return; 
                wpscope.hoverAction(features[0]);
            }, 

            // generic select-event-translator
            _mapeventListener : function(e) {
                var st = wpscope._layerStatus(); 
                if (!st.layer) return ;  

                var features = map.queryRenderedFeatures(e.point, {
                    layers: [st.id]
                });
                if (!features || !features.length) return;   
                return features[0];
            },    

            // Test the layer status
            _layerStatus : function(layid) {
                if (!layid) layid = this.layerid;
                var status = {
                    id : layid,
                    layer : map.getLayer(layid),
                    src :  map.getSource(layid)
                };  // console.log("_layerStatus", status);  
                return status;  
            },

            // Simple fitbounds for point-features
            _fitBounds : function(features, padding) {
                if (padding== null) padding = 20;

                if (features.features) features = features.features; // if featureset was passed

                var coord0 = features[0].geometry.coordinates;
                var bounds = features.reduce(function(bounds, feature) {
                    var coord = feature.geometry.coordinates;
                    return bounds.extend(coord);
                }, new mapboxgl.LngLatBounds(coord0, coord0));

                map.fitBounds(bounds, {
                    padding: 30
                }); 
            },     

            _refreshLayer: function(rawdata) {
                var st = this._layerStatus();  // console.log("CREATELAYER: " + st.id, st, rawdata); 
                
                if (!st.src) {

                    map.addSource(st.id, {
                        "type": "geojson",
                        "data": {
                            "type": "FeatureCollection",
                            "features": rawdata.features
                        }
                    });

                } else { 

                    map.getSource(st.id).setData(rawdata);
                    
                } // console.log("UPDATED imglinks-src with ", rawdata);
                
                if (!st.layer) {
                    var vis = "none";
                    if (this.visible) vis = "visible";

                    map.addLayer({
                        "id": st.id,
                        "type": "circle",
                        "source": st.id,
                        "layout" : {
                            "visibility": vis
                        },
                        "paint": {
                            "circle-radius": 8,
                            "circle-color": "#FFFFFF",
                            "circle-stroke-width": 2,
                            "circle-stroke-color": "#B42222"
                        },
                        "filter": ["==", "$type", "Point"],
                    }); // console.log("added img-link-layer", map.getLayer(st.id) ); 

                }    

                this._fitBounds(rawdata.features);

                if (this.mapclickAction) {
                     map.off('click', this._mapclickListener);
                     map.on('click', this._mapclickListener);
                } 

                if (this.hoverAction) {
                     map.off('hover', this.hoverListener);
                     map.on('hover', this.hoverListener);
                }

                return st;
            }

        });
    </script>
</dom-module>