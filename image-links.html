<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">

<link rel="import" href = "../files-input/files-input.html">
<link rel="import" href = "../image-meta/exif-locations.html">

<link rel="import" href = "mb-fabarea.html">

<!--
`image-links`
container for upload/presentation of geolocated images 

@demo demo/imagelinks.html 
-->

<dom-module id="image-links">

    <template>

        <style>

            :host {
                display: block;
                position: relative;
            }

        </style>

        <mb-fabarea  checked = false>

            <div class="ctrl">
                <div> some statistics </div>
            </div>        

            <div class="content">    

                <!--  -->
                <files-input
                    type="image"
                    multiple=true
                    loadedfiles="{{imageset}}">
                </files-input>    

                <!--  -->
                <exif-locations
                    imageset = "[[imageset]]"
                    locationmode = "geojson"
                    locations = "{{featureset}}">
                </exif-locations>
            
            </div>

        </mb-fabarea>

    </template>

    <script>
        var wpscope; 

        Polymer({
            is: 'image-links',

            properties: {

                // content of pointlayer
                imageset : {
                    type: Array //, observer: '_storeImages'
                },

                imgsrc : {
                    type: String,
                    notify : true,
                    observer: '_showImage'
                },

                // content of pointlayer
                featureset : {
                    type: Object,
                    observer: '_refreshLayer'
                },

                // visibility of pointlayer
                visible : {
                    type : Boolean,
                    value : true
                },

                layerid : {
                    type : String,
                    value : "imglinks"
                },

            },

            behaviors: [
            ],           

            observers: [
            ],

            ready: function() {
                wpscope = this;
            },

            _getImage : function(imgname) {
                this.imageset.some(function(img){
                    if (img.name == imgname) {
                        console.log("selected img " + imgname); // , img.value);
                        this.imgsrc = img.value;
                        return;
                    } 
                }.bind(this));   
            },

            _showImage : function(dataurl) {
                console.log("_showImage, length", dataurl.length)
            },

            clickAction : function (feature) { // console.log("clicked at ", feature); 
                var id = feature.properties.name;
                this._getImage(id); 
            },

            hoverAction : function (feature) {
                console.log("hovered ", feature); 
            },

            // generic click-listener
            _clickListener : function(e) {
                var f = wpscope._eventListener(e); 
                if (!f) return; // console.log("clicked",f);

                wpscope.clickAction(f);
            }, 

            // generic hover-listener
            _hoverListener : function(e) {
                var f = wpscope._eventListener(e); 
                if (!f) return; 
                wpscope.hoverAction(features[0]);
            }, 

            // generic select-event-translator
            _eventListener : function(e) {
                var st = wpscope._layerStatus(); 
                if (!st.layer) return ;  

                var features = map.queryRenderedFeatures(e.point, {
                    layers: [st.id]
                });
                if (!features || !features.length) return;   
                return features[0];
            },    

            // Test the layer status
            _layerStatus : function(layid) {
                if (!layid) layid = this.layerid;
                var status = {
                    id : layid,
                    layer : map.getLayer(layid),
                    src :  map.getSource(layid)
                };  // console.log("_layerStatus", status);  
                return status;  
            },

            // Simple fitbounds for point-features
            _fitBounds : function(features, padding) {
                if (padding== null) padding = 20;

                if (features.features) features = features.features; // if featureset was passed

                var coord0 = features[0].geometry.coordinates;
                var bounds = features.reduce(function(bounds, feature) {
                    var coord = feature.geometry.coordinates;
                    return bounds.extend(coord);
                }, new mapboxgl.LngLatBounds(coord0, coord0));

                map.fitBounds(bounds, {
                    padding: 30
                }); 
            },     

            _refreshLayer: function(rawdata) {
                var st = this._layerStatus();  // console.log("CREATELAYER: " + st.id, st, rawdata); 
                
                if (!st.src) {

                    map.addSource(st.id, {
                        "type": "geojson",
                        "data": {
                            "type": "FeatureCollection",
                            "features": rawdata.features
                        }
                    });

                } else { 

                    map.getSource(st.id).setData(rawdata);
                    
                } // console.log("UPDATED imglinks-src with ", rawdata);
                
                if (!st.layer) {
                    var vis = "none";
                    if (this.visible) vis = "visible";

                    map.addLayer({
                        "id": st.id,
                        "type": "circle",
                        "source": st.id,
                        "layout" : {
                            "visibility": vis
                        },
                        "paint": {
                            "circle-radius": 8,
                            "circle-color": "#FFFFFF",
                            "circle-stroke-width": 2,
                            "circle-stroke-color": "#B42222"
                        },
                        "filter": ["==", "$type", "Point"],
                    }); // console.log("added img-link-layer", map.getLayer(st.id) ); 

                }    

                this._fitBounds(rawdata.features);

                if (this.clickAction) {
                     map.off('click', this._clickListener);
                     map.on('click', this._clickListener);
                } 
                if (this.hoverAction) {
                     map.off('hover', this.hoverListener);
                     map.on('hover', this.hoverListener);
                }

                return st;
            }

        });
    </script>
</dom-module>