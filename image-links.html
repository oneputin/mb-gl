<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../iron-icons/iron-icons.html">

<link rel="import" href = "../files-input/files-input.html">
<link rel="import" href = "../image-meta/exif-locations.html">

<link rel="import" href = "fab-area.html">

<!--
`image-links`
container for upload/presentation of geolocated images 

@demo demo/imagelinks.html 
-->

<dom-module id="image-links">

    <template>

        <style>

            :host {
                display: block;
                position: relative;
            }
            paper-item : {
                padding: 3px;
                border: 1;
            }

            .content : {
                @apply(--layout-horizontal);
                @apply(--layout-justified);
            }
        </style>

        <fab-area 
            ctrllabel = "[[ctrllabel]]"
            checked = false>

            <div class="ctrl">
                <paper-listbox>
                    <template is="dom-repeat" items="{{nonlocated}}">
                        <paper-item value="[[item]]" on-tap="locateimage">[[item]]</paper-item>
                    </template>    
                </paper-listbox>
            </div>        

            <div class="content">    
                <!--  -->
                <files-input
                    type="image"
                    multiple=true
                    loadedfiles="{{imageset}}">
                </files-input>    

                <!--  -->
                <exif-locations
                    imageset = "[[imageset]]"
                    locationmode = "geojson"
                    locations = "{{featureset}}"
                    nonlocated = "{{nonlocated}}">
                </exif-locations>
            
            </div>

        </fab-area>

    </template>

    <script>
        var wpscope; 

        Polymer({
            is: 'image-links',

            properties: {

                // content of pointlayer
                imageset : {
                    type: Array ,
                    observer: '_checkinImages'
                },

                locatedimg : {
                    type: Object,
                    notify : true
                },

                location : {
                    type: String,
                    observer : 'testlocation'
                },

                // content of pointlayer
                featureset : {
                    type: Object,
                    observer: '_refreshLayer'
                },


                _imageset : {
                    type: Array,
                    value: []
                },

                _featureset : {
                    type: Object
                },

                // content of pointlayer
                nonlocated : {
                    type: Array,
                    observer: '_createMenu'
                },

                // visibility of pointlayer
                visible : {
                    type : Boolean,
                    value : true
                },

                layerid : {
                    type : String,
                    value : "imglinks"
                },

                ctrllabel : {
                    type : String,
                    value : ''
                }

            },

            behaviors: [
            ],           

            observers: [
            ],

            ready: function() {
                wpscope = this;
            },

            // 
            _checkinImages : function(imageset) { console.log("CheckIn images", imageset);
                imageset.some( function(img){
                    if (!this._imageset[img.name]) {
                        this._imageset[img.name] = img; // .value;
                    }     
                }.bind(this));    
            },

            // 
            locateimage : function(e) { 
                var item = e.target;   // console.log("item-value", item.value); // , item.value);
                this._supplyimage(item.value); 
            },

            _createMenu : function (nonlocated) {
                if (nonlocated.length) this.ctrllabel = "not located"; // console.log("nonlocated", nonlocated);
                else this.ctrllabel = ""
            },

            /**
             *  Supply image to other APP-Components 
             */            
            _supplyimage : function(imgid) { 
                var imgnames = Object.keys(this._imageset);  console.log("SUPPLY from", imgnames, imgid) ;
                imgnames.some(function(imgname){
                    if (imgid == imgname) {  
                        var img = this._imageset[imgname]; console.log("Found img [" + imgname + "]"); // , img); // , img.value);
                        this.locatedimg = img;
                        return;
                    } 
                }.bind(this));   
            },

            // 
            mapclickAction : function (feature) {  
                var id = feature.properties.name; // console.log("clicked at locator of  image " + id, feature.properties); 
                this._supplyimage(id); 
            },

            hoverAction : function (feature) {
                console.log("hovered ", feature); 
            },

            // generic click-listener
            _mapclickListener : function(e) {
                var f = wpscope._mapeventListener(e); 
                if (!f) return; // console.log("clicked",f);

                wpscope.mapclickAction(f);
            }, 

            // generic hover-listener
            _maphoverListener : function(e) {
                var f = wpscope._mapeventListener(e); 
                if (!f) return; 
                wpscope.hoverAction(features[0]);
            }, 

            // generic select-event-translator
            _mapeventListener : function(e) {
                var st = wpscope._layerStatus(); 
                if (!st.layer) return ;  

                var features = map.queryRenderedFeatures(e.point, {
                    layers: [st.id]
                });
                if (!features || !features.length) return;   
                return features[0];
            },    

            // Test the layer status
            _layerStatus : function(layid) {
                if (!layid) layid = this.layerid;
                var status = {
                    id : layid,
                    layer : map.getLayer(layid),
                    src :  map.getSource(layid)
                };  // console.log("_layerStatus", status);  
                return status;  
            },

            // Simple fitbounds for point-features
            _fitBounds : function(features, padding) {
                if (padding== null) padding = 20;

                if (features.features) features = features.features; // if featureset was passed

                var coord0 = features[0].geometry.coordinates;
                var bounds = features.reduce(function(bounds, feature) {
                    var coord = feature.geometry.coordinates;
                    return bounds.extend(coord);
                }, new mapboxgl.LngLatBounds(coord0, coord0));

                map.fitBounds(bounds, {
                    padding: 30
                }); 
            },     

            // 
            _refreshLayer: function(rawdata) {
                
                if (!rawdata || !rawdata.type) {
                    console.log("BREAK. 1  no location data attached!");
                    return;  
                } 


                // 1. 
                var featureset = rawdata; 
                if (!featureset.features) {
                    featureset = {
                        "type": "FeatureCollection",
                        "features": [featureset]
                    }
                }    
                if (!featureset.features.length) {
                    console.log("BREAK. 2  no location data attached to ", rawdata);
                    return;  
                } 

                // 2. Update dataSource
                var st = this._layerStatus();  // console.log("_refresh Layer " + st.id, st, rawdata, featureset); 

                if (!st.src) {
                   
                    this._featureset = featureset;
                    map.addSource(st.id, {
                        "type": "geojson",
                        "data": featureset
                    });

                } else { 

                    this._featureset.features = this._featureset.features.concat(featureset.features); 
                    // console.log("new, all features", featureset, this._featureset) ; 
                    
                    map.getSource(st.id).setData(this._featureset);
                    
                } // console.log("UPDATED imglinks-src with ", rawdata);
                
                // 3. Check/Update "LinkLayer"
                if (!st.layer) {
                    var vis = "none";
                    if (this.visible) vis = "visible";

                    map.addLayer({
                        "id": st.id,
                        "type": "circle",
                        "source": st.id,
                        "layout" : {
                            "visibility": vis
                        },
                        "paint": {
                            "circle-radius": 8,
                            "circle-color": "#FFFFFF",
                            "circle-stroke-width": 2,
                            "circle-stroke-color": "#B42222"
                        },
                        "filter": ["==", "$type", "Point"],
                    }); // console.log("added img-link-layer", map.getLayer(st.id) ); 

                }    

                // 4. Update viewPort to inculde last loaded locations  
                //    HILITING the last linkPoint
                var fitdata = this._featureset,
                    ff = fitdata.features;
                if (ff.length < 2) { // fit to a certain buffer around point !!
                    var center = ff[0];
                    var radius = 5;
                    var steps = 10;
                    var units = 'kilometers';
                    var pp = turf.explode(turf.circle(center, radius, steps, units));
                    ff = ff.concat(pp.features);   
                } console.log("fitting to data:", ff); 

                this._fitBounds(ff);

                // 5. 
                if (this.mapclickAction) {
                     map.off('click', this._mapclickListener);
                     map.on('click', this._mapclickListener);
                } 

                if (this.hoverAction) {
                     map.off('hover', this.hoverListener);
                     map.on('hover', this.hoverListener);
                }

                return st;
            }

        });
    </script>
</dom-module>