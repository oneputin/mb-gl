<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">

<!--
`dynamic-menu`  
Container for paper-dropdown-menu reducing variable properties to main dynamic event-actions  
- _updateMenu
- _menuChanged
- _menuSelected 

@demo demo/routingplanes.html 
-->

<dom-module id="dynamic-menu">

    <template>
        <style>
            :host {
                display: inline-block;
                position: relative;
                background-color: var(--paper-light-green-500);
            }
            paper-dropdown-menu {
                border-style: solid;
                border-width: 1px;
                padding: 10px;
                /*opacity: 0.8;*/
            }
        </style>
        
        <template is="dom-if" if="{{menuitems}}">
            <paper-dropdown-menu class="dataitems" label="{{menulabel}}">
                <paper-listbox id="listbox" class="dropdown-content" 
                    on-iron-items-changed="_menuChanged" 
                    on-iron-select="_menuSelected" 
                    attr-for-selected="select">
                    <template is="dom-repeat" items="{{_selectset}}">
                        <paper-item select="{{item}}" id="{{item.id}}">
                            {{item.title}}
                        </paper-item>
                    </template>
                </paper-listbox>
            </paper-dropdown-menu>
        </template>

    </template>

    <script>

        Polymer({
            is: 'dynamic-menu',

            properties: {

                // INPUT: items used to create menu
                menuitems: {
                    type: Array,
                    notify: true
                },

                // INPUT(opt): Label of menu
                menulabel : {
                    type: String,
                    value: "Menuitems"
                },

                // IN/OUT: of menu-selection returned !!
                selectitem: {
                    type: Object,
                    notify: true
                },

                // INPUT(opt): property of menuitems to return as selectvalue
                // if null - entire object will be returned
                selectprop: {
                    type: String
                },


                // INPUT(opt): FLAG ctrls adding all/clear items to the items of menu2
                allandnone: {
                    type: String,
                    value: 0
                },

                // TEMP: Base of dynamic items-creationcreated from menudata if menudata.length > 1
                _selectset: {
                    type: Array
                },

                // 
                _selectindex: {
                    type: Number,
                    observer: '_refreshSelectedItem'
                },

                _lastid: String

            },

            observers: [
                '_updateMenu(menuitems)',
                '_syncSelection(selectitem.id)'
            ],

            /**
             * Update the Menu-Content (List of menu-items)
             * 
             * @param      {object}  menudata  The menudata to 
             */
            _updateMenu: function(menudata) {
                // console.log("_updateMenu. menudata=", menudata);
                if (!menudata || !menudata.length) return; 

                // optional standard-Items adding
                function enhanceMenu(menudata) {
                    var dset = [];
                    menudata.forEach(function(d) {
                        dset.push(d);
                    })
                    dset.push({
                        id: "all",
                        title: "Select all"
                    });
                    dset.push({
                        id: "clear",
                        title: "Clear all"
                    });
                    return dset; 
                };

                if (menudata && menudata.length) {
                    var preselectindex = 0,
                        preselectitem = menudata[0];

                    if (menudata.length > 1) {
                        var i = 0;
                        menudata.some(function(rs) {
                            if (rs.start) {
                                preselectitem = rs;
                                preselectindex = i;
                                return true;
                            }
                            i = i + 1;
                        });
                        
                        if (this.allandnone) { 
                            menudata = enhanceMenu(menudata);
                        } 
                        this._selectset = menudata;

                    } else { // NO menu but return of SELECTRESULT
                        this._selectset = null; // menu not required
                        this.selectitem = preselectitem;                    
                    }

                    this._selectindex = preselectindex;

                } else {
                    this._selectset = null;
                    this.selectitem = null;
                }
                this._lastid = null;
                // console.log("_updateMenu. selected, _selectset", selected, this._selectset);
            },

            // Translate external selection into index of meun-item 
            _syncSelection: function(selectitemid) {
                // use debounce to avoid "doubling" if event from different sources
                
                this.debounce("sync", function(){
                
                    if (this._selectset && selectitemid && (selectitemid != this._lastid)) {
                        // console.log("SYNC MENU for", selectitemid, this._selectset); 

                        var index;
                        this._selectset.some(function(item, i){
                            if (item.id == selectitemid) {
                                index = i;
                                return true;  
                            }
                        });
                        if (index != null) {
                            this._lastid = selectitemid;
                            this._selectindex = index; // triggers '_refreshSelectedItem'
                        }
                    }
                }, 200);    
            },

            // 
            _refreshSelectedItem: function(selectindex) {
                var listbox = this.$$("paper-listbox"); 
                if (listbox) {
                    // console.log("activate menu-item at position", selectindex , "in listbox", listbox); 
                    listbox.selectIndex(selectindex);
                }    
            },

            // AFTER modifiction of menu-items
            _menuChanged: function(e){
                var i = this._selectindex ? this._selectindex : 0;
                // console.log("_menuChanged and resets to "+i, e.detail.target);
                e.detail.target.selectIndex(i);
            },
            /**
             * Select an item out of active menudata
             */
            _menuSelected: function(e) {
                var selected = e.detail.item.select; // an object of processed menudata
                if (this.selectprop) selected = selected[this.selectprop]; // a property of selected object
                this.selectitem = selected;
            }

        })
    </script>
</dom-module>