<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="mb-map-behavior.html">
<link rel="import" href="mb-content-behavior.html">

<!--
    `mb-content-view`
    quick preview of "contentbox" supplied in "quickformat" fi. 
    - derived from raw kml- or gpx-datasets
    - created for routing-api

    `quickformat` - object:

            quickmap[mbid] = {
                "layer": {
                    "type": "line",
                    "id": mbid,
                    "source": mbid
                },
                "srcdata": srcdata,
                "raw": 1
            };
    
    @demo demo/routingtracks.html 
-->

<dom-module id="mb-content-view">

    <template>

        <style>
            :host {
                display: block;
                /*position: absolute;*/
            }
        </style>

    </template>

    <script>
        
        Polymer({
            is: 'mb-content-view',

            properties: {
                /**
                 *  map-object available for query and manipulation outside 
                 */
                map: {
                    type: Object,
                },

                // features of (all) json-layers loaded
                // !! grouped by layer !!
                mapcontent: {
                    type: Object,
                    value: {}
                },

                // (linear) List of (basic) mapfeatures to be used for external selection
                // optionally from 1-n layers
                featurelist: {
                    type: Array,
                    value: [],
                    notify: true
                },

                // bidirectional ctrl-prop
                featureselected: {
                    type: Object,
                    notify: true,
                    observer: 'checkoutFeature'
                },

                checked: {
                    type: Boolean
                }

            },

            behaviors: [
                Mbb.ContentBehavior,
                Mbb.MapBehavior
            ],

            observers: [
                'mapcontentFeatureList(mapcontent.*)',
                ''
            ],

            ready: function() {
                // console.log("READY: mb-content-view");
            },

            attached: function() {
                // this.installmap();
            },

            // 
            checkoutFeature: function(f) {
                if (!f.feature || !this.map) return; 
                // console.log("Selected Track: " + f.id, f);

                if (f.feature.properties.coordTimes)  {  // SPEC-CASE : Tracks 
                    this.tracksHilite([f.feature], f.layer);

                } else if (false)  {  // SPEC-CASE : Other 


                } else { // SIMPLE GeometryZoom 

                    this.setFeatureBounds([f.feature], this.map);
                }    
            },

            /**
             * Create a linear LIST(array) of all features  
             * of layernames (ggf keys of 'mapcontent'-collection) 
             * and supply to container ("notified" property)
             */
            mapcontentFeatureList: function(mapcontent, layernames) {
                if (mapcontent.path == 'mapcontent') mapcontent = mapcontent.value;
                if (!mapcontent || !Object.keys(mapcontent).length) return;
                if (!layernames) layernames = Object.keys(mapcontent);
                // console.log("GET mapcontentFeatureList of", layernames, mapcontent);

                var featurelist = [];
                layernames.forEach(function(lname) {

                    mapcontent[lname].forEach(function(item) {
                        featurelist.push(item);
                    })

                });
                this.featurelist = featurelist; // notifies !!
                console.log("GOT mapcontentFeatureList :", layernames, featurelist);
            }

        });
    </script>
</dom-module>