<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="mb-map-behavior.html">
<link rel="import" href="mb-content-behavior.html">

<!--
    `mb-content-view`
    quick preview of "contentbox" supplied in "quickformat" fi. 
    - derived from raw kml- or gpx-datasets
    - created for routing-api

    @demo demo/routingtracks.html 
-->

<dom-module id="mb-content-view">

    <template>

        <style>
            :host {
                display: block;
                /*position: absolute;*/
            }
        </style>

    </template>

    <script>
        
        Polymer({
            is: 'mb-content-view',

            properties: {
                /**
                 *  map-object available for query and manipulation outside 
                 */
                map: {
                    type: Object,
                },

                // features of (all) json-layers loaded
                // !! grouped by layer !!
                mapcontent: {
                    type: Object,
                    value: {}
                },

                // (linear) List of (basic) mapfeatures to be used for external selection
                // optionally from 1-n layers
                featurelist: {
                    type: Array,
                    value: [],
                    notify: true
                },

                // bidirectional ctrl-prop
                featureselected: {
                    type: Object,
                    notify: true,
                    observer: 'checkoutFeature'
                },

                checked: {
                    type: Boolean
                }

            },

            behaviors: [
                Mbb.ContentBehavior,
                Mbb.MapBehavior
            ],

            observers: [
                'mapcontentFeatureList(mapcontent.*)',
                ''
            ],

            ready: function() {
                // console.log("READY: mb-content-view");
            },

            attached: function() {
                // this.installmap();
            },

            // 
            checkoutFeature: function(f) {
                if (!f.feature || !this.map) return; 
                // console.log("Selected Track: " + f.id, f);
                this.featuresSelect([f.feature], f.layer);
            },

            /**
             * Create a linear LIST(array) of all features  
             * of layernames (ggf keys of 'mapcontent'-collection) 
             * and supply to container ("notified" property)
             */
            mapcontentFeatureList: function(mapcontent, keys) {
                if (mapcontent.path == 'mapcontent') mapcontent = mapcontent.value;
                if (!mapcontent || !Object.keys(mapcontent).length) return;
                
                if (!keys) keys = Object.keys(mapcontent);
                // console.log("GET mapcontentFeatureList of", keys, mapcontent);
                
                // Select features from layer with basefeatures only !! 

                var obj, featurelist = [];

                keys.forEach(function(lname) {
                    obj = mapcontent[lname];
                    // add features to featurelist if layer is "marked" or if only one layer exists   
                    if ((keys.length == 1) || obj.usefeatures) { // 
                        obj.features.forEach(function(item) {
                            featurelist.push(item);
                        })
                    } 

                });

                this.featurelist = featurelist; // NOTIFIES  !!
                // console.log("GOT mapcontentFeatureList :", layernames, featurelist);
            }

        });
    </script>
</dom-module>