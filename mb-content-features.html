<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="mb-map-behavior.html">
<link rel="import" href="mb-content-behavior.html">
<link rel="import" href="mb-app-behavior.html">

<!--
    `mb-content-features`
    ctrl of map-faetures contained/supplied in a "contentbox", as fi. 
    - derived from raw kml- or gpx-datasets  or 
    - created for routing-api

    @demo demo/routingtracks.html 
-->

<dom-module id="mb-content-features">

    <template>

        <style>
            :host {
                display: block;
                /*position: absolute;*/
            }
        </style>

    </template>

    <script>
        
        Polymer({
            is: 'mb-content-features',

            properties: {
                /**
                 *  map-object available for query and manipulation outside 
                 */
                map: {
                    type: Object,
                },

                // IN: content-box-features of (1-n) layers 
                // !! grouped by layer !!
                contentfeatures: {
                    type: Object,
                    value: {}
                },

                // OUT: (linear) List of (basic) mapcontent-features from 1(optionally more) layer(s)
                // fi. to be used for external selection
                featuresused: {
                    type: Array,
                    notify: true
                },

                // IN/OUT: bidirectional sync-property
                featureselected: {
                    type: Object,
                    notify: true,
                    observer: 'checkoutFeature'
                },

                // Auxiliary debug-prop 
                featurelog: {
                    type: String,
                    value: "",
                    notify: true
                }

            },

            behaviors: [
                Mbb.AppBehavior,
                Mbb.ContentBehavior,
                Mbb.MapBehavior
            ],                

            observers: [
                'contentFeaturesToList(contentfeatures.*)',
            ],

            ready: function() {
                // console.log("READY: mb-content-features");
            },

            attached: function() {
            },

            /**
             * Select/Hilite a feature on the map  (fi. zoomTo)
             * @param      {object}  f       { mapbox-jeature }
             */
            checkoutFeature: function(f) { 
                if (!f.feature) return;    
                
                console.log("Selected Track: " + f.id , f);
                // 
                this.featuresSelect([f.feature], f.layer);

                // Create a text-log
                var pp = f.feature.properties; console.log("pp", pp);
                var log = "["+f.id +"] in logbook: "+ f.layer; 
                // var log = JSON.parse(pp); 
                this.featurelog = log; 
            },

            /**
             * Create a linear LIST(array) of all features  
             * of the mapcontent-layer (marked with flag 'usefeatures' if more layers) 
             * and supply as notify-parameter 'featuresused'
             */
            contentFeaturesToList: function(contentfeatures, keys) {
                if (contentfeatures.path == 'contentfeatures') contentfeatures = contentfeatures.value;
                if (!contentfeatures || !Object.keys(contentfeatures).length) return;
                
                if (!keys) keys = Object.keys(contentfeatures);
                
                // Select features from layer with basefeatures only !! 

                var obj, featuresused = [];

                keys.forEach(function(lname) {
                    obj = contentfeatures[lname];
                    // add features to featuresused if layer is "marked with 'usefeatures' " 
                    // or if only one layer exists in contentfeatures  
                    if ((keys.length == 1) || obj.usefeatures) { // 
                        obj.features.forEach(function(item) {
                            featuresused.push(item);
                        })
                    } 
                });

                this.featuresused = featuresused; // NOTIFIES  !!
                // console.log("GOT contentFeaturesToList :", layernames, featuresused);
            }

        });
    </script>
</dom-module>