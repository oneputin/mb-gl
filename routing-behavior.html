<link rel="import" href="../polymer/polymer.html">

<script>
  /**
   * `Mbb.RoutingBehavior` 
   * Note, the `BehaviorRouting` event is non-bubbling.
   *
   * @polymerBehavior Mbb.RoutingBehavior
   * @demo demo/index.html
   **/

    Mbb.RoutingBehavior = {

        properties: {

            // I. Import properties
            /**
             * collection of trackRoutes (as processed by routing API) 
             */
            routedata: {
                type: Object,
                notify: true
            },

            /**
             * url to trackRoute-data
             */
            url: {
                type: String
            },

            /**
             * url to trackObj-masterdata
             */
            basedataurl: {
                type: String
            },

            /**
             * raw trackRoutes (json data)
             */
            rawdata: {
                type: Object
            },

            /**
             * raw trackObjects (as JSON)  
             */
            rawmasterdata: {
                type: Object
            },

            /**
             * collection of trackObjects-data that may be included into INFO-Popup
             * (masterdata or optionally time dependent)
             */
            masterdata: {
                type: Object
            },

            // II. Info-compilation

            /**
             *  collection of trackObj-data (id-,location-data) describing actual status
             */
            trackdata: {
                type: Object,
                value: {}
            },

            /**
             * tarckObj-data compiled for use as popup in map-api 
             */
            trackinfo: {
                type: Object,
                value: {},
                notify: true
            },


            // III. Presentation as draggable CARD-object

            /**
             * { item_description }
             */
            carddata: {
                type: Object,
                value: {}
            },

            /**
             * { item_description }
             */
            cardimgurl: {
                type: String
            },

            /**
             * { item_description }
             */
            dragctrl: {
                type: Object,
                value: {}
            },

            // Behavior of drag-element
            // flow, left, right
            dragtype: {
                type: String,
                value: "flow"
            }

        },

        observers: [
            'processTrackdata(trackdata.*)',
            'refreshCardContent(carddata)',

            '_drag(dragctrl.x, dragctrl.y, dragtype)',
            '_toggle(carddata.open)'
        ],

        'listeners': {
            "track": '_myPopupTrackHandler',
            "tap": '_onBackClick'
        },

        // A. DATA-INTERFACE 

        /**
         * LOAD raw data via ajax
         *
         * @param   {<type>} ajaxresponse : basic routedata as wp-dataset (packaged in default ajax-response)
         */
        getrawdata: function(ajaxresponse) {
            if (!ajaxresponse || !ajaxresponse.detail) return;
            // console.log("GET " + dataname, ajaxresponse.detail.response);
            // var rawdata = ajaxresponse.detail.response;
            // if (!rawdata) return;
            this.rawdata = ajaxresponse.detail.response; // triggers 'setupTracking'
        },

        // Zoom to bbox of all nodes in raw routedata (waypoints, trackpoints) 
        trackNodesZoomToX: function(routedata, routeid) {
            if (!routedata) routedata = this.routedata;

            // Collect routenode-coordinates
            var coordinates = [],
                coords_datum = [],
                neast = 0,
                nwest = 0,
                lmin, lmax, dl, bounds, center,
                startmode = false;

            // "NOT-Heuristic" zum Problem Datumsgrenze
            // a.  
            routedata.forEach(function(route, j) {
                if (route.nodes) {
                    route.nodes.forEach(function(wp, i) {
                        var lng = wp.coords[0];
                        nwest = lng < 0 ? nwest + 1 : nwest;
                        neast = lng > 0 ? neast + 1 : neast;
                        if (!lmin) {
                            lmin = lng;
                            lmax = lng;
                        }
                        lmin = lng < lmin ? lng : lmin;
                        lmax = lng > lmax ? lng : lmax;
                    })
                }
            });
            if (!lmax && !lmin) return;

            // b. 
            dl = lmax - lmin;
            // console.log("delta-lng=" + dl, "nwest=" + nwest, "neast=" + neast);
            routedata.forEach(function(route, j) {
                route.nodes.forEach(function(wp, i) {
                    var lng = wp.coords[0];
                    if (dl < 180) coordinates.push(wp.coords);
                    else if ((lng < 0) && (nwest > neast)) coordinates.push(wp.coords);
                    else if ((lng > 0) && (neast > nwest)) coordinates.push(wp.coords);
                })
            });

            // Specialcase !!
            if (startmode) { // workaround for coords around dateline
                center = coordinates[0];
            } else { // create bounds around all wp-coordinates
                // startvalue 
                bounds = new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]);
                // collect all 
                bounds = coordinates.reduce(function(bounds, coord) {
                    return bounds.extend(coord);
                }, bounds);

                center = bounds.getCenter();
            }
            // console.log("center, wp-coordinates", center, coordinates);

            if (bounds) {
                map.fitBounds(bounds, {
                    padding: 20
                });
            }
        },


        // B. DISPLAY-INTERFACE 

        /**
         * Manages the alternative approaches to create an INFO-POPUP 
         *
         * @param      {<type>}  trackdata  data related to a trackObj 
         */
        processTrackdata: function(trackdata) {
            if (!trackdata || !trackdata.value) return;
            trackdata = trackdata.value;
            // console.log("processing trackdata", trackdata);

            var trackobj = trackdata.trackobj,
                lnglat = trackdata.lnglat,
                openflag = trackdata.open;

            // if (!trackobj) return;

            if (this.calcExtendedInfo) {
                // A. 
                this.carddata = this.calcExtendedInfo(trackobj, openflag);

            } else if (this.calcBasicInfo) {
                // B. Calc a mapPopup with 
                this.trackinfo = {
                    "html": this.calcBasicInfo(trackobj),
                    "lnglat": lnglat,
                    "open": openflag
                }
            }
        },

        // C: POPUP-Handling
        /**
         * Manages interactive drag-behavior of     
         *     Combines last track(tap)-coordinates with coordinates at start  
         *     into new location of tracked element 
         * @param      {<type>}  e  { parameter_description }
         */
        _myPopupTrackHandler: function(e) {
            //e.cancelBubble = true;
            //e.stopPropagation();
            var style = window.getComputedStyle(this),
                top = parseFloat(style.getPropertyValue('top')),
                left = parseFloat(style.getPropertyValue('left')),
                dy = e.detail.y - top,
                dx = e.detail.x - left,
                x, y;

            switch (e.detail.state) {
                case 'start':
                    this.dragctrl.msg = 'Tracking started at top=';
                    this.dragctrl.dx = dx;
                    this.dragctrl.dy = dy;
                    this.unlisten(this, 'tap', '_onBackClick');
                    // console.log("start:x,y,dx,dy",left, top, dx, dy);
                    break;
                case 'track':
                    // console.log(this.dragctrl);
                    this.dragctrl.msg = "Tracking...";
                    this.set('dragctrl.x', left + dx - this.dragctrl.dx);
                    this.set('dragctrl.y', top + dy - this.dragctrl.dy);
                    break;
                case 'end':
                    this.dragctrl.msg = 'Tracking ended!';
                    this.listen(this, 'tap', '_onBackClick');
                    break;
            }
        },

        /**
         * Translate ctrl-values of dragObject into style-properties
         *
         * @param      {string}  x         { parameter_description }
         * @param      {string}  y         { parameter_description }
         * @param      {<type>}  dragtype  drag-behavior
         */
        _drag: function(x, y, dragtype) {
            //console.log("drag", x, y);
            this.style.left = x + "px";
            this.style.top = y + "px";
            if (dragtype) this.style.right = "auto";
        },
        /**
         * Toggle visibility of drag-element
         *
         * @param      {number}  open    The status to toggle into 
         */
        _toggle: function(open) {
            if (open == 0) {
                this.style.display = "none";
            } else if (open == 1) {
                this.style.display = "inline-block";
                this.style.right = "0px";
            }
        },
        /**
         * Default tap-action of close elements
         */
        _onBackClick: function() {
            this._toggle(0);
            // this.style.display = "none";
        }
    };

</script>